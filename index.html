<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#2563eb">
<meta name="description" content="LifeLedger ‚Äî modular life tracking: goals, habits, finances, journal. Local-first, expandable." />
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTGlmZUxlZGdlciIsInNob3J0X25hbWUiOiJMaWZlTGVkZ2VyIiwiZGVzY3JpcHRpb24iOiJNb2R1bGFyIGxpZmUgdHJhY2tpbmcgYXBwIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzA2MTIyMCJ9">
<title>LifeLedger ‚Äî Personal Life Ledger</title>
<style>
  :root {
    --bg: #f6f7fb;
    --panel: #ffffff;
    --muted: #6b7280;
    --accent: #2563eb;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    --glass: rgba(255, 255, 255, 0.6);
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 6px 18px rgba(16, 24, 40, 0.08);
    --shadow-lg: 0 12px 32px rgba(16, 24, 40, 0.12);
    --transition: all 0.2s ease;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color-scheme: light;
  }

  [data-theme="dark"] {
    --bg: #0b1220;
    --panel: #071022;
    --muted: #9aa4b2;
    --accent: #60a5fa;
    --success: #34d399;
    --warning: #fbbf24;
    --danger: #fb7185;
    --info: #93c5fd;
    --glass: rgba(255, 255, 255, 0.03);
    --shadow: 0 6px 22px rgba(2, 6, 23, 0.6);
    --shadow-lg: 0 12px 32px rgba(2, 6, 23, 0.8);
    color-scheme: dark;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    font-size: 15px;
    line-height: 1.5;
    transition: var(--transition);
  }

  body {
    overflow-x: hidden;
  }

  .app {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 20px;
    min-height: 100vh;
    padding: 20px;
    box-sizing: border-box;
    max-width: 1600px;
    margin: 0 auto;
  }

  @media (max-width: 1024px) {
    .app {
      grid-template-columns: 1fr;
      padding: 16px;
    }
    .sidebar {
      order: 2;
    }
    .main {
      order: 1;
    }
  }

  @media (max-width: 640px) {
    .app {
      padding: 12px;
    }
  }

  /* Loading overlay */
  .loading {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transition: opacity 0.3s ease;
pointer-events: all;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--glass);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Sidebar */
  .sidebar {
    background: linear-gradient(180deg, var(--panel), rgba(255, 255, 255, 0.02));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .brand {
    border-bottom-color: rgba(255, 255, 255, 0.05);
  }

  .logo {
    width: 48px;
    height: 48px;
    border-radius: var(--radius);
    display: grid;
    place-items: center;
    background: linear-gradient(135deg, var(--accent), #7c3aed);
    color: white;
    font-weight: 700;
    font-size: 20px;
    box-shadow: 0 6px 18px rgba(99, 102, 241, 0.18);
  }

  .brand h1 {
    margin: 0;
    font-size: 18px;
    letter-spacing: -0.3px;
    background: linear-gradient(90deg, var(--accent), #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .brand p {
    margin: 2px 0 0;
    font-size: 12px;
    color: var(--muted);
  }

  .modules {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 4px;
    overflow-y: auto;
    max-height: 50vh;
    padding-right: 4px;
  }

  .modules::-webkit-scrollbar {
    width: 4px;
  }

  .modules::-webkit-scrollbar-track {
    background: transparent;
  }

  .modules::-webkit-scrollbar-thumb {
    background: var(--muted);
    border-radius: 2px;
    opacity: 0.3;
  }

  .module-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 10px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    user-select: none;
    transition: var(--transition);
    border: 1px solid transparent;
  }

  .module-item:hover {
    background: var(--glass);
    transform: translateX(2px);
  }

  .module-item.active {
    background: linear-gradient(90deg, rgba(37, 99, 235, 0.1), rgba(124, 58, 237, 0.05));
    border-color: rgba(37, 99, 235, 0.2);
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
  }

  .module-title {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .module-title .icon {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-sm);
    display: grid;
    place-items: center;
    font-weight: 600;
    background: rgba(0, 0, 0, 0.04);
    color: var(--accent);
    font-size: 14px;
  }

  [data-theme="dark"] .module-title .icon {
    background: rgba(255, 255, 255, 0.05);
  }

  .module-meta {
    font-size: 12px;
    color: var(--muted);
  }

  .module-badge {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 10px;
    background: var(--accent);
    color: white;
  }

  .sidebar .controls {
    margin-top: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding-top: 12px;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .sidebar .controls {
    border-top-color: rgba(255, 255, 255, 0.05);
  }

  button, .file-btn {
    border: 0;
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    background: transparent;
    color: var(--muted);
    font-size: 14px;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: inherit;
  }

  button:hover, .file-btn:hover {
    background: var(--glass);
    color: var(--accent);
  }

  .btn-primary {
    background: linear-gradient(90deg, var(--accent), #7c3aed);
    color: white;
    box-shadow: 0 8px 18px rgba(37, 99, 235, 0.15);
    font-weight: 500;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 12px 24px rgba(37, 99, 235, 0.2);
    color: white;
  }

  .btn-success {
    background: linear-gradient(90deg, var(--success), #059669);
    color: white;
  }

  .btn-warning {
    background: linear-gradient(90deg, var(--warning), #d97706);
    color: white;
  }

  .btn-danger {
    background: linear-gradient(90deg, var(--danger), #dc2626);
    color: white;
  }

  .small {
    padding: 6px 10px;
    font-size: 13px;
  }

  /* Main content */
  .main {
    display: flex;
    flex-direction: column;
    gap: 16px;
    overflow: hidden;
  }

  .card {
    background: var(--panel);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: var(--transition);
  }

  .card:hover {
    box-shadow: var(--shadow-lg);
  }

  header.appbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    padding: 16px 20px;
  }

  .search {
    display: flex;
    gap: 10px;
    align-items: center;
    background: var(--glass);
    padding: 10px 16px;
    border-radius: var(--radius);
    width: 100%;
    max-width: 600px;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .search {
    border-color: rgba(255, 255, 255, 0.05);
  }

  input[type="search"] {
    border: 0;
    background: transparent;
    outline: none;
    width: 100%;
    color: inherit;
    font-size: 15px;
  }

  input[type="search"]::placeholder {
    color: var(--muted);
  }

  .toolbar {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  /* Module area */
  #module-area {
    min-height: 400px;
    display: block;
    overflow: visible;
  }

  .module-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .module-header {
    border-bottom-color: rgba(255, 255, 255, 0.05);
  }

  /* Lists */
  .list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .list-item {
    padding: 16px;
    border-radius: var(--radius-sm);
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), transparent);
    border: 1px solid rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: space-between;
    gap: 16px;
    align-items: center;
    transition: var(--transition);
  }

  [data-theme="dark"] .list-item {
    border-color: rgba(255, 255, 255, 0.05);
  }

  .list-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }

  .progress {
    height: 8px;
    background: rgba(0, 0, 0, 0.06);
    border-radius: 999px;
    overflow: hidden;
    width: 200px;
  }

  [data-theme="dark"] .progress {
    background: rgba(255, 255, 255, 0.06);
  }

  .progress > i {
    display: block;
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #7c3aed);
    border-radius: 999px;
    transition: width 0.3s ease;
  }

  .progress-success > i {
    background: linear-gradient(90deg, var(--success), #059669);
  }

  .progress-warning > i {
    background: linear-gradient(90deg, var(--warning), #d97706);
  }

  .progress-danger > i {
    background: linear-gradient(90deg, var(--danger), #dc2626);
  }

  /* Forms */
  label {
    font-size: 13px;
    color: var(--muted);
    font-weight: 500;
    margin-bottom: 6px;
    display: block;
  }

  input[type="text"],
  input[type="number"],
  input[type="date"],
  input[type="email"],
  input[type="tel"],
  textarea,
  select,
  .small-input {
    width: 100%;
    padding: 12px;
    border-radius: var(--radius-sm);
    border: 1px solid rgba(0, 0, 0, 0.1);
    background: var(--panel);
    color: inherit;
    box-sizing: border-box;
    font-size: 14px;
    transition: var(--transition);
  }

  [data-theme="dark"] input,
  [data-theme="dark"] textarea,
  [data-theme="dark"] select {
    border-color: rgba(255, 255, 255, 0.1);
  }

  input:focus,
  textarea:focus,
  select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  textarea {
    resize: vertical;
    min-height: 100px;
    line-height: 1.5;
  }

  .row {
    display: flex;
    gap: 16px;
  }

  @media (max-width: 640px) {
    .row {
      flex-direction: column;
    }
  }

  /* Grid system */
  .grid {
    display: grid;
    gap: 16px;
  }

  .grid-2 {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }

  .grid-3 {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }

  .grid-4 {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  /* Dashboard */
  .dashboard {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }

  .stat-card {
    padding: 20px;
    border-radius: var(--radius);
    background: linear-gradient(135deg, var(--panel), rgba(255, 255, 255, 0.02));
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .stat-value {
    font-size: 32px;
    font-weight: 700;
    background: linear-gradient(90deg, var(--accent), #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .stat-label {
    font-size: 14px;
    color: var(--muted);
    margin-top: 4px;
  }

  /* Charts */
  .chart-container {
    height: 200px;
    position: relative;
    margin: 20px 0;
  }

  .chart-bar {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    height: 100%;
    padding: 10px;
  }

  .chart-bar-item {
    flex: 1;
    background: linear-gradient(to top, var(--accent), #7c3aed);
    border-radius: 4px 4px 0 0;
    min-height: 10px;
    position: relative;
  }

  /* Tags and chips */
  .chip {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    background: rgba(0, 0, 0, 0.04);
    color: var(--muted);
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-weight: 500;
  }

  [data-theme="dark"] .chip {
    background: rgba(255, 255, 255, 0.05);
  }

  .chip-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
  }

  .chip-warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
  }

  .chip-danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
  }

  .chip-info {
    background: rgba(59, 130, 246, 0.1);
    color: var(--info);
  }

  .tag {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    background: rgba(0, 0, 0, 0.04);
    color: var(--muted);
  }

  [data-theme="dark"] .tag {
    background: rgba(255, 255, 255, 0.05);
  }

  /* Utility classes */
  .muted {
    color: var(--muted);
    font-size: 14px;
  }

  .right {
    margin-left: auto;
  }

  .danger {
    color: var(--danger);
  }

  .success {
    color: var(--success);
  }

  .warning {
    color: var(--warning);
  }

  .hidden {
    display: none !important;
  }

  .fade-in {
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .slide-in {
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { transform: translateX(-20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
  }

  .modal {
    background: var(--panel);
    border-radius: var(--radius);
    padding: 24px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--muted);
  }

  /* Toast notifications */
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1001;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .toast {
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    background: var(--panel);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease;
    border-left: 4px solid var(--accent);
  }

  .toast-success {
    border-left-color: var(--success);
  }

  .toast-warning {
    border-left-color: var(--warning);
  }

  .toast-danger {
    border-left-color: var(--danger);
  }

  /* Footer */
  footer {
    text-align: center;
    padding: 20px;
    color: var(--muted);
    font-size: 13px;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] footer {
    border-top-color: rgba(255, 255, 255, 0.05);
  }

  /* Empty states */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.3;
  }

  /* Tooltips */
  [data-tooltip] {
    position: relative;
  }

  [data-tooltip]:before {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 6px 10px;
    background: var(--panel);
    color: var(--muted);
    font-size: 12px;
    border-radius: var(--radius-sm);
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    box-shadow: var(--shadow);
    z-index: 1000;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  [data-tooltip]:hover:before {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(-4px);
  }
</style>
</head>
<body>
<div class="loading" id="loading">
  <div class="spinner"></div>
</div>

<div class="app" id="app">
  <aside class="sidebar card" id="sidebar">
    <div class="brand">
      <div class="logo" aria-hidden>LL</div>
      <div>
        <h1>LifeLedger</h1>
        <p>Your modular life dashboard</p>
      </div>
    </div>

    <div>
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="muted" style="font-weight:500">Modules</div>
        <div style="display:flex;gap:6px">
          <button id="addModuleBtn" class="small" data-tooltip="Add custom module">+ Module</button>
          <button id="settingsBtn" class="small" data-tooltip="Settings">‚öôÔ∏è</button>
        </div>
      </div>
      <div class="modules" id="modulesList" role="tablist" aria-label="Modules">
        <!-- modules injected here -->
      </div>
    </div>

    <div class="controls">
      <button id="exportBtn" class="button file-btn small" data-tooltip="Export all data">
        <span>üì§</span> Export
      </button>
      <label class="file-btn small" data-tooltip="Import from file">
        <span>üì•</span> Import
        <input id="importFile" type="file" accept="application/json,.csv" style="display:none">
      </label>
      <button id="themeToggle" class="small" data-tooltip="Toggle theme">
        <span id="themeIcon">üåì</span> Theme
      </button>
      <button id="backupBtn" class="small btn-success" data-tooltip="Create backup">
        <span>üíæ</span> Backup
      </button>
    </div>
    
    <div style="margin-top:auto; padding-top:12px; border-top: 1px solid rgba(0,0,0,0.05);">
      <div class="muted" style="font-size:11px; margin-bottom:8px;">
        <span id="storageUsage">Storage: Calculating...</span>
      </div>
      <div style="font-size:11px;color:var(--muted)">
        <span id="lastSaved">Ready</span>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="card appbar" role="banner">
      <div style="display:flex;gap:12px;align-items:center;width:100%">
        <div class="search" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:0.7">
            <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="11.5" cy="11.5" r="5.5" stroke="currentColor" stroke-width="1.5"/>
          </svg>
          <input id="globalSearch" type="search" placeholder="Search across all modules (Press / to focus)" />
        </div>
        <div class="toolbar right">
          <div class="chip" id="todayChip" data-tooltip="Click for today's summary">
            <span id="todayDate"></span>
            <span id="todayWeekday"></span>
          </div>
          <button id="quickAdd" class="btn-primary small" data-tooltip="Quick add (Ctrl+Q)">
            <span>‚ö°</span> Quick Add
          </button>
          <button id="dashboardBtn" class="small" data-tooltip="Dashboard">
            <span>üìä</span> Dashboard
          </button>
        </div>
      </div>
    </div>

    <section id="module-area" class="card fade-in">
      <!-- Dynamic module content loads here -->
      <div id="welcome-view" class="fade-in">
        <div class="module-header">
          <div>
            <h2 style="margin:0">Welcome to LifeLedger</h2>
            <p class="muted" style="margin-top:4px">Your personal life operating system</p>
          </div>
          <button id="getStartedBtn" class="btn-primary">Get Started Guide</button>
        </div>

        <div class="dashboard" id="dashboardPreview">
          <div class="stat-card">
            <div class="stat-value" id="totalGoals">0</div>
            <div class="stat-label">Active Goals</div>
            <div class="progress" style="margin-top:12px; width:100%">
              <i id="goalsProgress" style="width:0%"></i>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-value" id="totalHabits">0</div>
            <div class="stat-label">Daily Habits</div>
            <div class="muted" style="margin-top:8px; font-size:12px">
              <span id="activeStreak">0</span> day streak
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-value" id="totalBalance">$0</div>
            <div class="stat-label">Current Balance</div>
            <div class="muted" style="margin-top:8px; font-size:12px">
              <span id="monthlySpent">$0</span> this month
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-value" id="productivityScore">0%</div>
            <div class="stat-label">Productivity</div>
            <div class="muted" style="margin-top:8px; font-size:12px">
              Based on completed tasks
            </div>
          </div>
        </div>

        <div style="margin-top:32px">
          <h3 style="margin-bottom:16px">Quick Start</h3>
          <div class="grid grid-3">
            <div class="card" style="cursor:pointer" onclick="openModule('goals')">
              <h4 style="margin:0 0 8px 0">üéØ Set Goals</h4>
              <p class="muted" style="font-size:14px">Define and track your objectives with progress monitoring</p>
            </div>
            <div class="card" style="cursor:pointer" onclick="openModule('habits')">
              <h4 style="margin:0 0 8px 0">üîÑ Build Habits</h4>
              <p class="muted" style="font-size:14px">Track daily routines and build streaks</p>
            </div>
            <div class="card" style="cursor:pointer" onclick="openModule('tasks')">
              <h4 style="margin:0 0 8px 0">‚úÖ Manage Tasks</h4>
              <p class="muted" style="font-size:14px">Organize todos with priorities and due dates</p>
            </div>
          </div>
        </div>

        <div style="margin-top:32px">
          <div class="module-header">
            <h3 style="margin:0">Recent Activity</h3>
            <button class="small" onclick="showAllActivity()">View All</button>
          </div>
          <div id="recentActivity" class="list">
            <div class="empty-state">
              <div class="empty-state-icon">üìä</div>
              <p>No activity yet</p>
              <p class="muted" style="margin-top:8px">Start using modules to see activity here</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="muted">
      LifeLedger v2.0 ‚Ä¢ Local-first ‚Ä¢ <span id="appStatus">Ready</span> ‚Ä¢ 
      <button onclick="window.LifeLedger.showShortcuts()" class="small" style="margin-left:8px">Keyboard Shortcuts</button>
    </footer>
  </main>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
/*
  LifeLedger Enhanced v2.0
  - Complete modular life tracking system
  - Professional UI with dark/light themes
  - 8 built-in modules + extensible architecture
  - Advanced features: analytics, search, export
  - PWA-ready, offline capable
*/

// ==================== CONFIGURATION ====================
const CONFIG = {
  APP_NAME: 'LifeLedger',
  VERSION: '2.0.0',
  STORAGE_KEY: 'lifeledger_data_v2',
  BACKUP_KEY: 'lifeledger_backups',
  SETTINGS_KEY: 'lifeledger_settings',
  MAX_BACKUPS: 10,
  AUTO_SAVE_DELAY: 2000,
  ENCRYPTION_KEY: null, // Set via settings for encrypted storage
};

// ==================== UTILITIES ====================
const Utils = {
  // Generate unique IDs
  generateId: () => Date.now().toString(36) + Math.random().toString(36).substring(2),
  
  // Format dates
  formatDate: (date = new Date(), format = 'medium') => {
    const d = new Date(date);
    const formats = {
      short: d.toLocaleDateString(),
      medium: d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' }),
      long: d.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
      time: d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
      datetime: d.toLocaleString(),
    };
    return formats[format] || d.toLocaleDateString();
  },
  
  // Format currency
  formatCurrency: (amount, currency = 'USD') => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency,
      minimumFractionDigits: 2,
    }).format(amount);
  },
  
  // Calculate percentage
  percentage: (value, total) => total > 0 ? Math.round((value / total) * 100) : 0,
  
  // Debounce function
  debounce: (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  },
  
  // Escape HTML
  escapeHtml: (text) => {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  },
  
  // Deep clone object
  deepClone: (obj) => JSON.parse(JSON.stringify(obj)),
  
  // Generate color from string
  stringToColor: (str) => {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const hue = hash % 360;
    return `hsl(${hue}, 70%, 60%)`;
  },
  
  // Calculate streak
  calculateStreak: (dates) => {
    if (!dates || dates.length === 0) return 0;
    const sorted = [...dates].sort((a, b) => new Date(b) - new Date(a));
    let streak = 1;
    let current = new Date(sorted[0]);
    current.setHours(0, 0, 0, 0);
    
    for (let i = 1; i < sorted.length; i++) {
      const next = new Date(sorted[i]);
      next.setHours(0, 0, 0, 0);
      const diff = Math.floor((current - next) / (1000 * 60 * 60 * 24));
      if (diff === 1) {
        streak++;
        current = next;
      } else if (diff > 1) {
        break;
      }
    }
    return streak;
  },
};

// ==================== STORAGE MANAGER ====================
const Storage = {
  // Load application state
  loadState: () => {
    try {
      const raw = localStorage.getItem(CONFIG.STORAGE_KEY);
      if (!raw) return { modules: {}, enabledOrder: [], settings: {}, version: CONFIG.VERSION };
      const data = JSON.parse(raw);
      
      // Migration from v1 to v2
      if (!data.version || data.version < '2.0.0') {
        return Storage.migrateV1toV2(data);
      }
      
      return data;
    } catch (error) {
      console.error('Failed to load state:', error);
      return { modules: {}, enabledOrder: [], settings: {}, version: CONFIG.VERSION };
    }
  },
  
  // Save application state
  saveState: (state) => {
    try {
      if (!state) {
        console.error('Attempted to save null state');
        return false;
      }
      
      state.lastSaved = Date.now();
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state));
      
      // Update UI
      const lastSavedEl = document.getElementById('lastSaved');
      if (lastSavedEl) {
        lastSavedEl.textContent = `Saved ${Utils.formatDate(new Date(), 'time')}`;
      }
      
      // Update storage usage
      Storage.updateStorageUsage();
      
      return true;
    } catch (error) {
      console.error('Failed to save state:', error);
      return false;
    }
  },
  
  // Create backup
  createBackup: (label = 'Manual backup') => {
    try {
      const state = Storage.loadState();
      const backup = {
        id: Utils.generateId(),
        label,
        timestamp: Date.now(),
        data: state,
        version: CONFIG.VERSION,
      };
      
      const backups = Storage.getBackups();
      backups.unshift(backup);
      
      // Keep only MAX_BACKUPS
      if (backups.length > CONFIG.MAX_BACKUPS) {
        backups.splice(CONFIG.MAX_BACKUPS);
      }
      
      localStorage.setItem(CONFIG.BACKUP_KEY, JSON.stringify(backups));
      return backup.id;
    } catch (error) {
      console.error('Failed to create backup:', error);
      return null;
    }
  },
  
  // Get all backups
  getBackups: () => {
    try {
      const raw = localStorage.getItem(CONFIG.BACKUP_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (error) {
      return [];
    }
  },
  
  // Restore from backup
  restoreBackup: (backupId) => {
    try {
      const backups = Storage.getBackups();
      const backup = backups.find(b => b.id === backupId);
      if (!backup) throw new Error('Backup not found');
      
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(backup.data));
      return true;
    } catch (error) {
      console.error('Failed to restore backup:', error);
      return false;
    }
  },
  
  // Update storage usage display
  updateStorageUsage: () => {
    try {
      let total = 0;
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key) {
          total += (localStorage.getItem(key)?.length || 0) * 2; // Approximate bytes
        }
      }
      
      const usageEl = document.getElementById('storageUsage');
      if (usageEl) {
        const kb = (total / 1024).toFixed(2);
        usageEl.textContent = `Storage: ${kb} KB`;
      }
    } catch (error) {
      console.error('Failed to calculate storage usage:', error);
    }
  },
  
  // Export data
  exportData: (format = 'json') => {
    const state = Storage.loadState();
    const exportData = {
      ...state,
      exportDate: new Date().toISOString(),
      exportVersion: CONFIG.VERSION,
    };
    
    switch (format) {
      case 'json':
        return JSON.stringify(exportData, null, 2);
      case 'csv':
        return Storage.convertToCSV(exportData);
      default:
        return JSON.stringify(exportData, null, 2);
    }
  },
  
  // Import data
  importData: (data, format = 'json') => {
    try {
      let imported;
      switch (format) {
        case 'json':
          imported = JSON.parse(data);
          break;
        case 'csv':
          imported = Storage.parseCSV(data);
          break;
        default:
          throw new Error('Unsupported format');
      }
      
      // Validate imported data
      if (!imported || typeof imported !== 'object') {
        throw new Error('Invalid data format');
      }
      
      // Merge with existing data
      const current = Storage.loadState();
      const merged = {
        ...current,
        modules: { ...current.modules, ...imported.modules },
        enabledOrder: [...new Set([...current.enabledOrder, ...(imported.enabledOrder || [])])],
        settings: { ...current.settings, ...imported.settings },
        version: CONFIG.VERSION,
      };
      
      Storage.saveState(merged);
      return true;
    } catch (error) {
      console.error('Failed to import data:', error);
      throw error;
    }
  },
  
  // Migration from v1 to v2
  migrateV1toV2: (oldData) => {
    console.log('Migrating from v1 to v2...');
    const newData = {
      modules: {},
      enabledOrder: oldData.enabledOrder || [],
      settings: oldData.settings || {},
      version: CONFIG.VERSION,
    };
    
    // Migrate each module
    Object.keys(oldData.modules || {}).forEach(moduleId => {
      newData.modules[moduleId] = {
        data: oldData.modules[moduleId].data || {},
        meta: {
          created: Date.now(),
          updated: Date.now(),
          version: '2.0.0',
        },
      };
    });
    
    return newData;
  },
  
  // Convert to CSV (basic implementation)
  convertToCSV: (data) => {
    const rows = [];
    rows.push('Module,Item Count,Last Updated');
    
    Object.keys(data.modules || {}).forEach(moduleId => {
      const module = data.modules[moduleId];
      const itemCount = Object.keys(module.data || {}).reduce((count, key) => {
        if (Array.isArray(module.data[key])) return count + module.data[key].length;
        return count + 1;
      }, 0);
      
      rows.push(`${moduleId},${itemCount},${new Date().toISOString()}`);
    });
    
    return rows.join('\n');
  },
  
  parseCSV: (csv) => {
    const lines = csv.split('\n');
    const result = { modules: {}, enabledOrder: [], settings: {} };
    
    lines.forEach((line, index) => {
      if (index === 0) return; // Skip header
      const [moduleId, count] = line.split(',');
      if (moduleId && !result.enabledOrder.includes(moduleId)) {
        result.enabledOrder.push(moduleId);
        result.modules[moduleId] = { data: {}, meta: {} };
      }
    });
    
    return result;
  },
};

// ==================== UI MANAGER ====================
const UIManager = {
  // Initialize UI
  init: () => {
    // Set today's date
    const today = new Date();
    const todayDateEl = document.getElementById('todayDate');
    const todayWeekdayEl = document.getElementById('todayWeekday');
    
    if (todayDateEl) {
      todayDateEl.textContent = Utils.formatDate(today, 'medium');
    }
    if (todayWeekdayEl) {
      todayWeekdayEl.textContent = today.toLocaleDateString(undefined, { weekday: 'long' });
    }
    
    // Initialize theme
    UIManager.initTheme();
    
    // Initialize keyboard shortcuts
    UIManager.initKeyboardShortcuts();
    
    // Initialize event listeners
    UIManager.initEventListeners();
    
    // Update storage usage
    Storage.updateStorageUsage();
    
    // Show welcome if no modules
    setTimeout(() => {
      const loadingEl = document.getElementById('loading');
      if (loadingEl) {
        loadingEl.style.opacity = '0';
        setTimeout(() => {
          loadingEl.style.display = 'none';
        }, 300);
      }
    }, 500);
  },
  
  // Initialize theme
  initTheme: () => {
    const savedTheme = localStorage.getItem('lifeledger_theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const themeIcon = document.getElementById('themeIcon');
    
    if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
      document.documentElement.setAttribute('data-theme', 'dark');
      if (themeIcon) {
        themeIcon.textContent = 'üåô';
      }
    } else {
      document.documentElement.setAttribute('data-theme', 'light');
      if (themeIcon) {
        themeIcon.textContent = '‚òÄÔ∏è';
      }
    }
  },
  
  // Toggle theme
  toggleTheme: () => {
    const current = document.documentElement.getAttribute('data-theme');
    const newTheme = current === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('lifeledger_theme', newTheme);
    
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
      themeIcon.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }
    UIManager.showToast(`Switched to ${newTheme} theme`, 'success');
  },
  
  // Initialize keyboard shortcuts
  initKeyboardShortcuts: () => {
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + K for search
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) searchInput.focus();
      }
      
      // Ctrl/Cmd + Q for quick add
      if ((e.ctrlKey || e.metaKey) && e.key === 'q') {
        e.preventDefault();
        const quickAddBtn = document.getElementById('quickAdd');
        if (quickAddBtn) quickAddBtn.click();
      }
      
      // / for search (when not in input)
      if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(document.activeElement?.tagName || '')) {
        e.preventDefault();
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) searchInput.focus();
      }
      
      // Escape to clear search
      if (e.key === 'Escape') {
        const search = document.getElementById('globalSearch');
        if (search && document.activeElement === search && search.value) {
          search.value = '';
          search.blur();
        }
      }
    });
  },
  
  // Initialize event listeners
  initEventListeners: () => {
    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', UIManager.toggleTheme);
    }
    
    // Backup button
    const backupBtn = document.getElementById('backupBtn');
    if (backupBtn) {
      backupBtn.addEventListener('click', () => {
        const backupId = Storage.createBackup('Manual backup');
        if (backupId) {
          UIManager.showToast('Backup created successfully', 'success');
        } else {
          UIManager.showToast('Failed to create backup', 'danger');
        }
      });
    }
    
    // Export button
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
      exportBtn.addEventListener('click', () => {
        UIManager.showExportModal();
      });
    }
    
    // Import button
    const importFile = document.getElementById('importFile');
    if (importFile) {
      importFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            if (confirm('Import will merge with your current data. Continue?')) {
              Storage.importData(event.target.result, file.name.endsWith('.csv') ? 'csv' : 'json');
              UIManager.showToast('Data imported successfully', 'success');
              setTimeout(() => location.reload(), 1000);
            }
          } catch (error) {
            UIManager.showToast(`Import failed: ${error.message}`, 'danger');
          }
          e.target.value = ''; // Reset file input
        };
        reader.readAsText(file);
      });
    }
    
    // Quick add
    const quickAddBtn = document.getElementById('quickAdd');
    if (quickAddBtn) {
      quickAddBtn.addEventListener('click', UIManager.showQuickAddModal);
    }
    
    // Dashboard button
    const dashboardBtn = document.getElementById('dashboardBtn');
    if (dashboardBtn) {
      dashboardBtn.addEventListener('click', () => {
        ModuleSystem.openModule('dashboard');
      });
    }
    
    // Get started guide
    const getStartedBtn = document.getElementById('getStartedBtn');
    if (getStartedBtn) {
      getStartedBtn.addEventListener('click', () => {
        UIManager.showGuideModal();
      });
    }
    
    // Global search
    const globalSearch = document.getElementById('globalSearch');
    if (globalSearch) {
      globalSearch.addEventListener('input', Utils.debounce((e) => {
        const query = e.target.value.trim();
        if (query.length >= 2) {
          ModuleSystem.performGlobalSearch(query);
        }
      }, 300));
    }
    
    // Today chip
    const todayChip = document.getElementById('todayChip');
    if (todayChip) {
      todayChip.addEventListener('click', () => {
        UIManager.showTodaySummary();
      });
    }
    
    // Settings button
    const settingsBtn = document.getElementById('settingsBtn');
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        UIManager.showSettingsModal();
      });
    }
    
    // Add module button
    const addModuleBtn = document.getElementById('addModuleBtn');
    if (addModuleBtn) {
      addModuleBtn.addEventListener('click', () => {
        UIManager.showAddModuleModal();
      });
    }
  },
  
  // Show toast notification
  showToast: (message, type = 'info', duration = 3000) => {
    const container = document.getElementById('toastContainer');
    if (!container) {
      // Create toast container if it doesn't exist
      const newContainer = document.createElement('div');
      newContainer.id = 'toastContainer';
      newContainer.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 8px;
      `;
      document.body.appendChild(newContainer);
      container = newContainer;
    }
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
      background: ${type === 'success' ? '#4CAF50' : type === 'danger' ? '#f44336' : '#2196F3'};
      color: white;
      padding: 12px 16px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      opacity: 1;
      transform: translateX(0);
    `;
    
    toast.innerHTML = `
      <span>${type === 'success' ? '‚úÖ' : type === 'danger' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
      <span>${Utils.escapeHtml(message)}</span>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100%)';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  },
  
  // Show modal
  showModal: (title, content, buttons = []) => {
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    modalOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    `;
    
    modalOverlay.innerHTML = `
      <div class="modal" style="
        background: white;
        border-radius: 8px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        animation: slideUp 0.3s ease;
      ">
        <div class="modal-header" style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
        ">
          <h3 style="margin:0">${Utils.escapeHtml(title)}</h3>
          <button class="modal-close" style="
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
          ">&times;</button>
        </div>
        <div class="modal-content">${content}</div>
        ${buttons.length ? `<div class="modal-actions" style="margin-top:20px;display:flex;gap:8px;justify-content:flex-end">${buttons.join('')}</div>` : ''}
      </div>
    `;
    
    document.body.appendChild(modalOverlay);
    
    // Close on overlay click
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay || e.target.classList.contains('modal-close')) {
        modalOverlay.remove();
      }
    });
    
    // Add keydown listener for Escape
    const escapeHandler = (e) => {
      if (e.key === 'Escape') {
        modalOverlay.remove();
        document.removeEventListener('keydown', escapeHandler);
      }
    };
    document.addEventListener('keydown', escapeHandler);
    
    // Remove listener when modal is removed
    const observer = new MutationObserver(() => {
      if (!document.body.contains(modalOverlay)) {
        document.removeEventListener('keydown', escapeHandler);
        observer.disconnect();
      }
    });
    observer.observe(document.body, { childList: true });
    
    return modalOverlay;
  },
  
  // Show export modal
  showExportModal: () => {
    const content = `
      <div style="display:flex;flex-direction:column;gap:12px">
        <p>Export your LifeLedger data for backup or transfer.</p>
        <div>
          <label><input type="radio" name="exportFormat" value="json" checked> JSON (Recommended)</label>
        </div>
        <div>
          <label><input type="radio" name="exportFormat" value="csv"> CSV (Basic)</label>
        </div>
        <div>
          <label><input type="checkbox" id="includeBackups" checked> Include backups</label>
        </div>
      </div>
    `;
    
    const buttons = [
      '<button class="btn-primary" id="exportConfirm" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Export Now</button>',
      '<button class="small" id="exportCancel" style="padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">Cancel</button>',
    ];
    
    const modal = UIManager.showModal('Export Data', content, buttons);
    
    modal.querySelector('#exportConfirm').addEventListener('click', () => {
      const format = modal.querySelector('input[name="exportFormat"]:checked').value;
      const includeBackups = modal.querySelector('#includeBackups').checked;
      
      let exportData = Storage.exportData(format);
      
      if (includeBackups && format === 'json') {
        try {
          const data = JSON.parse(exportData);
          data.backups = Storage.getBackups();
          exportData = JSON.stringify(data, null, 2);
        } catch (e) {
          console.error('Failed to include backups:', e);
        }
      }
      
      const blob = new Blob([exportData], { type: format === 'json' ? 'application/json' : 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `lifeledger-export-${new Date().toISOString().split('T')[0]}.${format}`;
      a.click();
      URL.revokeObjectURL(url);
      
      modal.remove();
      UIManager.showToast('Export completed', 'success');
    });
    
    modal.querySelector('#exportCancel').addEventListener('click', () => modal.remove());
  },
  
  // Show quick add modal
  showQuickAddModal: () => {
    const content = `
      <div style="display:flex;flex-direction:column;gap:12px">
        <div>
          <label>Type</label>
          <select id="quickAddType" style="width:100%">
            <option value="goal">üéØ Goal</option>
            <option value="habit">üîÑ Habit</option>
            <option value="task">‚úÖ Task</option>
            <option value="transaction">üí∞ Transaction</option>
            <option value="note">üìù Note</option>
            <option value="journal">üìì Journal Entry</option>
          </select>
        </div>
        <div>
          <label>Title/Description</label>
          <input id="quickAddTitle" type="text" placeholder="Enter description..." style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
        </div>
        <div id="quickAddExtra"></div>
      </div>
    `;
    
    const buttons = [
      '<button class="btn-primary" id="quickAddSave" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button>',
      '<button class="small" id="quickAddCancel" style="padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">Cancel</button>',
    ];
    
    const modal = UIManager.showModal('Quick Add', content, buttons);
    
    const typeSelect = modal.querySelector('#quickAddType');
    const extraDiv = modal.querySelector('#quickAddExtra');
    
    const updateExtraFields = () => {
      const type = typeSelect.value;
      let extraHTML = '';
      
      switch (type) {
        case 'goal':
          extraHTML = `
            <div>
              <label>Target Progress (0-100%)</label>
              <input id="quickAddProgress" type="number" min="0" max="100" value="0" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
            </div>
          `;
          break;
        case 'habit':
          extraHTML = `
            <div>
              <label>Category</label>
              <select id="quickAddCategory" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
                <option value="health">Health</option>
                <option value="productivity">Productivity</option>
                <option value="learning">Learning</option>
                <option value="other">Other</option>
              </select>
            </div>
          `;
          break;
        case 'task':
          extraHTML = `
            <div>
              <label>Priority</label>
              <select id="quickAddPriority" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          `;
          break;
        case 'transaction':
          extraHTML = `
            <div>
              <label>Amount ($)</label>
              <input id="quickAddAmount" type="number" step="0.01" placeholder="0.00" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
            </div>
            <div>
              <label>Type</label>
              <select id="quickAddTxType" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
                <option value="income">Income</option>
                <option value="expense" selected>Expense</option>
              </select>
            </div>
          `;
          break;
      }
      
      extraDiv.innerHTML = extraHTML;
    };
    
    typeSelect.addEventListener('change', updateExtraFields);
    updateExtraFields();
    
    modal.querySelector('#quickAddSave').addEventListener('click', () => {
      const type = typeSelect.value;
      const titleInput = modal.querySelector('#quickAddTitle');
      const title = titleInput ? titleInput.value.trim() : '';
      
      if (!title) {
        UIManager.showToast('Please enter a title', 'warning');
        return;
      }
      
      const state = Storage.loadState();
      if (!state.modules) state.modules = {};
      
      switch (type) {
        case 'goal':
          if (!state.modules.goals) state.modules.goals = { data: { list: [] }, meta: {} };
          state.modules.goals.data.list.push({
            id: Utils.generateId(),
            title,
            progress: parseInt(modal.querySelector('#quickAddProgress')?.value || 0) / 100,
            target: 1,
            category: 'quick',
            created: Date.now(),
          });
          break;
          
        case 'habit':
          if (!state.modules.habits) state.modules.habits = { data: { list: [] }, meta: {} };
          state.modules.habits.data.list.push({
            id: Utils.generateId(),
            title,
            category: modal.querySelector('#quickAddCategory')?.value || 'other',
            streak: 0,
            frequency: 'daily',
            created: Date.now(),
          });
          break;
          
        case 'task':
          if (!state.modules.tasks) state.modules.tasks = { data: { list: [] }, meta: {} };
          state.modules.tasks.data.list.push({
            id: Utils.generateId(),
            title,
            priority: modal.querySelector('#quickAddPriority')?.value || 'medium',
            completed: false,
            dueDate: null,
            created: Date.now(),
          });
          break;
          
        case 'transaction':
          if (!state.modules.finances) state.modules.finances = { data: { transactions: [] }, meta: {} };
          const amount = parseFloat(modal.querySelector('#quickAddAmount')?.value || 0);
          const txType = modal.querySelector('#quickAddTxType')?.value || 'expense';
          state.modules.finances.data.transactions.push({
            id: Utils.generateId(),
            description: title,
            amount: txType === 'income' ? Math.abs(amount) : -Math.abs(amount),
            category: 'quick',
            date: Date.now(),
            type: txType,
          });
          break;
          
        case 'note':
          if (!state.modules.notes) state.modules.notes = { data: { list: [] }, meta: {} };
          state.modules.notes.data.list.push({
            id: Utils.generateId(),
            title,
            content: '',
            category: 'quick',
            created: Date.now(),
          });
          break;
          
        case 'journal':
          if (!state.modules.journal) state.modules.journal = { data: { entries: [] }, meta: {} };
          state.modules.journal.data.entries.push({
            id: Utils.generateId(),
            text: title,
            mood: 'neutral',
            tags: ['quick'],
            date: Date.now(),
          });
          break;
      }
      
      Storage.saveState(state);
      modal.remove();
      UIManager.showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} added successfully`, 'success');
      ModuleSystem.updateDashboard();
    });
    
    modal.querySelector('#quickAddCancel').addEventListener('click', () => modal.remove());
  },
  
  // Show settings modal
  showSettingsModal: () => {
    const state = Storage.loadState();
    const settings = state.settings || {};
    
    const content = `
      <div style="display:flex;flex-direction:column;gap:16px">
        <div>
          <h4 style="margin-bottom:8px">General Settings</h4>
          <div style="display:flex;flex-direction:column;gap:8px">
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="autoSave" ${settings.autoSave !== false ? 'checked' : ''}>
              Enable auto-save
            </label>
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="animations" ${settings.animations !== false ? 'checked' : ''}>
              Enable animations
            </label>
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="notifications" ${settings.notifications === true ? 'checked' : ''}>
              Enable notifications
            </label>
          </div>
        </div>
        
        <div>
          <h4 style="margin-bottom:8px">Data Management</h4>
          <div style="display:flex;flex-direction:column;gap:8px">
            <label>
              Auto-backup frequency
              <select id="backupFrequency" style="width:100%;margin-top:4px;padding:8px;border:1px solid #ddd;border-radius:4px">
                <option value="daily" ${settings.backupFrequency === 'daily' ? 'selected' : ''}>Daily</option>
                <option value="weekly" ${settings.backupFrequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                <option value="monthly" ${settings.backupFrequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                <option value="never" ${!settings.backupFrequency || settings.backupFrequency === 'never' ? 'selected' : ''}>Never</option>
              </select>
            </label>
          </div>
        </div>
        
        <div>
          <h4 style="margin-bottom:8px">Danger Zone</h4>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn-danger" id="clearDataBtn" style="width:100%;padding:8px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer">Clear All Data</button>
            <button class="btn-warning" id="resetSettingsBtn" style="width:100%;padding:8px;background:#ff9800;color:white;border:none;border-radius:4px;cursor:pointer">Reset Settings</button>
          </div>
        </div>
      </div>
    `;
    
    const buttons = [
      '<button class="btn-primary" id="saveSettingsBtn" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Save Settings</button>',
      '<button class="small" id="cancelSettingsBtn" style="padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">Cancel</button>',
    ];
    
    const modal = UIManager.showModal('Settings', content, buttons);
    
    modal.querySelector('#saveSettingsBtn').addEventListener('click', () => {
      const newSettings = {
        autoSave: modal.querySelector('#autoSave').checked,
        animations: modal.querySelector('#animations').checked,
        notifications: modal.querySelector('#notifications').checked,
        backupFrequency: modal.querySelector('#backupFrequency').value,
      };
      
      state.settings = newSettings;
      Storage.saveState(state);
      modal.remove();
      UIManager.showToast('Settings saved', 'success');
    });
    
    modal.querySelector('#clearDataBtn').addEventListener('click', () => {
      if (confirm('This will delete ALL your data. This cannot be undone. Are you sure?')) {
        localStorage.clear();
        modal.remove();
        UIManager.showToast('All data cleared', 'danger');
        setTimeout(() => location.reload(), 1000);
      }
    });
    
    modal.querySelector('#resetSettingsBtn').addEventListener('click', () => {
      if (confirm('Reset all settings to defaults?')) {
        state.settings = {};
        Storage.saveState(state);
        modal.remove();
        UIManager.showToast('Settings reset', 'success');
        setTimeout(() => location.reload(), 1000);
      }
    });
    
    modal.querySelector('#cancelSettingsBtn').addEventListener('click', () => modal.remove());
  },
  
  // Show today's summary
  showTodaySummary: () => {
    const state = Storage.loadState();
    const today = new Date().toDateString();
    
    let summary = `## Today's Summary (${Utils.formatDate(new Date(), 'short')})\n\n`;
    
    // Check habits for today
    const habits = state.modules?.habits?.data?.list || [];
    const todaysHabits = habits.filter(h => {
      const lastTick = h.lastTick ? new Date(h.lastTick).toDateString() : '';
      return lastTick === today;
    });
    
    summary += `**Habits Completed:** ${todaysHabits.length}/${habits.length}\n`;
    
    // Check tasks due today
    const tasks = state.modules?.tasks?.data?.list || [];
    const todayTasks = tasks.filter(t => {
      if (!t.dueDate) return false;
      const dueDate = new Date(t.dueDate).toDateString();
      return dueDate === today;
    });
    const completedTodayTasks = todayTasks.filter(t => t.completed);
    
    summary += `**Tasks Due Today:** ${completedTodayTasks.length}/${todayTasks.length} completed\n`;
    
    // Today's transactions
    const transactions = state.modules?.finances?.data?.transactions || [];
    const todayTransactions = transactions.filter(t => {
      const txDate = new Date(t.date).toDateString();
      return txDate === today;
    });
    const todaySpent = todayTransactions.reduce((sum, t) => t.amount < 0 ? sum + Math.abs(t.amount) : sum, 0);
    
    summary += `**Today's Spending:** $${todaySpent.toFixed(2)}\n`;
    
    // Journal entries today
    const journals = state.modules?.journal?.data?.entries || [];
    const todayJournals = journals.filter(j => {
      const entryDate = new Date(j.date).toDateString();
      return entryDate === today;
    });
    
    summary += `**Journal Entries:** ${todayJournals.length}\n`;
    
    UIManager.showModal("Today's Summary", `<div style="white-space: pre-line;">${Utils.escapeHtml(summary)}</div>`);
  },
  
  // Show guide modal
  showGuideModal: () => {
    const content = `
      <div style="display:flex;flex-direction:column;gap:16px;max-height:60vh;overflow-y:auto">
        <div>
          <h4 style="margin-bottom:8px">Getting Started</h4>
          <p>LifeLedger helps you track and organize different aspects of your life in one place.</p>
        </div>
        
        <div>
          <h4 style="margin-bottom:8px">Quick Start</h4>
          <ol style="margin-left:20px;display:flex;flex-direction:column;gap:8px">
            <li><strong>Set Goals:</strong> Define what you want to achieve</li>
            <li><strong>Track Habits:</strong> Build daily routines with streaks</li>
            <li><strong>Manage Tasks:</strong> Organize todos with priorities</li>
            <li><strong>Track Finances:</strong> Log income and expenses</li>
            <li><strong>Journal:</strong> Record thoughts and reflections</li>
          </ol>
        </div>
        
        <div>
          <h4 style="margin-bottom:8px">Keyboard Shortcuts</h4>
          <ul style="margin-left:20px;display:flex;flex-direction:column;gap:4px">
            <li><code>Ctrl+K</code> or <code>/</code> - Search</li>
            <li><code>Ctrl+Q</code> - Quick Add</li>
            <li><code>Esc</code> - Clear search</li>
          </ul>
        </div>
        
        <div>
          <h4 style="margin-bottom:8px">Tips</h4>
          <ul style="margin-left:20px;display:flex;flex-direction:column;gap:4px">
            <li>Use the Dashboard for an overview</li>
            <li>Export regularly for backup</li>
            <li>Create custom modules for specific needs</li>
            <li>Use tags and categories for organization</li>
          </ul>
        </div>
      </div>
    `;
    
    UIManager.showModal('Getting Started Guide', content);
  },
  
  // Show add module modal
  showAddModuleModal: () => {
    const content = `
      <div style="display:flex;flex-direction:column;gap:12px">
        <div>
          <label>Module Name</label>
          <input id="moduleName" type="text" placeholder="e.g., Projects, Books, Fitness" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
        </div>
        <div>
          <label>Description</label>
          <input id="moduleDesc" type="text" placeholder="What does this module track?" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
        </div>
        <div>
          <label>Icon</label>
          <select id="moduleIcon" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
            <option value="üìÅ">üìÅ Folder</option>
            <option value="üìö">üìö Books</option>
            <option value="üèãÔ∏è">üèãÔ∏è Fitness</option>
            <option value="üé®">üé® Creative</option>
            <option value="üìä">üìä Analytics</option>
            <option value="üîß">üîß Tools</option>
            <option value="üéØ">üéØ Target</option>
            <option value="üíº">üíº Work</option>
          </select>
        </div>
        <div>
          <label>Template</label>
          <select id="moduleTemplate" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
            <option value="list">Simple List</option>
            <option value="tracker">Progress Tracker</option>
            <option value="notes">Notes/Journal</option>
            <option value="custom">Custom</option>
          </select>
        </div>
      </div>
    `;
    
    const buttons = [
      '<button class="btn-primary" id="createModuleBtn" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Create Module</button>',
      '<button class="small" id="cancelModuleBtn" style="padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">Cancel</button>',
    ];
    
    const modal = UIManager.showModal('Add New Module', content, buttons);
    
    modal.querySelector('#createModuleBtn').addEventListener('click', () => {
      const name = modal.querySelector('#moduleName').value.trim();
      const desc = modal.querySelector('#moduleDesc').value.trim();
      const icon = modal.querySelector('#moduleIcon').value;
      const template = modal.querySelector('#moduleTemplate').value;
      
      if (!name) {
        UIManager.showToast('Please enter a module name', 'warning');
        return;
      }
      
      const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
      
      if (ModuleSystem.registry[id]) {
        UIManager.showToast('Module already exists', 'warning');
        return;
      }
      
      // Create module based on template
      let moduleConfig;
      switch (template) {
        case 'list':
          moduleConfig = {
            name,
            icon,
            desc: desc || 'Custom list module',
            defaultData: { items: [] },
            render: ModuleSystem.templates.listTemplate,
          };
          break;
        case 'tracker':
          moduleConfig = {
            name,
            icon,
            desc: desc || 'Progress tracking module',
            defaultData: { items: [] },
            render: ModuleSystem.templates.trackerTemplate,
          };
          break;
        case 'notes':
          moduleConfig = {
            name,
            icon,
            desc: desc || 'Notes module',
            defaultData: { notes: [] },
            render: ModuleSystem.templates.notesTemplate,
          };
          break;
        default:
          moduleConfig = {
            name,
            icon,
            desc: desc || 'Custom module',
            defaultData: { items: [] },
            render: ModuleSystem.templates.customTemplate,
          };
      }
      
      ModuleSystem.registerModule(id, moduleConfig);
      modal.remove();
      UIManager.showToast(`Module "${name}" created`, 'success');
    });
    
    modal.querySelector('#cancelModuleBtn').addEventListener('click', () => modal.remove());
  },
};

// ==================== MODULE SYSTEM ====================
const ModuleSystem = {
  registry: {},
  state: Storage.loadState(),
  currentModuleId: null,
  
  // Register a module
  registerModule: (id, descriptor) => {
    if (!id || ModuleSystem.registry[id]) return false;
    
    ModuleSystem.registry[id] = {
      id,
      name: descriptor.name || id,
      icon: descriptor.icon || 'üìÅ',
      desc: descriptor.desc || 'Custom module',
      defaultData: descriptor.defaultData || {},
      render: descriptor.render || ModuleSystem.templates.customTemplate,
      onLoad: descriptor.onLoad,
      onUnload: descriptor.onUnload,
    };
    
    // Initialize module data if not exists
    if (!ModuleSystem.state.modules) ModuleSystem.state.modules = {};
    if (!ModuleSystem.state.modules[id]) {
      ModuleSystem.state.modules[id] = {
        data: Utils.deepClone(ModuleSystem.registry[id].defaultData),
        meta: {
          created: Date.now(),
          updated: Date.now(),
          version: CONFIG.VERSION,
        },
      };
    }
    
    // Initialize enabled order if not exists
    if (!ModuleSystem.state.enabledOrder) ModuleSystem.state.enabledOrder = [];
    
    // Add to enabled order if not present
    if (!ModuleSystem.state.enabledOrder.includes(id)) {
      ModuleSystem.state.enabledOrder.push(id);
    }
    
    Storage.saveState(ModuleSystem.state);
    ModuleSystem.renderModuleList();
    return true;
  },
  
  // Unregister a module
  unregisterModule: (id) => {
    if (!ModuleSystem.registry[id]) return false;
    
    delete ModuleSystem.registry[id];
    const idx = ModuleSystem.state.enabledOrder.indexOf(id);
    if (idx >= 0) ModuleSystem.state.enabledOrder.splice(idx, 1);
    
    Storage.saveState(ModuleSystem.state);
    ModuleSystem.renderModuleList();
    return true;
  },
  
  // Render module list in sidebar
  renderModuleList: () => {
    const modulesListEl = document.getElementById('modulesList');
    if (!modulesListEl) return;
    
    modulesListEl.innerHTML = '';
    
    // Always show dashboard first
    const dashboardItem = document.createElement('div');
    dashboardItem.className = `module-item ${ModuleSystem.currentModuleId === 'dashboard' ? 'active' : ''}`;
    dashboardItem.dataset.id = 'dashboard';
    dashboardItem.style.cssText = `
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 4px;
    `;
    dashboardItem.innerHTML = `
      <div class="module-title" style="display:flex;align-items:center;gap:12px">
        <div class="icon" style="font-size:20px">üìä</div>
        <div>
          <div style="font-weight:600">Dashboard</div>
          <div class="module-meta" style="font-size:12px;color:#666">Overview & analytics</div>
        </div>
      </div>
    `;
    dashboardItem.addEventListener('click', () => ModuleSystem.openModule('dashboard'));
    modulesListEl.appendChild(dashboardItem);
    
    // Show other modules
    (ModuleSystem.state.enabledOrder || []).forEach(id => {
      const m = ModuleSystem.registry[id];
      if (!m || id === 'dashboard') return;
      
      const item = document.createElement('div');
      item.className = `module-item ${ModuleSystem.currentModuleId === id ? 'active' : ''}`;
      item.dataset.id = id;
      item.style.cssText = `
        padding: 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
        margin-bottom: 4px;
      `;
      item.innerHTML = `
        <div class="module-title" style="display:flex;align-items:center;gap:12px">
          <div class="icon" style="font-size:20px">${m.icon}</div>
          <div>
            <div style="font-weight:600">${m.name}</div>
            <div class="module-meta" style="font-size:12px;color:#666">${m.desc}</div>
          </div>
        </div>
      `;
      item.addEventListener('click', () => ModuleSystem.openModule(id));
      modulesListEl.appendChild(item);
    });
  },
  
  // Open a module
  openModule: (id) => {
    const moduleAreaEl = document.getElementById('module-area');
    const welcomeView = document.getElementById('welcome-view');
    
    if (welcomeView) {
      welcomeView.classList.add('hidden');
    }
    
    // Update active state
    document.querySelectorAll('.module-item').forEach(item => {
      item.classList.remove('active');
      item.style.background = '';
    });
    
    const activeItem = document.querySelector(`.module-item[data-id="${id}"]`);
    if (activeItem) {
      activeItem.classList.add('active');
      activeItem.style.background = '#f0f0f0';
    }
    
    ModuleSystem.currentModuleId = id;
    
    // Clear module area
    if (moduleAreaEl) {
      moduleAreaEl.innerHTML = '';
    } else {
      console.error('Module area element not found');
      return;
    }
    
    // Load module content
    if (id === 'dashboard') {
      ModuleSystem.renderDashboard();
    } else if (ModuleSystem.registry[id]) {
      const module = ModuleSystem.registry[id];
      const moduleData = ModuleSystem.state.modules?.[id]?.data || module.defaultData;
      
      const container = document.createElement('div');
      container.id = `module-${id}`;
      container.className = 'fade-in';
      container.style.cssText = `
        animation: fadeIn 0.3s ease;
        padding: 20px;
      `;
      
      // Create module header
      const header = document.createElement('div');
      header.className = 'module-header';
      header.style.cssText = `
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #eee;
      `;
      header.innerHTML = `
        <div>
          <h2 style="margin:0">${module.name}</h2>
          <p class="muted" style="margin-top:4px;color:#666">${module.desc}</p>
        </div>
        <div style="display:flex;gap:8px">
          <button class="small" onclick="ModuleSystem.exportModuleData('${id}')" style="padding:6px 12px;background:#f0f0f0;border:1px solid #ddd;border-radius:4px;cursor:pointer">Export</button>
          <button class="small btn-danger" onclick="ModuleSystem.deleteModule('${id}')" style="padding:6px 12px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer">Delete</button>
        </div>
      `;
      container.appendChild(header);
      
      // Create content area
      const content = document.createElement('div');
      content.id = `module-content-${id}`;
      container.appendChild(content);
      
      moduleAreaEl.appendChild(container);
      
      // Call module's render function
      const helpers = {
        getState: () => ModuleSystem.state,
        setData: (newData) => {
          if (!ModuleSystem.state.modules) ModuleSystem.state.modules = {};
          if (!ModuleSystem.state.modules[id]) {
            ModuleSystem.state.modules[id] = { data: {}, meta: {} };
          }
          ModuleSystem.state.modules[id].data = newData;
          ModuleSystem.state.modules[id].meta.updated = Date.now();
          Storage.saveState(ModuleSystem.state);
          ModuleSystem.updateDashboard();
        },
        save: () => Storage.saveState(ModuleSystem.state),
        notify: (msg, type = 'info') => UIManager.showToast(msg, type),
        utils: Utils,
      };
      
      if (module.onLoad) module.onLoad();
      if (module.render) {
        module.render(content, moduleData, helpers);
      }
    } else {
      // Module not found
      moduleAreaEl.innerHTML = `
        <div class="empty-state" style="text-align:center;padding:40px 20px">
          <div class="empty-state-icon" style="font-size:48px;margin-bottom:16px">‚ùì</div>
          <h3 style="margin:0 0 8px 0">Module Not Found</h3>
          <p class="muted" style="color:#666;margin-bottom:20px">The module "${id}" doesn't exist.</p>
          <button class="btn-primary" onclick="ModuleSystem.openModule('dashboard')" style="padding:10px 20px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">
            Return to Dashboard
          </button>
        </div>
      `;
    }
    
    // Update URL hash
    window.location.hash = `module=${id}`;
  },
  
  // Render dashboard
  renderDashboard: () => {
    const moduleAreaEl = document.getElementById('module-area');
    if (!moduleAreaEl) return;
    
    const container = document.createElement('div');
    container.id = 'module-dashboard';
    container.className = 'fade-in';
    container.style.cssText = `
      animation: fadeIn 0.3s ease;
      padding: 20px;
    `;
    
    // Dashboard header
    const header = document.createElement('div');
    header.className = 'module-header';
    header.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #eee;
    `;
    header.innerHTML = `
      <div>
        <h2 style="margin:0">Dashboard</h2>
        <p class="muted" style="margin-top:4px;color:#666">Your life at a glance</p>
      </div>
      <div style="display:flex;gap:8px">
        <button class="small" onclick="ModuleSystem.refreshDashboard()" style="padding:6px 12px;background:#f0f0f0;border:1px solid #ddd;border-radius:4px;cursor:pointer">Refresh</button>
        <button class="small btn-primary" onclick="ModuleSystem.generateReport()" style="padding:6px 12px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">Generate Report</button>
      </div>
    `;
    container.appendChild(header);
    
    // Dashboard content will be updated by updateDashboard
    const content = document.createElement('div');
    content.id = 'dashboard-content';
    container.appendChild(content);
    
    moduleAreaEl.appendChild(container);
    
    // Initial dashboard update
    ModuleSystem.updateDashboard();
  },
  
  // Update dashboard statistics
  updateDashboard: () => {
    const state = ModuleSystem.state;
    
    // Goals
    const goals = state.modules?.goals?.data?.list || [];
    const totalGoals = goals.length;
    const avgGoalProgress = goals.length > 0 
      ? goals.reduce((sum, g) => sum + (g.progress || 0), 0) / goals.length 
      : 0;
    
    // Habits
    const habits = state.modules?.habits?.data?.list || [];
    const totalHabits = habits.length;
    const activeStreak = habits.length > 0
      ? Math.max(...habits.map(h => h.streak || 0))
      : 0;
    
    // Finances
    const transactions = state.modules?.finances?.data?.transactions || [];
    const totalBalance = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
    const thisMonth = new Date().getMonth();
    const monthlySpent = transactions
      .filter(t => new Date(t.date).getMonth() === thisMonth && t.amount < 0)
      .reduce((sum, t) => sum + Math.abs(t.amount), 0);
    
    // Tasks
    const tasks = state.modules?.tasks?.data?.list || [];
    const completedTasks = tasks.filter(t => t.completed).length;
    const productivityScore = tasks.length > 0
      ? Math.round((completedTasks / tasks.length) * 100)
      : 0;
    
    // Update dashboard content if open
    const dashboardContent = document.getElementById('dashboard-content');
    if (dashboardContent && ModuleSystem.currentModuleId === 'dashboard') {
      dashboardContent.innerHTML = ModuleSystem.getDashboardHTML();
    }
    
    // Update recent activity
    ModuleSystem.updateRecentActivity();
  },
  
  // Get dashboard HTML
  getDashboardHTML: () => {
    const state = ModuleSystem.state;
    
    // Calculate stats
    const goals = state.modules?.goals?.data?.list || [];
    const habits = state.modules?.habits?.data?.list || [];
    const tasks = state.modules?.tasks?.data?.list || [];
    const transactions = state.modules?.finances?.data?.transactions || [];
    const journals = state.modules?.journal?.data?.entries || [];
    const notes = state.modules?.notes?.data?.list || [];
    const health = state.modules?.health?.data?.logs || [];
    const relationships = state.modules?.relationships?.data?.contacts || [];
    
    const totalBalance = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
    const completedTasks = tasks.filter(t => t.completed).length;
    const activeHabits = habits.filter(h => h.streak > 0).length;
    const recentJournals = journals.slice(-3).reverse();
    
    return `
      <div class="dashboard" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px">
        <div class="stat-card" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee">
          <div class="stat-value" style="font-size:32px;font-weight:700;color:#4CAF50">${goals.length}</div>
          <div class="stat-label" style="color:#666;margin-top:8px">Active Goals</div>
          <div class="progress" style="margin-top:12px;width:100%;height:6px;background:#e0e0e0;border-radius:3px;overflow:hidden">
            <div style="width:${goals.length > 0 ? (goals.reduce((s, g) => s + (g.progress || 0), 0) / goals.length * 100) : 0}%;height:100%;background:#4CAF50"></div>
          </div>
        </div>
        
        <div class="stat-card" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee">
          <div class="stat-value" style="font-size:32px;font-weight:700;color:#2196F3">${habits.length}</div>
          <div class="stat-label" style="color:#666;margin-top:8px">Daily Habits</div>
          <div class="muted" style="margin-top:8px;font-size:12px;color:#888">
            ${activeHabits} active ‚Ä¢ ${Math.max(...habits.map(h => h.streak || 0))}d max streak
          </div>
        </div>
        
        <div class="stat-card" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee">
          <div class="stat-value" style="font-size:32px;font-weight:700;color:#4CAF50">${Utils.formatCurrency(totalBalance)}</div>
          <div class="stat-label" style="color:#666;margin-top:8px">Net Balance</div>
          <div class="muted" style="margin-top:8px;font-size:12px;color:#888">
            ${transactions.length} transactions
          </div>
        </div>
        
        <div class="stat-card" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee">
          <div class="stat-value" style="font-size:32px;font-weight:700;color:#FF9800">${tasks.length}</div>
          <div class="stat-label" style="color:#666;margin-top:8px">Total Tasks</div>
          <div class="muted" style="margin-top:8px;font-size:12px;color:#888">
            ${completedTasks} completed (${tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0}%)
          </div>
        </div>
      </div>
      
      <div style="margin-top:32px">
        <h3 style="margin-bottom:16px">Recent Journal Entries</h3>
        ${recentJournals.length > 0 ? `
          <div class="list" style="display:flex;flex-direction:column;gap:12px">
            ${recentJournals.map(j => `
              <div class="list-item" style="background:#f8f9fa;padding:16px;border-radius:8px;border:1px solid #eee;display:flex;justify-content:space-between;align-items:center">
                <div style="flex:1">
                  <div style="font-weight:600">${Utils.formatDate(j.date, 'medium')}</div>
                  <div class="muted" style="margin-top:4px;color:#666;white-space:pre-line;max-height:60px;overflow:hidden;">
                    ${Utils.escapeHtml(j.text || '').substring(0, 200)}${(j.text || '').length > 200 ? '...' : ''}
                  </div>
                  <div style="display:flex;gap:6px;margin-top:8px">
                    ${(j.tags || []).map(tag => `<span class="tag" style="background:#e0e0e0;padding:2px 8px;border-radius:12px;font-size:12px">${Utils.escapeHtml(tag)}</span>`).join('')}
                  </div>
                </div>
                <button class="small" onclick="ModuleSystem.openModule('journal')" style="padding:6px 12px;background:#f0f0f0;border:1px solid #ddd;border-radius:4px;cursor:pointer">View</button>
              </div>
            `).join('')}
          </div>
        ` : `
          <div class="empty-state" style="text-align:center;padding:40px 20px;background:#f8f9fa;border-radius:8px;border:1px solid #eee">
            <div class="empty-state-icon" style="font-size:48px;margin-bottom:16px">üìì</div>
            <p style="color:#666;margin-bottom:20px">No recent journal entries</p>
            <button class="btn-primary small" onclick="ModuleSystem.openModule('journal')" style="padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">
              Start Journaling
            </button>
          </div>
        `}
      </div>
      
      <div style="margin-top:32px">
        <h3 style="margin-bottom:16px">Module Overview</h3>
        <div class="grid grid-3" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
          <div class="card" onclick="ModuleSystem.openModule('goals')" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee;cursor:pointer">
            <h4 style="margin:0 0 8px 0">üéØ Goals</h4>
            <p class="muted" style="color:#666;font-size:14px">${goals.length} goals set</p>
          </div>
          <div class="card" onclick="ModuleSystem.openModule('habits')" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee;cursor:pointer">
            <h4 style="margin:0 0 8px 0">üîÑ Habits</h4>
            <p class="muted" style="color:#666;font-size:14px">${habits.length} habits tracked</p>
          </div>
          <div class="card" onclick="ModuleSystem.openModule('tasks')" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee;cursor:pointer">
            <h4 style="margin:0 0 8px 0">‚úÖ Tasks</h4>
            <p class="muted" style="color:#666;font-size:14px">${tasks.length} tasks (${completedTasks} done)</p>
          </div>
          <div class="card" onclick="ModuleSystem.openModule('finances')" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee;cursor:pointer">
            <h4 style="margin:0 0 8px 0">üí∞ Finances</h4>
            <p class="muted" style="color:#666;font-size:14px">${transactions.length} transactions</p>
          </div>
          <div class="card" onclick="ModuleSystem.openModule('journal')" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee;cursor:pointer">
            <h4 style="margin:0 0 8px 0">üìì Journal</h4>
            <p class="muted" style="color:#666;font-size:14px">${journals.length} entries</p>
          </div>
          <div class="card" onclick="ModuleSystem.openModule('notes')" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee;cursor:pointer">
            <h4 style="margin:0 0 8px 0">üìù Notes</h4>
            <p class="muted" style="color:#666;font-size:14px">${notes.length} notes</p>
          </div>
        </div>
      </div>
    `;
  },
  
  // Update recent activity
  updateRecentActivity: () => {
    const activityEl = document.getElementById('recentActivity');
    if (!activityEl) return;
    
    const state = ModuleSystem.state;
    let activities = [];
    
    // Collect activities from all modules
    Object.keys(state.modules || {}).forEach(moduleId => {
      const module = state.modules[moduleId];
      if (!module?.data) return;
      
      // Check for lists/arrays in module data
      Object.keys(module.data).forEach(key => {
        const items = module.data[key];
        if (Array.isArray(items)) {
          items.forEach(item => {
            if (item.created || item.date) {
              activities.push({
                module: moduleId,
                type: key,
                item,
                timestamp: item.updated || item.created || item.date,
              });
            }
          });
        }
      });
    });
    
    // Sort by timestamp (newest first)
    activities.sort((a, b) => b.timestamp - a.timestamp);
    
    // Take top 5
    const recent = activities.slice(0, 5);
    
    if (recent.length === 0) {
      activityEl.innerHTML = `
        <div class="empty-state" style="text-align:center;padding:20px">
          <div class="empty-state-icon" style="font-size:32px;margin-bottom:8px">üìä</div>
          <p style="margin:0 0 8px 0">No activity yet</p>
          <p class="muted" style="color:#666;margin:0">Start using modules to see activity here</p>
        </div>
      `;
      return;
    }
    
    activityEl.innerHTML = recent.map(activity => {
      const module = ModuleSystem.registry[activity.module];
      const moduleName = module?.name || activity.module;
      const date = Utils.formatDate(activity.timestamp, 'short');
      const title = activity.item.title || activity.item.description || 'Activity';
      
      return `
        <div class="list-item" style="background:#f8f9fa;padding:12px;border-radius:6px;border:1px solid #eee;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:600">${Utils.escapeHtml(title.substring(0, 50))}${title.length > 50 ? '...' : ''}</div>
            <div class="muted" style="color:#666;font-size:12px">${moduleName} ‚Ä¢ ${date}</div>
          </div>
          <button class="small" onclick="ModuleSystem.openModule('${activity.module}')" style="padding:4px 8px;background:#f0f0f0;border:1px solid #ddd;border-radius:4px;cursor:pointer;font-size:12px">View</button>
        </div>
      `;
    }).join('');
  },
  
  // Perform global search
  performGlobalSearch: (query) => {
    const state = ModuleSystem.state;
    const results = [];
    const queryLower = query.toLowerCase();
    
    Object.keys(state.modules || {}).forEach(moduleId => {
      const module = state.modules[moduleId];
      if (!module?.data) return;
      
      Object.keys(module.data).forEach(key => {
        const items = module.data[key];
        if (Array.isArray(items)) {
          items.forEach(item => {
            // Convert item to string for searching
            const itemString = JSON.stringify(item).toLowerCase();
            if (itemString.includes(queryLower)) {
              results.push({
                module: moduleId,
                item,
                match: item.title || item.description || JSON.stringify(item).substring(0, 100),
              });
            }
          });
        }
      });
    });
    
    if (results.length === 0) {
      UIManager.showToast('No results found', 'info');
      return;
    }
    
    // Show results in modal
    const content = `
      <div style="max-height:60vh;overflow-y:auto">
        <p>Found ${results.length} result${results.length !== 1 ? 's' : ''} for "${query}"</p>
        <div class="list" style="display:flex;flex-direction:column;gap:8px">
          ${results.slice(0, 20).map(result => `
            <div class="list-item" style="background:#f8f9fa;padding:12px;border-radius:6px;border:1px solid #eee;display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:600">${Utils.escapeHtml(result.match.substring(0, 60))}${result.match.length > 60 ? '...' : ''}</div>
                <div class="muted" style="color:#666;font-size:12px">${ModuleSystem.registry[result.module]?.name || result.module}</div>
              </div>
              <button class="small" onclick="ModuleSystem.openModule('${result.module}')" style="padding:4px 8px;background:#f0f0f0;border:1px solid #ddd;border-radius:4px;cursor:pointer;font-size:12px">Open</button>
            </div>
          `).join('')}
        </div>
        ${results.length > 20 ? `<p class="muted" style="margin-top:12px;color:#666">Showing 20 of ${results.length} results</p>` : ''}
      </div>
    `;
    
    UIManager.showModal(`Search Results for "${query}"`, content);
  },
  
  // Export module data
  exportModuleData: (moduleId) => {
    const module = ModuleSystem.state.modules?.[moduleId];
    if (!module) {
      UIManager.showToast('Module not found', 'danger');
      return;
    }
    
    const exportData = {
      module: moduleId,
      data: module.data,
      meta: module.meta,
      exportDate: new Date().toISOString(),
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `lifeledger-${moduleId}-export.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    UIManager.showToast(`Exported ${moduleId} data`, 'success');
  },
  
  // Delete a module
  deleteModule: (moduleId) => {
    if (!confirm(`Delete module "${moduleId}" and all its data? This cannot be undone.`)) {
      return;
    }
    
    ModuleSystem.unregisterModule(moduleId);
    if (ModuleSystem.state.modules) {
      delete ModuleSystem.state.modules[moduleId];
    }
    Storage.saveState(ModuleSystem.state);
    
    if (ModuleSystem.currentModuleId === moduleId) {
      ModuleSystem.openModule('dashboard');
    }
    
    UIManager.showToast(`Module "${moduleId}" deleted`, 'success');
  },
  
  // Refresh dashboard
  refreshDashboard: () => {
    ModuleSystem.updateDashboard();
    UIManager.showToast('Dashboard refreshed', 'success');
  },
  
  // Generate report
  generateReport: () => {
    const state = ModuleSystem.state;
    let report = `# LifeLedger Report\n`;
    report += `Generated: ${new Date().toLocaleString()}\n\n`;
    
    Object.keys(state.modules || {}).forEach(moduleId => {
      const module = ModuleSystem.registry[moduleId];
      if (!module) return;
      
      report += `## ${module.name}\n`;
      
      const data = state.modules[moduleId]?.data;
      if (!data) {
        report += `No data\n\n`;
        return;
      }
      
      Object.keys(data).forEach(key => {
        const items = data[key];
        if (Array.isArray(items)) {
          report += `### ${key.charAt(0).toUpperCase() + key.slice(1)} (${items.length})\n`;
          items.forEach(item => {
            if (item.title || item.description) {
              report += `- ${item.title || item.description}`;
              if (item.progress !== undefined) report += ` ‚Äî ${Math.round(item.progress * 100)}%`;
              if (item.streak) report += ` ‚Äî Streak: ${item.streak}d`;
              if (item.amount) report += ` ‚Äî ${Utils.formatCurrency(item.amount)}`;
              report += `\n`;
            }
          });
          report += `\n`;
        }
      });
    });
    
    // Create download
    const blob = new Blob([report], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `lifeledger-report-${new Date().toISOString().split('T')[0]}.md`;
    a.click();
    URL.revokeObjectURL(url);
    
    UIManager.showToast('Report generated', 'success');
  },
  
  // Module templates
  templates: {
    // Simple list template
    listTemplate: (mount, data, { setData, save, notify }) => {
      const items = data.items || [];
      
      mount.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:16px">
          <div style="display:flex;gap:8px">
            <input id="newItemInput" type="text" placeholder="Add new item..." style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px">
            <button id="addItemBtn" class="btn-primary" style="padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">Add</button>
          </div>
          <div id="itemsList" class="list" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>
      `;
      
      const renderItems = () => {
        const listEl = mount.querySelector('#itemsList');
        if (!listEl) return;
        
        listEl.innerHTML = '';
        
        items.forEach((item, index) => {
          const itemEl = document.createElement('div');
          itemEl.className = 'list-item';
          itemEl.style.cssText = `
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
          `;
          itemEl.innerHTML = `
            <div style="flex:1;display:flex;align-items:center;gap:12px">
              <input type="checkbox" ${item.completed ? 'checked' : ''} data-index="${index}" style="width:16px;height:16px">
              <div>
                <div style="font-weight:600">${Utils.escapeHtml(item.title || 'Untitled')}</div>
                ${item.description ? `<div class="muted" style="color:#666;margin-top:4px">${Utils.escapeHtml(item.description)}</div>` : ''}
              </div>
            </div>
            <div style="display:flex;gap:6px">
              <button class="small" data-action="edit" data-index="${index}" style="padding:4px 8px;background:#f0f0f0;border:1px solid #ddd;border-radius:4px;cursor:pointer;font-size:12px">Edit</button>
              <button class="small danger" data-action="delete" data-index="${index}" style="padding:4px 8px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px">Delete</button>
            </div>
          `;
          listEl.appendChild(itemEl);
        });
        
        // Add event listeners
        listEl.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < items.length) {
              items[index].completed = e.target.checked;
              items[index].updated = Date.now();
              setData({ ...data, items });
              save();
              renderItems();
            }
          });
        });
        
        listEl.querySelectorAll('[data-action="edit"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < items.length) {
              const newTitle = prompt('Edit item:', items[index].title);
              if (newTitle !== null) {
                items[index].title = newTitle;
                items[index].updated = Date.now();
                setData({ ...data, items });
                save();
                renderItems();
              }
            }
          });
        });
        
        listEl.querySelectorAll('[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < items.length) {
              if (confirm('Delete this item?')) {
                items.splice(index, 1);
                setData({ ...data, items });
                save();
                renderItems();
              }
            }
          });
        });
      };
      
      // Add new item
      mount.querySelector('#addItemBtn').addEventListener('click', () => {
        const input = mount.querySelector('#newItemInput');
        const title = input?.value.trim() || '';
        if (!title) {
          notify('Please enter a title', 'warning');
          return;
        }
        
        items.push({
          id: Utils.generateId(),
          title,
          description: '',
          completed: false,
          created: Date.now(),
        });
        
        if (input) input.value = '';
        setData({ ...data, items });
        save();
        renderItems();
        notify('Item added', 'success');
      });
      
      renderItems();
    },
    
    // Progress tracker template
    trackerTemplate: (mount, data, { setData, save, notify }) => {
      const items = data.items || [];
      
      mount.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:16px">
          <div style="display:flex;gap:8px">
            <input id="newTrackerInput" type="text" placeholder="New tracker name..." style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px">
            <button id="addTrackerBtn" class="btn-primary" style="padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">Add Tracker</button>
          </div>
          <div id="trackersList" class="list" style="display:flex;flex-direction:column;gap:12px"></div>
        </div>
      `;
      
      const renderTrackers = () => {
        const listEl = mount.querySelector('#trackersList');
        if (!listEl) return;
        
        listEl.innerHTML = '';
        
        items.forEach((item, index) => {
          const progress = item.progress || 0;
          const progressPercent = Math.round(progress * 100);
          
          const itemEl = document.createElement('div');
          itemEl.className = 'list-item';
          itemEl.style.cssText = `
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
          `;
          itemEl.innerHTML = `
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div style="font-weight:600">${Utils.escapeHtml(item.title || 'Untitled')}</div>
                <div style="font-weight:700;color:#4CAF50">${progressPercent}%</div>
              </div>
              <div class="progress" style="width:100%;height:6px;background:#e0e0e0;border-radius:3px;overflow:hidden">
                <div style="width:${progressPercent}%;height:100%;background:#4CAF50"></div>
              </div>
              ${item.target ? `<div class="muted" style="color:#666;margin-top:4px">Target: ${Utils.escapeHtml(item.target)}</div>` : ''}
            </div>
            <div style="display:flex;flex-direction:column;gap:6px">
              <input type="number" min="0" max="100" value="${progressPercent}" 
                     data-index="${index}" style="width:80px;padding:6px;border:1px solid #ddd;border-radius:4px">
              <button class="small danger" data-action="delete" data-index="${index}" style="padding:4px 8px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px">Delete</button>
            </div>
          `;
          listEl.appendChild(itemEl);
        });
        
        // Add event listeners for progress inputs
        listEl.querySelectorAll('input[type="number"]').forEach(input => {
          input.addEventListener('change', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < items.length) {
              const value = parseInt(e.target.value) || 0;
              items[index].progress = Math.max(0, Math.min(1, value / 100));
              items[index].updated = Date.now();
              setData({ ...data, items });
              save();
              renderTrackers();
            }
          });
        });
        
        listEl.querySelectorAll('[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < items.length) {
              if (confirm('Delete this tracker?')) {
                items.splice(index, 1);
                setData({ ...data, items });
                save();
                renderTrackers();
              }
            }
          });
        });
      };
      
      // Add new tracker
      mount.querySelector('#addTrackerBtn').addEventListener('click', () => {
        const input = mount.querySelector('#newTrackerInput');
        const title = input?.value.trim() || '';
        if (!title) {
          notify('Please enter a tracker name', 'warning');
          return;
        }
        
        items.push({
          id: Utils.generateId(),
          title,
          progress: 0,
          target: '',
          created: Date.now(),
        });
        
        if (input) input.value = '';
        setData({ ...data, items });
        save();
        renderTrackers();
        notify('Tracker added', 'success');
      });
      
      renderTrackers();
    },
    
    // Notes template
    notesTemplate: (mount, data, { setData, save, notify }) => {
      const notes = data.notes || [];
      
      mount.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:16px">
          <div style="display:flex;gap:8px">
            <input id="newNoteTitle" type="text" placeholder="Note title..." style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px">
            <button id="addNoteBtn" class="btn-primary" style="padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">Add Note</button>
          </div>
          <div id="notesList" class="grid grid-2" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px"></div>
        </div>
      `;
      
      const renderNotes = () => {
        const listEl = mount.querySelector('#notesList');
        if (!listEl) return;
        
        listEl.innerHTML = '';
        
        notes.forEach((note, index) => {
          const noteEl = document.createElement('div');
          noteEl.className = 'card';
          noteEl.style.cssText = `
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #eee;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
          `;
          noteEl.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
              <div style="font-weight:600">${Utils.escapeHtml(note.title || 'Untitled')}</div>
              <button class="small danger" data-action="delete" data-index="${index}" style="padding:2px 6px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px">√ó</button>
            </div>
            <div class="muted" style="color:#666;font-size:13px;margin-bottom:8px">
              ${Utils.formatDate(note.updated || note.created, 'short')}
            </div>
            <div style="max-height:100px;overflow:hidden;font-size:14px">
              ${Utils.escapeHtml(note.content || '').substring(0, 200)}
              ${(note.content || '').length > 200 ? '...' : ''}
            </div>
            ${note.category ? `<div class="chip" style="background:#e0e0e0;padding:2px 8px;border-radius:12px;font-size:12px;margin-top:8px;display:inline-block">${Utils.escapeHtml(note.category)}</div>` : ''}
          `;
          
          noteEl.addEventListener('click', () => {
            const newContent = prompt('Edit note content:', note.content || '');
            if (newContent !== null) {
              note.content = newContent;
              note.updated = Date.now();
              setData({ ...data, notes });
              save();
              renderNotes();
            }
          });
          
          listEl.appendChild(noteEl);
        });
        
        // Add delete event listeners
        listEl.querySelectorAll('[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < notes.length) {
              if (confirm('Delete this note?')) {
                notes.splice(index, 1);
                setData({ ...data, notes });
                save();
                renderNotes();
              }
            }
          });
        });
      };
      
      // Add new note
      mount.querySelector('#addNoteBtn').addEventListener('click', () => {
        const titleInput = mount.querySelector('#newNoteTitle');
        const title = titleInput?.value.trim() || '';
        if (!title) {
          notify('Please enter a note title', 'warning');
          return;
        }
        
        const content = prompt('Enter note content:');
        if (content === null) return;
        
        notes.push({
          id: Utils.generateId(),
          title,
          content,
          category: '',
          created: Date.now(),
        });
        
        if (titleInput) titleInput.value = '';
        setData({ ...data, notes });
        save();
        renderNotes();
        notify('Note added', 'success');
      });
      
      renderNotes();
    },
    
    // Custom template
    customTemplate: (mount, data, { setData, save, notify }) => {
      mount.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:16px">
          <h3>Custom Module</h3>
          <p class="muted" style="color:#666">This is a custom module. You can store any data here.</p>
          
          <div>
            <label>Module Data (JSON)</label>
            <textarea id="customData" rows="10" style="width:100%;font-family:monospace;padding:8px;border:1px solid #ddd;border-radius:4px">${JSON.stringify(data, null, 2)}</textarea>
          </div>
          
          <div style="display:flex;gap:8px">
            <button id="saveCustomBtn" class="btn-primary" style="padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">Save Data</button>
            <button id="resetCustomBtn" class="btn-danger" style="padding:8px 16px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer">Reset to Default</button>
          </div>
        </div>
      `;
      
      mount.querySelector('#saveCustomBtn').addEventListener('click', () => {
        try {
          const newData = JSON.parse(mount.querySelector('#customData').value);
          setData(newData);
          save();
          notify('Data saved successfully', 'success');
        } catch (error) {
          notify('Invalid JSON: ' + error.message, 'danger');
        }
      });
      
      mount.querySelector('#resetCustomBtn').addEventListener('click', () => {
        if (confirm('Reset all data in this module?')) {
          setData({});
          save();
          mount.querySelector('#customData').value = '{}';
          notify('Data reset', 'success');
        }
      });
    },
  },
};

// ==================== BUILT-IN MODULES ====================
// Register built-in modules on load
function registerBuiltinModules() {
  // Dashboard module (special)
  ModuleSystem.registerModule('dashboard', {
    name: 'Dashboard',
    icon: 'üìä',
    desc: 'Overview and analytics',
    defaultData: {},
    render: () => {}, // Handled separately
  });
  
  // Goals Module
  ModuleSystem.registerModule('goals', {
    name: 'Goals',
    icon: 'üéØ',
    desc: 'Set and track goals',
    defaultData: { list: [] },
    render: ModuleSystem.templates.trackerTemplate,
  });
  
  // Habits Module
  ModuleSystem.registerModule('habits', {
    name: 'Habits',
    icon: 'üîÑ',
    desc: 'Daily habits and streaks',
    defaultData: { list: [] },
    render: (mount, data, helpers) => {
      const habits = data.list || [];
      
      mount.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:16px">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <input id="newHabit" type="text" placeholder="New habit (e.g., Morning walk)" style="flex:1;min-width:200px;padding:8px;border:1px solid #ddd;border-radius:4px">
            <select id="habitCategory" style="padding:8px;border:1px solid #ddd;border-radius:4px">
              <option value="health">Health</option>
              <option value="productivity">Productivity</option>
              <option value="learning">Learning</option>
              <option value="mindfulness">Mindfulness</option>
              <option value="other">Other</option>
            </select>
            <button id="addHabitBtn" class="btn-primary" style="padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">Add Habit</button>
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px" id="habitsGrid"></div>
        </div>
      `;
      
      const renderHabits = () => {
        const grid = mount.querySelector('#habitsGrid');
        if (!grid) return;
        
        grid.innerHTML = '';
        
        habits.forEach((habit, index) => {
          const today = new Date().toDateString();
          const lastTick = habit.lastTick ? new Date(habit.lastTick).toDateString() : '';
          const isDoneToday = lastTick === today;
          
          const habitEl = document.createElement('div');
          habitEl.className = 'card';
          habitEl.style.cssText = `
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #eee;
          `;
          habitEl.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
              <div>
                <div style="font-weight:600">${Utils.escapeHtml(habit.title || 'Untitled')}</div>
                <div class="muted" style="font-size:12px;margin-top:2px">
                  ${habit.category ? `<span class="chip" style="background:#e0e0e0;padding:2px 8px;border-radius:12px;font-size:11px">${habit.category}</span>` : ''}
                  <span style="margin-left:8px;color:#666">Streak: ${habit.streak || 0}d</span>
                </div>
              </div>
              <button class="small danger" data-action="delete" data-index="${index}" style="padding:2px 6px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px">√ó</button>
            </div>
            
            <div style="display:flex;flex-direction:column;gap:8px">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <span class="muted" style="color:#666">Today:</span>
                <button class="small ${isDoneToday ? 'btn-success' : ''}" 
                        data-action="toggle" data-index="${index}"
                        style="width:100px;padding:6px 12px;background:${isDoneToday ? '#4CAF50' : '#f0f0f0'};color:${isDoneToday ? 'white' : '#333'};border:1px solid ${isDoneToday ? '#4CAF50' : '#ddd'};border-radius:4px;cursor:pointer">
                  ${isDoneToday ? '‚úÖ Done' : 'Mark Done'}
                </button>
              </div>
              
              <div class="muted" style="font-size:12px;color:#666">
                ${habit.lastTick ? `Last: ${Utils.formatDate(habit.lastTick, 'short')}` : 'Never completed'}
              </div>
            </div>
          `;
          
          grid.appendChild(habitEl);
        });
        
        // Add event listeners
        grid.querySelectorAll('[data-action="toggle"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < habits.length) {
              const habit = habits[index];
              const today = new Date().toDateString();
              const yesterday = new Date(Date.now() - 86400000).toDateString();
              
              if (habit.lastTick === today) {
                // Untick
                habit.lastTick = null;
                habit.streak = Math.max(0, (habit.streak || 1) - 1);
              } else {
                // Tick
                if (habit.lastTick === yesterday) {
                  habit.streak = (habit.streak || 0) + 1;
                } else if (!habit.lastTick) {
                  habit.streak = 1;
                } else {
                  habit.streak = 1;
                }
                habit.lastTick = Date.now();
              }
              
              helpers.setData({ ...data, list: habits });
              helpers.save();
              renderHabits();
              ModuleSystem.updateDashboard();
              helpers.notify(`Habit ${habit.lastTick === today ? 'marked' : 'unmarked'}`, 'success');
            }
          });
        });
        
        grid.querySelectorAll('[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < habits.length) {
              if (confirm('Delete this habit?')) {
                habits.splice(index, 1);
                helpers.setData({ ...data, list: habits });
                helpers.save();
                renderHabits();
                ModuleSystem.updateDashboard();
                helpers.notify('Habit deleted', 'success');
              }
            }
          });
        });
      };
      
      // Add new habit
      mount.querySelector('#addHabitBtn').addEventListener('click', () => {
        const input = mount.querySelector('#newHabit');
        const category = mount.querySelector('#habitCategory').value;
        const title = input?.value.trim() || '';
        
        if (!title) {
          helpers.notify('Please enter a habit name', 'warning');
          return;
        }
        
        habits.push({
          id: Utils.generateId(),
          title,
          category,
          streak: 0,
          lastTick: null,
          frequency: 'daily',
          created: Date.now(),
        });
        
        if (input) input.value = '';
        helpers.setData({ ...data, list: habits });
        helpers.save();
        renderHabits();
        ModuleSystem.updateDashboard();
        helpers.notify('Habit added', 'success');
      });
      
      renderHabits();
    },
  });
  
  // Tasks Module
  ModuleSystem.registerModule('tasks', {
    name: 'Tasks',
    icon: '‚úÖ',
    desc: 'Todo list with priorities',
    defaultData: { list: [] },
    render: ModuleSystem.templates.listTemplate,
  });
  
  // Finances Module
  ModuleSystem.registerModule('finances', {
    name: 'Finances',
    icon: 'üí∞',
    desc: 'Income, expenses, and budget',
    defaultData: { transactions: [], categories: [], budget: {} },
    render: (mount, data, helpers) => {
      const transactions = data.transactions || [];
      
      mount.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:16px">
          <div class="card" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee">
            <h3 style="margin:0 0 12px 0">Quick Summary</h3>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
              <div>
                <div class="stat-value" style="font-size:24px;font-weight:700;color:#4CAF50">${Utils.formatCurrency(transactions.reduce((s, t) => s + (t.amount || 0), 0))}</div>
                <div class="stat-label" style="color:#666;margin-top:4px">Balance</div>
              </div>
              <div>
                <div class="stat-value" style="font-size:24px;font-weight:700;color:#4CAF50">${Utils.formatCurrency(transactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0))}</div>
                <div class="stat-label" style="color:#666;margin-top:4px">Income</div>
              </div>
              <div>
                <div class="stat-value" style="font-size:24px;font-weight:700;color:#f44336">${Utils.formatCurrency(Math.abs(transactions.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0)))}</div>
                <div class="stat-label" style="color:#666;margin-top:4px">Expenses</div>
              </div>
            </div>
          </div>
          
          <div class="card" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee">
            <h3 style="margin:0 0 12px 0">Add Transaction</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="txDesc" type="text" placeholder="Description" style="flex:1;min-width:200px;padding:8px;border:1px solid #ddd;border-radius:4px">
              <input id="txAmount" type="number" step="0.01" placeholder="Amount" style="width:120px;padding:8px;border:1px solid #ddd;border-radius:4px">
              <select id="txCategory" style="width:140px;padding:8px;border:1px solid #ddd;border-radius:4px">
                <option value="food">Food</option>
                <option value="shopping">Shopping</option>
                <option value="bills">Bills</option>
                <option value="entertainment">Entertainment</option>
                <option value="transport">Transport</option>
                <option value="income">Income</option>
                <option value="other">Other</option>
              </select>
              <select id="txType" style="width:100px;padding:8px;border:1px solid #ddd;border-radius:4px">
                <option value="expense">Expense</option>
                <option value="income">Income</option>
              </select>
              <button id="addTxBtn" class="btn-primary" style="padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">Add</button>
            </div>
          </div>
          
          <div>
            <h3 style="margin:0 0 12px 0">Recent Transactions</h3>
            <div id="txList" class="list" style="display:flex;flex-direction:column;gap:8px"></div>
          </div>
        </div>
      `;
      
      const renderTransactions = () => {
        const listEl = mount.querySelector('#txList');
        if (!listEl) return;
        
        listEl.innerHTML = '';
        
        transactions.slice().reverse().forEach((tx, index) => {
          const actualIndex = transactions.length - 1 - index;
          const isIncome = tx.amount > 0;
          
          const txEl = document.createElement('div');
          txEl.className = 'list-item';
          txEl.style.cssText = `
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
          `;
          txEl.innerHTML = `
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <div style="font-weight:600">${Utils.escapeHtml(tx.description || 'Transaction')}</div>
                <div style="font-weight:700;color:${isIncome ? '#4CAF50' : '#f44336'}">
                  ${isIncome ? '+' : '-'}$${Math.abs(tx.amount || 0).toFixed(2)}
                </div>
              </div>
              <div class="muted" style="color:#666">
                ${Utils.formatDate(tx.date, 'short')} ‚Ä¢ ${tx.category || 'Uncategorized'}
                ${tx.type ? `‚Ä¢ ${tx.type}` : ''}
              </div>
            </div>
            <button class="small danger" data-action="delete" data-index="${actualIndex}" style="padding:4px 8px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px">Delete</button>
          `;
          listEl.appendChild(txEl);
        });
        
        // Add delete event listeners
        listEl.querySelectorAll('[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < transactions.length) {
              if (confirm('Delete this transaction?')) {
                transactions.splice(index, 1);
                helpers.setData({ ...data, transactions });
                helpers.save();
                renderTransactions();
                ModuleSystem.updateDashboard();
                helpers.notify('Transaction deleted', 'success');
              }
            }
          });
        });
      };
      
      // Add new transaction
      mount.querySelector('#addTxBtn').addEventListener('click', () => {
        const desc = mount.querySelector('#txDesc')?.value.trim() || '';
        const amount = parseFloat(mount.querySelector('#txAmount')?.value || 0);
        const category = mount.querySelector('#txCategory')?.value || 'other';
        const type = mount.querySelector('#txType')?.value || 'expense';
        
        if (!desc || isNaN(amount)) {
          helpers.notify('Please enter description and amount', 'warning');
          return;
        }
        
        const finalAmount = type === 'income' ? Math.abs(amount) : -Math.abs(amount);
        
        transactions.push({
          id: Utils.generateId(),
          description: desc,
          amount: finalAmount,
          category,
          type,
          date: Date.now(),
        });
        
        const descInput = mount.querySelector('#txDesc');
        const amountInput = mount.querySelector('#txAmount');
        if (descInput) descInput.value = '';
        if (amountInput) amountInput.value = '';
        
        helpers.setData({ ...data, transactions });
        helpers.save();
        renderTransactions();
        ModuleSystem.updateDashboard();
        helpers.notify('Transaction added', 'success');
      });
      
      renderTransactions();
    },
  });
  
  // Journal Module
  ModuleSystem.registerModule('journal', {
    name: 'Journal',
    icon: 'üìì',
    desc: 'Daily reflections and notes',
    defaultData: { entries: [] },
    render: (mount, data, helpers) => {
      const entries = data.entries || [];
      
      mount.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:16px">
          <div class="card" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee">
            <h3 style="margin:0 0 12px 0">New Entry</h3>
            <div style="display:flex;flex-direction:column;gap:8px">
              <textarea id="journalText" rows="4" placeholder="What's on your mind today?" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px"></textarea>
              <div style="display:flex;gap:8px;align-items:center">
                <select id="journalMood" style="width:120px;padding:8px;border:1px solid #ddd;border-radius:4px">
                  <option value="great">üòä Great</option>
                  <option value="good">üôÇ Good</option>
                  <option value="neutral">üòê Neutral</option>
                  <option value="bad">üòî Bad</option>
                  <option value="awful">üò¢ Awful</option>
                </select>
                <input id="journalTags" type="text" placeholder="Tags (comma separated)" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px">
                <button id="addJournalBtn" class="btn-primary" style="padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">Save Entry</button>
              </div>
            </div>
          </div>
          
          <div>
            <h3 style="margin:0 0 12px 0">Recent Entries</h3>
            <div id="journalList" class="list" style="display:flex;flex-direction:column;gap:12px"></div>
          </div>
        </div>
      `;
      
      const renderEntries = () => {
        const listEl = mount.querySelector('#journalList');
        if (!listEl) return;
        
        listEl.innerHTML = '';
        
        entries.slice().reverse().forEach((entry, index) => {
          const actualIndex = entries.length - 1 - index;
          const moodIcons = {
            great: 'üòä',
            good: 'üôÇ',
            neutral: 'üòê',
            bad: 'üòî',
            awful: 'üò¢',
          };
          
          const entryEl = document.createElement('div');
          entryEl.className = 'card';
          entryEl.style.cssText = `
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #eee;
            margin-bottom: 12px;
          `;
          entryEl.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
              <div style="display:flex;align-items:center;gap:8px">
                <span style="font-size:20px">${moodIcons[entry.mood] || 'üìù'}</span>
                <div>
                  <div style="font-weight:600">${Utils.formatDate(entry.date, 'long')}</div>
                  <div class="muted" style="color:#666;font-size:12px">
                    ${Utils.formatDate(entry.date, 'time')}
                    ${entry.tags?.length ? `‚Ä¢ ${entry.tags.map(t => `<span class="tag" style="background:#e0e0e0;padding:2px 6px;border-radius:10px;font-size:11px">${Utils.escapeHtml(t)}</span>`).join(' ')}` : ''}
                  </div>
                </div>
              </div>
              <button class="small danger" data-action="delete" data-index="${actualIndex}" style="padding:2px 6px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px">√ó</button>
            </div>
            <div style="white-space:pre-line;line-height:1.6">${Utils.escapeHtml(entry.text || '')}</div>
          `;
          listEl.appendChild(entryEl);
        });
        
        // Add delete event listeners
        listEl.querySelectorAll('[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < entries.length) {
              if (confirm('Delete this journal entry?')) {
                entries.splice(index, 1);
                helpers.setData({ ...data, entries });
                helpers.save();
                renderEntries();
                ModuleSystem.updateDashboard();
                helpers.notify('Entry deleted', 'success');
              }
            }
          });
        });
      };
      
      // Add new journal entry
      mount.querySelector('#addJournalBtn').addEventListener('click', () => {
        const text = mount.querySelector('#journalText')?.value.trim() || '';
        const mood = mount.querySelector('#journalMood')?.value || 'neutral';
        const tags = mount.querySelector('#journalTags')?.value
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0) || [];
        
        if (!text) {
          helpers.notify('Please enter some text', 'warning');
          return;
        }
        
        entries.push({
          id: Utils.generateId(),
          text,
          mood,
          tags,
          date: Date.now(),
        });
        
        const textArea = mount.querySelector('#journalText');
        const tagsInput = mount.querySelector('#journalTags');
        if (textArea) textArea.value = '';
        if (tagsInput) tagsInput.value = '';
        
        helpers.setData({ ...data, entries });
        helpers.save();
        renderEntries();
        ModuleSystem.updateDashboard();
        helpers.notify('Journal entry saved', 'success');
      });
      
      renderEntries();
    },
  });
  
  // Notes Module
  ModuleSystem.registerModule('notes', {
    name: 'Notes',
    icon: 'üìù',
    desc: 'Quick notes and ideas',
    defaultData: { list: [] },
    render: ModuleSystem.templates.notesTemplate,
  });
  
  // Health Module
  ModuleSystem.registerModule('health', {
    name: 'Health',
    icon: 'üè•',
    desc: 'Fitness and wellness tracking',
    defaultData: { logs: [], metrics: {} },
    render: (mount, data, helpers) => {
      const logs = data.logs || [];
      
      mount.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:16px">
          <div class="card" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee">
            <h3 style="margin:0 0 12px 0">Quick Log</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <select id="healthType" style="width:140px;padding:8px;border:1px solid #ddd;border-radius:4px">
                <option value="weight">Weight</option>
                <option value="exercise">Exercise</option>
                <option value="sleep">Sleep</option>
                <option value="water">Water</option>
                <option value="mood">Mood</option>
              </select>
              <input id="healthValue" type="text" placeholder="Value (e.g., 70kg, 30min)" style="flex:1;min-width:200px;padding:8px;border:1px solid #ddd;border-radius:4px">
              <input id="healthNote" type="text" placeholder="Note (optional)" style="flex:1;min-width:200px;padding:8px;border:1px solid #ddd;border-radius:4px">
              <button id="addHealthBtn" class="btn-primary" style="padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">Log</button>
            </div>
          </div>
          
          <div>
            <h3 style="margin:0 0 12px 0">Recent Logs</h3>
            <div id="healthList" class="list" style="display:flex;flex-direction:column;gap:8px"></div>
          </div>
        </div>
      `;
      
      const renderLogs = () => {
        const listEl = mount.querySelector('#healthList');
        if (!listEl) return;
        
        listEl.innerHTML = '';
        
        logs.slice().reverse().forEach((log, index) => {
          const actualIndex = logs.length - 1 - index;
          
          const logEl = document.createElement('div');
          logEl.className = 'list-item';
          logEl.style.cssText = `
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
          `;
          logEl.innerHTML = `
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <div style="font-weight:600">${log.type?.charAt(0).toUpperCase() + log.type?.slice(1) || 'Log'}</div>
                <div style="font-weight:700;color:#4CAF50">${log.value || ''}</div>
              </div>
              <div class="muted" style="color:#666">
                ${Utils.formatDate(log.date, 'long')}
                ${log.note ? `‚Ä¢ ${Utils.escapeHtml(log.note)}` : ''}
              </div>
            </div>
            <button class="small danger" data-action="delete" data-index="${actualIndex}" style="padding:4px 8px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px">Delete</button>
          `;
          listEl.appendChild(logEl);
        });
        
        // Add delete event listeners
        listEl.querySelectorAll('[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < logs.length) {
              if (confirm('Delete this health log?')) {
                logs.splice(index, 1);
                helpers.setData({ ...data, logs });
                helpers.save();
                renderLogs();
                ModuleSystem.updateDashboard();
                helpers.notify('Health log deleted', 'success');
              }
            }
          });
        });
      };
      
      // Add new health log
      mount.querySelector('#addHealthBtn').addEventListener('click', () => {
        const type = mount.querySelector('#healthType')?.value || 'exercise';
        const value = mount.querySelector('#healthValue')?.value.trim() || '';
        const note = mount.querySelector('#healthNote')?.value.trim() || '';
        
        if (!value) {
          helpers.notify('Please enter a value', 'warning');
          return;
        }
        
        logs.push({
          id: Utils.generateId(),
          type,
          value,
          note,
          date: Date.now(),
        });
        
        const valueInput = mount.querySelector('#healthValue');
        const noteInput = mount.querySelector('#healthNote');
        if (valueInput) valueInput.value = '';
        if (noteInput) noteInput.value = '';
        
        helpers.setData({ ...data, logs });
        helpers.save();
        renderLogs();
        ModuleSystem.updateDashboard();
        helpers.notify('Health log saved', 'success');
      });
      
      renderLogs();
    },
  });
  
  // Relationships Module
  ModuleSystem.registerModule('relationships', {
    name: 'Relationships',
    icon: 'üë•',
    desc: 'Contact and interaction tracking',
    defaultData: { contacts: [], interactions: [] },
    render: (mount, data, helpers) => {
      const contacts = data.contacts || [];
      
      mount.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:16px">
          <div class="card" style="background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #eee">
            <h3 style="margin:0 0 12px 0">Add Contact</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="contactName" type="text" placeholder="Name" style="flex:1;min-width:200px;padding:8px;border:1px solid #ddd;border-radius:4px">
              <input id="contactRole" type="text" placeholder="Role (friend, colleague)" style="width:140px;padding:8px;border:1px solid #ddd;border-radius:4px">
              <button id="addContactBtn" class="btn-primary" style="padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">Add</button>
            </div>
          </div>
          
          <div>
            <h3 style="margin:0 0 12px 0">Contacts</h3>
            <div id="contactsList" class="grid grid-2" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px"></div>
          </div>
        </div>
      `;
      
      const renderContacts = () => {
        const grid = mount.querySelector('#contactsList');
        if (!grid) return;
        
        grid.innerHTML = '';
        
        contacts.forEach((contact, index) => {
          const contactEl = document.createElement('div');
          contactEl.className = 'card';
          contactEl.style.cssText = `
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #eee;
          `;
          contactEl.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
              <div>
                <div style="font-weight:600;font-size:18px">${Utils.escapeHtml(contact.name || 'Unnamed')}</div>
                <div class="muted" style="color:#666;font-size:12px;margin-top:2px">
                  ${contact.role ? `<span class="chip" style="background:#e0e0e0;padding:2px 8px;border-radius:12px;font-size:11px">${contact.role}</span>` : ''}
                  <span style="margin-left:8px">Added ${Utils.formatDate(contact.created, 'short')}</span>
                </div>
              </div>
              <button class="small danger" data-action="delete" data-index="${index}" style="padding:2px 6px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px">√ó</button>
            </div>
            
            <div style="margin-top:12px">
              <div class="muted" style="color:#666;font-size:12px;margin-bottom:4px">Last interaction:</div>
              <div style="font-size:14px">
                ${contact.lastInteraction ? Utils.formatDate(contact.lastInteraction, 'medium') : 'Never'}
              </div>
            </div>
            
            <div style="display:flex;gap:6px;margin-top:12px">
              <button class="small" data-action="log" data-index="${index}" style="padding:4px 8px;background:#f0f0f0;border:1px solid #ddd;border-radius:4px;cursor:pointer;font-size:12px">Log Interaction</button>
              <button class="small" data-action="note" data-index="${index}" style="padding:4px 8px;background:#f0f0f0;border:1px solid #ddd;border-radius:4px;cursor:pointer;font-size:12px">Add Note</button>
            </div>
          `;
          
          grid.appendChild(contactEl);
        });
        
        // Add event listeners
        grid.querySelectorAll('[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < contacts.length) {
              if (confirm(`Delete contact "${contacts[index].name}"?`)) {
                contacts.splice(index, 1);
                helpers.setData({ ...data, contacts });
                helpers.save();
                renderContacts();
                ModuleSystem.updateDashboard();
                helpers.notify('Contact deleted', 'success');
              }
            }
          });
        });
        
        grid.querySelectorAll('[data-action="log"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            if (index >= 0 && index < contacts.length) {
              const contact = contacts[index];
              const interaction = prompt(`Log interaction with ${contact.name}:`, 'Had coffee');
              if (interaction) {
                contact.lastInteraction = Date.now();
                if (!data.interactions) data.interactions = [];
                data.interactions.push({
                  contactId: contact.id,
                  contactName: contact.name,
                  interaction,
                  date: Date.now(),
                });
                helpers.setData(data);
                helpers.save();
                renderContacts();
                helpers.notify('Interaction logged', 'success');
              }
            }
          });
        });
      };
      
      // Add new contact
      mount.querySelector('#addContactBtn').addEventListener('click', () => {
        const name = mount.querySelector('#contactName')?.value.trim() || '';
        const role = mount.querySelector('#contactRole')?.value.trim() || '';
        
        if (!name) {
          helpers.notify('Please enter a name', 'warning');
          return;
        }
        
        contacts.push({
          id: Utils.generateId(),
          name,
          role: role || 'friend',
          created: Date.now(),
          lastInteraction: null,
        });
        
        const nameInput = mount.querySelector('#contactName');
        const roleInput = mount.querySelector('#contactRole');
        if (nameInput) nameInput.value = '';
        if (roleInput) roleInput.value = '';
        
        helpers.setData({ ...data, contacts });
        helpers.save();
        renderContacts();
        ModuleSystem.updateDashboard();
        helpers.notify('Contact added', 'success');
      });
      
      renderContacts();
    },
  });
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
  // Register built-in modules
  registerBuiltinModules();
  
  // Initialize UI
  UIManager.init();
  
  // Render module list
  ModuleSystem.renderModuleList();
  
  // Update dashboard
  ModuleSystem.updateDashboard();
  
  // Check for hash in URL
  const hash = window.location.hash.replace('#', '');
  if (hash.startsWith('module=')) {
    const moduleId = hash.split('=')[1];
    setTimeout(() => {
      ModuleSystem.openModule(moduleId);
    }, 100);
  }
  
  // Auto-save interval
  setInterval(() => {
    const state = ModuleSystem.state;
    const settings = state.settings || {};
    if (settings.autoSave !== false) {
      Storage.saveState(state);
    }
  }, CONFIG.AUTO_SAVE_DELAY);
  
  // Auto-backup (weekly)
  setInterval(() => {
    const state = ModuleSystem.state;
    const settings = state.settings || {};
    if (settings.backupFrequency === 'weekly') {
      const lastBackup = localStorage.getItem('last_auto_backup');
      const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
      
      if (!lastBackup || parseInt(lastBackup) < weekAgo) {
        Storage.createBackup('Weekly auto-backup');
        localStorage.setItem('last_auto_backup', Date.now().toString());
        console.log('Auto-backup created');
      }
    }
  }, 60 * 60 * 1000); // Check every hour
  
  // Expose API to global scope
  window.LifeLedger = {
    modules: ModuleSystem,
    storage: Storage,
    ui: UIManager,
    utils: Utils,
    config: CONFIG,
    
    // Helper methods
    showShortcuts: () => {
      UIManager.showModal('Keyboard Shortcuts', `
        <div style="display:flex;flex-direction:column;gap:8px">
          <div><strong>Ctrl+K</strong> or <strong>/</strong> - Focus search</div>
          <div><strong>Ctrl+Q</strong> - Quick add</div>
          <div><strong>Esc</strong> - Clear search/close modals</div>
          <div><strong>Ctrl+S</strong> - Save current module</div>
          <div><strong>Ctrl+E</strong> - Export data</div>
        </div>
      `);
    },
    
    // Developer tools
    dev: {
      exportAll: () => Storage.exportData('json'),
      importAll: (json) => Storage.importData(json, 'json'),
      resetAll: () => {
        if (confirm('Reset ALL data?')) {
          localStorage.clear();
          location.reload();
        }
      },
      showState: () => console.log(ModuleSystem.state),
      showModules: () => console.log(ModuleSystem.registry),
    },
  };
  
  // Set app status
  const appStatusEl = document.getElementById('appStatus');
  if (appStatusEl) {
    appStatusEl.textContent = 'Online';
  }
  
  // Show welcome message on first load
  const firstLoad = !localStorage.getItem(CONFIG.STORAGE_KEY);
  if (firstLoad) {
    setTimeout(() => {
      UIManager.showToast('Welcome to LifeLedger! Start by adding some goals or habits.', 'success', 5000);
    }, 1000);
  }
});

// Service Worker simulation (for PWA-like behavior)
if ('serviceWorker' in navigator) {
  // In a real PWA, you would register a service worker here
  console.log('Service Worker API available - PWA ready');
}

// Handle offline/online status
window.addEventListener('online', () => {
  const appStatusEl = document.getElementById('appStatus');
  if (appStatusEl) {
    appStatusEl.textContent = 'Online';
  }
  UIManager.showToast('Back online', 'success');
});

window.addEventListener('offline', () => {
  const appStatusEl = document.getElementById('appStatus');
  if (appStatusEl) {
    appStatusEl.textContent = 'Offline';
  }
  UIManager.showToast('Working offline - data saved locally', 'warning');
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  .fade-in {
    animation: fadeIn 0.3s ease;
  }
  
  .hidden {
    display: none !important;
  }
  
  [data-theme="dark"] {
    --bg-primary: #1a1a1a;
    --bg-secondary: #2d2d2d;
    --text-primary: #ffffff;
    --text-secondary: #b0b0b0;
  }
  
  [data-theme="light"] {
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --text-primary: #333333;
    --text-secondary: #666666;
  }
`;
document.head.appendChild(style);
</script>
</body>
</html>
