<-- This version still needs the export and backup functions implemented !-->


<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#2563eb">
<meta name="description" content="LifeLedger ‚Äî modular life tracking: goals, habits, finances, journal. Local-first, expandable." />
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTGlmZUxlZGdlciIsInNob3J0X25hbWUiOiJMaWZlTGVkZ2VyIiwiZGVzY3JpcHRpb24iOiJNb2R1bGFyIGxpZmUgdHJhY2tpbmcgYXBwIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzA2MTIyMCJ9">
<title>LifeLedger ‚Äî Personal Life Ledger</title>
<style>
  /* [All your CSS remains exactly the same - included for completeness] */
  :root {
    --bg: #f6f7fb;
    --panel: #ffffff;
    --muted: #6b7280;
    --accent: #2563eb;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    --glass: rgba(255, 255, 255, 0.6);
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 6px 18px rgba(16, 24, 40, 0.08);
    --shadow-lg: 0 12px 32px rgba(16, 24, 40, 0.12);
    --transition: all 0.2s ease;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color-scheme: light;
  }

  [data-theme="dark"] {
    --bg: #0b1220;
    --panel: #071022;
    --muted: #9aa4b2;
    --accent: #60a5fa;
    --success: #34d399;
    --warning: #fbbf24;
    --danger: #fb7185;
    --info: #93c5fd;
    --glass: rgba(255, 255, 255, 0.03);
    --shadow: 0 6px 22px rgba(2, 6, 23, 0.6);
    --shadow-lg: 0 12px 32px rgba(2, 6, 23, 0.8);
    color-scheme: dark;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    font-size: 15px;
    line-height: 1.5;
    transition: var(--transition);
  }

  body {
    overflow-x: hidden;
  }

  .app {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 20px;
    min-height: 100vh;
    padding: 20px;
    box-sizing: border-box;
    max-width: 1600px;
    margin: 0 auto;
  }

  @media (max-width: 1024px) {
    .app {
      grid-template-columns: 1fr;
      padding: 16px;
    }
    .sidebar {
      order: 2;
    }
    .main {
      order: 1;
    }
  }

  @media (max-width: 640px) {
    .app {
      padding: 12px;
    }
  }

  /* Loading overlay */
  .loading {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--glass);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Sidebar */
  .sidebar {
    background: linear-gradient(180deg, var(--panel), rgba(255, 255, 255, 0.02));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .brand {
    border-bottom-color: rgba(255, 255, 255, 0.05);
  }

  .logo {
    width: 48px;
    height: 48px;
    border-radius: var(--radius);
    display: grid;
    place-items: center;
    background: linear-gradient(135deg, var(--accent), #7c3aed);
    color: white;
    font-weight: 700;
    font-size: 20px;
    box-shadow: 0 6px 18px rgba(99, 102, 241, 0.18);
  }

  .brand h1 {
    margin: 0;
    font-size: 18px;
    letter-spacing: -0.3px;
    background: linear-gradient(90deg, var(--accent), #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .brand p {
    margin: 2px 0 0;
    font-size: 12px;
    color: var(--muted);
  }

  .modules {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 4px;
    overflow-y: auto;
    max-height: 50vh;
    padding-right: 4px;
  }

  .modules::-webkit-scrollbar {
    width: 4px;
  }

  .modules::-webkit-scrollbar-track {
    background: transparent;
  }

  .modules::-webkit-scrollbar-thumb {
    background: var(--muted);
    border-radius: 2px;
    opacity: 0.3;
  }

  .module-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 10px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    user-select: none;
    transition: var(--transition);
    border: 1px solid transparent;
  }

  .module-item:hover {
    background: var(--glass);
    transform: translateX(2px);
  }

  .module-item.active {
    background: linear-gradient(90deg, rgba(37, 99, 235, 0.1), rgba(124, 58, 237, 0.05));
    border-color: rgba(37, 99, 235, 0.2);
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
  }

  .module-title {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .module-title .icon {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-sm);
    display: grid;
    place-items: center;
    font-weight: 600;
    background: rgba(0, 0, 0, 0.04);
    color: var(--accent);
    font-size: 14px;
  }

  [data-theme="dark"] .module-title .icon {
    background: rgba(255, 255, 255, 0.05);
  }

  .module-meta {
    font-size: 12px;
    color: var(--muted);
  }

  .module-badge {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 10px;
    background: var(--accent);
    color: white;
  }

  .sidebar .controls {
    margin-top: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding-top: 12px;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .sidebar .controls {
    border-top-color: rgba(255, 255, 255, 0.05);
  }

  button, .file-btn {
    border: 0;
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    background: transparent;
    color: var(--muted);
    font-size: 14px;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: inherit;
  }

  button:hover, .file-btn:hover {
    background: var(--glass);
    color: var(--accent);
  }

  .btn-primary {
    background: linear-gradient(90deg, var(--accent), #7c3aed);
    color: white;
    box-shadow: 0 8px 18px rgba(37, 99, 235, 0.15);
    font-weight: 500;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 12px 24px rgba(37, 99, 235, 0.2);
    color: white;
  }

  .btn-success {
    background: linear-gradient(90deg, var(--success), #059669);
    color: white;
  }

  .btn-warning {
    background: linear-gradient(90deg, var(--warning), #d97706);
    color: white;
  }

  .btn-danger {
    background: linear-gradient(90deg, var(--danger), #dc2626);
    color: white;
  }

  .small {
    padding: 6px 10px;
    font-size: 13px;
  }

  /* Main content */
  .main {
    display: flex;
    flex-direction: column;
    gap: 16px;
    overflow: hidden;
  }

  .card {
    background: var(--panel);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: var(--transition);
  }

  .card:hover {
    box-shadow: var(--shadow-lg);
  }

  header.appbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    padding: 16px 20px;
  }

  .search {
    display: flex;
    gap: 10px;
    align-items: center;
    background: var(--glass);
    padding: 10px 16px;
    border-radius: var(--radius);
    width: 100%;
    max-width: 600px;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .search {
    border-color: rgba(255, 255, 255, 0.05);
  }

  input[type="search"] {
    border: 0;
    background: transparent;
    outline: none;
    width: 100%;
    color: inherit;
    font-size: 15px;
  }

  input[type="search"]::placeholder {
    color: var(--muted);
  }

  .toolbar {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  /* Module area */
  #module-area {
    min-height: 400px;
    display: block;
    overflow: visible;
  }

  .module-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .module-header {
    border-bottom-color: rgba(255, 255, 255, 0.05);
  }

  /* Lists */
  .list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .list-item {
    padding: 16px;
    border-radius: var(--radius-sm);
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), transparent);
    border: 1px solid rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: space-between;
    gap: 16px;
    align-items: center;
    transition: var(--transition);
  }

  [data-theme="dark"] .list-item {
    border-color: rgba(255, 255, 255, 0.05);
  }

  .list-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }

  .progress {
    height: 8px;
    background: rgba(0, 0, 0, 0.06);
    border-radius: 999px;
    overflow: hidden;
    width: 200px;
  }

  [data-theme="dark"] .progress {
    background: rgba(255, 255, 255, 0.06);
  }

  .progress > i {
    display: block;
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #7c3aed);
    border-radius: 999px;
    transition: width 0.3s ease;
  }

  .progress-success > i {
    background: linear-gradient(90deg, var(--success), #059669);
  }

  .progress-warning > i {
    background: linear-gradient(90deg, var(--warning), #d97706);
  }

  .progress-danger > i {
    background: linear-gradient(90deg, var(--danger), #dc2626);
  }

  /* Forms */
  label {
    font-size: 13px;
    color: var(--muted);
    font-weight: 500;
    margin-bottom: 6px;
    display: block;
  }

  input[type="text"],
  input[type="number"],
  input[type="date"],
  input[type="email"],
  input[type="tel"],
  textarea,
  select,
  .small-input {
    width: 100%;
    padding: 12px;
    border-radius: var(--radius-sm);
    border: 1px solid rgba(0, 0, 0, 0.1);
    background: var(--panel);
    color: inherit;
    box-sizing: border-box;
    font-size: 14px;
    transition: var(--transition);
  }

  [data-theme="dark"] input,
  [data-theme="dark"] textarea,
  [data-theme="dark"] select {
    border-color: rgba(255, 255, 255, 0.1);
  }

  input:focus,
  textarea:focus,
  select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  textarea {
    resize: vertical;
    min-height: 100px;
    line-height: 1.5;
  }

  .row {
    display: flex;
    gap: 16px;
  }

  @media (max-width: 640px) {
    .row {
      flex-direction: column;
    }
  }

  /* Grid system */
  .grid {
    display: grid;
    gap: 16px;
  }

  .grid-2 {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }

  .grid-3 {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }

  .grid-4 {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  /* Dashboard */
  .dashboard {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }

  .stat-card {
    padding: 20px;
    border-radius: var(--radius);
    background: linear-gradient(135deg, var(--panel), rgba(255, 255, 255, 0.02));
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .stat-value {
    font-size: 32px;
    font-weight: 700;
    background: linear-gradient(90deg, var(--accent), #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .stat-label {
    font-size: 14px;
    color: var(--muted);
    margin-top: 4px;
  }

  /* Charts */
  .chart-container {
    height: 200px;
    position: relative;
    margin: 20px 0;
  }

  .chart-bar {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    height: 100%;
    padding: 10px;
  }

  .chart-bar-item {
    flex: 1;
    background: linear-gradient(to top, var(--accent), #7c3aed);
    border-radius: 4px 4px 0 0;
    min-height: 10px;
    position: relative;
  }

  /* Tags and chips */
  .chip {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    background: rgba(0, 0, 0, 0.04);
    color: var(--muted);
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-weight: 500;
  }

  [data-theme="dark"] .chip {
    background: rgba(255, 255, 255, 0.05);
  }

  .chip-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
  }

  .chip-warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
  }

  .chip-danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
  }

  .chip-info {
    background: rgba(59, 130, 246, 0.1);
    color: var(--info);
  }

  .tag {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    background: rgba(0, 0, 0, 0.04);
    color: var(--muted);
  }

  [data-theme="dark"] .tag {
    background: rgba(255, 255, 255, 0.05);
  }

  /* Utility classes */
  .muted {
    color: var(--muted);
    font-size: 14px;
  }

  .right {
    margin-left: auto;
  }

  .danger {
    color: var(--danger);
  }

  .success {
    color: var(--success);
  }

  .warning {
    color: var(--warning);
  }

  .hidden {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
  }

  .fade-in {
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .slide-in {
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { transform: translateX(-20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
  }

  .modal {
    background: var(--panel);
    border-radius: var(--radius);
    padding: 24px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--muted);
  }

  /* Toast notifications */
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1001;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .toast {
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    background: var(--panel);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease;
    border-left: 4px solid var(--accent);
  }

  .toast-success {
    border-left-color: var(--success);
  }

  .toast-warning {
    border-left-color: var(--warning);
  }

  .toast-danger {
    border-left-color: var(--danger);
  }

  /* Footer */
  footer {
    text-align: center;
    padding: 20px;
    color: var(--muted);
    font-size: 13px;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] footer {
    border-top-color: rgba(255, 255, 255, 0.05);
  }

  /* Empty states */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.3;
  }

  /* Tooltips */
  [data-tooltip] {
    position: relative;
  }

  [data-tooltip]:before {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 6px 10px;
    background: var(--panel);
    color: var(--muted);
    font-size: 12px;
    border-radius: var(--radius-sm);
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    box-shadow: var(--shadow);
    z-index: 1000;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  [data-tooltip]:hover:before {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(-4px);
  }

  /* Quick Add Button */
  .quick-add-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), #7c3aed);
    color: white;
    border: none;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
    z-index: 100;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .quick-add-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 35px rgba(37, 99, 235, 0.4);
  }

  /* Settings specific */
  .settings-group {
    background: var(--glass);
    border-radius: var(--radius-sm);
    padding: 20px;
    margin-bottom: 20px;
  }

  .settings-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  .settings-item:last-child {
    border-bottom: none;
  }

  [data-theme="dark"] .settings-item {
    border-bottom-color: rgba(255, 255, 255, 0.05);
  }

  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.1);
    transition: .4s;
    border-radius: 34px;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked + .toggle-slider {
    background-color: var(--accent);
  }

  input:checked + .toggle-slider:before {
    transform: translateX(24px);
  }

  /* Module-specific enhancements */
  .habit-calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-top: 16px;
  }

  .calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    font-size: 12px;
    background: var(--glass);
  }

  .calendar-day.completed {
    background: var(--success);
    color: white;
  }

  .calendar-day.skipped {
    background: var(--danger);
    color: white;
  }

  .calendar-day.partial {
    background: var(--warning);
    color: white;
  }
</style>
</head>
<body>
<div class="loading" id="loading">
  <div class="spinner"></div>
</div>

<div class="app" id="app">
  <aside class="sidebar card" id="sidebar">
    <div class="brand">
      <div class="logo" aria-hidden>LL</div>
      <div>
        <h1>LifeLedger</h1>
        <p>Your modular life dashboard</p>
      </div>
    </div>

    <div>
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="muted" style="font-weight:500">Modules</div>
        <div style="display:flex;gap:6px">
          <button id="addModuleBtn" class="small" data-tooltip="Add custom module">+ Module</button>
          <button id="settingsBtn" class="small" data-tooltip="Settings">‚öôÔ∏è</button>
        </div>
      </div>
      <div class="modules" id="modulesList" role="tablist" aria-label="Modules">
        <!-- modules injected here -->
      </div>
    </div>

    <div class="controls">
      <button id="exportBtn" class="button file-btn small" data-tooltip="Export all data">
        <span>üì§</span> Export
      </button>
      <label class="file-btn small" data-tooltip="Import from file">
        <span>üì•</span> Import
        <input id="importFile" type="file" accept="application/json,.csv" style="display:none">
      </label>
      <button id="themeToggle" class="small" data-tooltip="Toggle theme">
        <span id="themeIcon">üåì</span> Theme
      </button>
      <button id="backupBtn" class="small btn-success" data-tooltip="Create backup">
        <span>üíæ</span> Backup
      </button>
    </div>
    
    <div style="margin-top:auto; padding-top:12px; border-top: 1px solid rgba(0,0,0,0.05);">
      <div class="muted" style="font-size:11px; margin-bottom:8px;">
        <span id="storageUsage">Storage: Calculating...</span>
      </div>
      <div style="font-size:11px;color:var(--muted)">
        <span id="lastSaved">Ready</span>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="card appbar" role="banner">
      <div style="display:flex;gap:12px;align-items:center;width:100%">
        <div class="search" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:0.7">
            <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="11.5" cy="11.5" r="5.5" stroke="currentColor" stroke-width="1.5"/>
          </svg>
          <input id="globalSearch" type="search" placeholder="Search across all modules (Press / to focus)" />
        </div>
        <div class="toolbar right">
          <div class="chip" id="todayChip" data-tooltip="Click for today's summary">
            <span id="todayDate"></span>
            <span id="todayWeekday"></span>
          </div>
          <button id="quickAdd" class="btn-primary small" data-tooltip="Quick add (Ctrl+Q)">
            <span>‚ö°</span> Quick Add
          </button>
          <button id="dashboardBtn" class="small" data-tooltip="Dashboard">
            <span>üìä</span> Dashboard
          </button>
        </div>
      </div>
    </div>

    <section id="module-area" class="card fade-in">
      <!-- Dynamic module content loads here -->
      <div id="welcome-view" class="fade-in">
        <div class="module-header">
          <div>
            <h2 style="margin:0">Welcome to LifeLedger</h2>
            <p class="muted" style="margin-top:4px">Your personal life operating system</p>
          </div>
          <button id="getStartedBtn" class="btn-primary">Get Started Guide</button>
        </div>

        <div class="dashboard" id="dashboardPreview">
          <div class="stat-card">
            <div class="stat-value" id="totalGoals">0</div>
            <div class="stat-label">Active Goals</div>
            <div class="progress" style="margin-top:12px; width:100%">
              <i id="goalsProgress" style="width:0%"></i>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-value" id="totalHabits">0</div>
            <div class="stat-label">Daily Habits</div>
            <div class="muted" style="margin-top:8px; font-size:12px">
              <span id="activeStreak">0</span> day streak
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-value" id="totalBalance">$0</div>
            <div class="stat-label">Current Balance</div>
            <div class="muted" style="margin-top:8px; font-size:12px">
              <span id="monthlySpent">$0</span> this month
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-value" id="productivityScore">0%</div>
            <div class="stat-label">Productivity</div>
            <div class="muted" style="margin-top:8px; font-size:12px">
              Based on completed tasks
            </div>
          </div>
        </div>

        <div style="margin-top:32px">
          <h3 style="margin-bottom:16px">Quick Start</h3>
          <div class="grid grid-3">
            <div class="card" style="cursor:pointer" id="quickStartGoals">
              <h4 style="margin:0 0 8px 0">üéØ Set Goals</h4>
              <p class="muted" style="font-size:14px">Define and track your objectives with progress monitoring</p>
            </div>
            <div class="card" style="cursor:pointer" id="quickStartHabits">
              <h4 style="margin:0 0 8px 0">üîÑ Build Habits</h4>
              <p class="muted" style="font-size:14px">Track daily routines and build streaks</p>
            </div>
            <div class="card" style="cursor:pointer" id="quickStartTasks">
              <h4 style="margin:0 0 8px 0">‚úÖ Manage Tasks</h4>
              <p class="muted" style="font-size:14px">Organize todos with priorities and due dates</p>
            </div>
          </div>
        </div>

        <div style="margin-top:32px">
          <div class="module-header">
            <h3 style="margin:0">Recent Activity</h3>
            <button class="small" id="viewAllActivity">View All</button>
          </div>
          <div id="recentActivity" class="list">
            <div class="empty-state">
              <div class="empty-state-icon">üìä</div>
              <p>No activity yet</p>
              <p class="muted" style="margin-top:8px">Start using modules to see activity here</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="muted">
      LifeLedger v2.0 ‚Ä¢ Local-first ‚Ä¢ <span id="appStatus">Ready</span> ‚Ä¢ 
      <button id="shortcutsBtn" class="small" style="margin-left:8px">Keyboard Shortcuts</button>
    </footer>
  </main>
</div>

<!-- Quick Add FAB -->
<button class="quick-add-btn" id="quickAddFAB" data-tooltip="Quick Add (Ctrl+Q)">+</button>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Modals -->
<div id="modalContainer"></div>

<script>
// ==================== ENHANCED COMPLETE VERSION ====================
// All modules fully functional with data persistence

// Configuration
const CONFIG = {
  APP_NAME: 'LifeLedger',
  VERSION: '2.1.0',
  STORAGE_KEY: 'lifeledger_data_v3',
  MODULES: ['dashboard', 'goals', 'habits', 'tasks', 'finances', 'journal', 'notes']
};

// Enhanced utilities
const Utils = {
  generateId: () => 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
  
  formatDate: (date = new Date(), format = 'medium') => {
    try {
      const d = new Date(date);
      if (isNaN(d.getTime())) return 'Invalid date';
      
      if (format === 'medium') {
        const day = d.getDate();
        const month = d.toLocaleString('en-US', { month: 'short' });
        const year = d.getFullYear();
        const weekday = d.toLocaleString('en-US', { weekday: 'short' });
        return `${weekday}, ${day} ${month}`;
      }
      
      if (format === 'short') {
        const day = d.getDate();
        const month = d.getMonth() + 1;
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
      }
      
      return d.toLocaleDateString();
    } catch (e) {
      console.error('Date formatting error:', e);
      return new Date().toLocaleDateString();
    }
  },
  
  formatCurrency: (amount) => {
    return '$' + parseFloat(amount || 0).toFixed(2);
  },
  
  showToast: (message, type = 'info', duration = 3000) => {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type ? 'toast-' + type : ''}`;
    toast.innerHTML = `
      <span>${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : type === 'danger' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
      <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100%)';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  },
  
  showModal: (title, content, buttons = []) => {
    const modalHTML = `
      <div class="modal-overlay">
        <div class="modal">
          <div class="modal-header">
            <h3 style="margin:0">${title}</h3>
            <button class="modal-close" onclick="Utils.closeModal()">√ó</button>
          </div>
          <div>${content}</div>
          ${buttons.length > 0 ? `
            <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
              ${buttons.map(btn => `
                <button class="${btn.primary ? 'btn-primary' : ''}" 
                        onclick="${btn.onclick}">${btn.text}</button>
              `).join('')}
            </div>
          ` : ''}
        </div>
      </div>
    `;
    
    const container = document.getElementById('modalContainer');
    container.innerHTML = modalHTML;
    
    // Close on overlay click
    container.querySelector('.modal-overlay').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        Utils.closeModal();
      }
    });
  },
  
  closeModal: () => {
    document.getElementById('modalContainer').innerHTML = '';
  }
};

// Storage manager with auto-save - FIXED VERSION
const Storage = {
  state: null,
  
  loadState: () => {
    try {
      const raw = localStorage.getItem(CONFIG.STORAGE_KEY);
      if (!raw) {
        const defaultState = {
          modules: {
            goals: { list: [] },
            habits: { list: [] },
            tasks: { list: [] },
            finances: { 
              list: [],
              categories: ['Food', 'Transport', 'Entertainment', 'Bills', 'Shopping', 'Other'],
              balance: 0
            },
            journal: { entries: [] },  // FIXED: journal uses entries, not list
            notes: { list: [] }
          },
          customModules: {},
          enabledOrder: CONFIG.MODULES.filter(m => m !== 'dashboard'),
          settings: {
            theme: 'light',
            autoSave: true,
            notifications: true,
            weekStartsMonday: false
          },
          version: CONFIG.VERSION,
          stats: {
            lastActive: new Date().toISOString(),
            totalEntries: 0
          }
        };
        Storage.state = defaultState;
        Storage.saveState();
        return defaultState;
      }
      const parsed = JSON.parse(raw);
      Storage.state = parsed;
      // Ensure customModules exists
      if (!Storage.state.customModules) {
        Storage.state.customModules = {};
      }
      return parsed;
    } catch (e) {
      console.error('Failed to load state:', e);
      return Storage.loadState(); // Return fresh state on error
    }
  },
  
  saveState: () => {
    try {
      if (!Storage.state) return false;
      Storage.state.stats.lastActive = new Date().toISOString();
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(Storage.state));
      
      // Update last saved indicator
      const lastSavedEl = document.getElementById('lastSaved');
      if (lastSavedEl) {
        lastSavedEl.textContent = 'Saved just now';
      }
      
      return true;
    } catch (e) {
      console.error('Failed to save state:', e);
      return false;
    }
  },
  
  getModuleData: (moduleId) => {
    // Check custom modules first
    if (Storage.state.customModules && Storage.state.customModules[moduleId]) {
      return Storage.state.customModules[moduleId];
    }
    
    // Then check built-in modules
    if (!Storage.state.modules[moduleId]) {
      if (moduleId === 'journal') {
        Storage.state.modules[moduleId] = { entries: [] };
      } else {
        Storage.state.modules[moduleId] = { list: [] };
      }
    }
    return Storage.state.modules[moduleId];
  },
  
  updateModuleData: (moduleId, data) => {
    if (Storage.state.customModules && Storage.state.customModules[moduleId]) {
      Storage.state.customModules[moduleId] = data;
    } else {
      Storage.state.modules[moduleId] = data;
    }
    Storage.saveState();
    return data;
  },
  
  addItem: (moduleId, item) => {
    let module;
    let isCustom = false;
    
    if (Storage.state.customModules && Storage.state.customModules[moduleId]) {
      module = Storage.state.customModules[moduleId];
      isCustom = true;
    } else {
      module = Storage.getModuleData(moduleId);
    }
    
    const newItem = {
      id: Utils.generateId(),
      createdAt: new Date().toISOString(),
      ...item
    };
    
    if (moduleId === 'journal') {
      if (!module.entries) module.entries = [];
      module.entries.unshift(newItem);
    } else if (isCustom) {
      if (!module.list) module.list = [];
      module.list.unshift(newItem);
    } else {
      if (!module.list) module.list = [];
      module.list.unshift(newItem);
    }
    
    Storage.saveState();
    
    if (moduleId === 'finances' && item.amount) {
      Storage.state.modules.finances.balance = 
        (Storage.state.modules.finances.balance || 0) + (item.type === 'income' ? item.amount : -item.amount);
    }
    
    Utils.showToast(`${moduleId === 'journal' ? 'Journal entry' : moduleId.slice(0, -1)} added`, 'success');
    return newItem;
  },
  
  updateItem: (moduleId, id, updates) => {
    let collection;
    
    if (Storage.state.customModules && Storage.state.customModules[moduleId]) {
      const module = Storage.state.customModules[moduleId];
      collection = module.list;
    } else {
      const module = Storage.getModuleData(moduleId);
      collection = moduleId === 'journal' ? module.entries : module.list;
    }
    
    if (!collection) return null;
    
    const index = collection.findIndex(item => item.id === id);
    if (index !== -1) {
      collection[index] = { ...collection[index], ...updates };
      Storage.saveState();
      Utils.showToast('Updated', 'success');
      return collection[index];
    }
    return null;
  },
  
  deleteItem: (moduleId, id) => {
    let collection;
    
    if (Storage.state.customModules && Storage.state.customModules[moduleId]) {
      const module = Storage.state.customModules[moduleId];
      collection = module.list;
    } else {
      const module = Storage.getModuleData(moduleId);
      collection = moduleId === 'journal' ? module.entries : module.list;
    }
    
    if (!collection) return null;
    
    const index = collection.findIndex(item => item.id === id);
    if (index !== -1) {
      const [deleted] = collection.splice(index, 1);
      Storage.saveState();
      Utils.showToast('Deleted', 'warning');
      return deleted;
    }
    return null;
  }
};

// Module System - ENHANCED WITH FULL FUNCTIONALITY
const ModuleSystem = (() => {
  let currentModuleId = null;
  let modules = {};
  
  // Register built-in modules with full functionality
  const registerBuiltinModules = () => {
    // Dashboard - Enhanced with real data
    modules.dashboard = {
      name: 'Dashboard',
      icon: 'üìä',
      desc: 'Overview and analytics',
      render: () => {
        const state = Storage.state;
        const goals = state.modules?.goals?.list || [];
        const habits = state.modules?.habits?.list || [];
        const tasks = state.modules?.tasks?.list || [];
        const finances = state.modules?.finances || {};
        
        const completedTasks = tasks.filter(t => t.completed).length;
        const productivity = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;
        
        const activeHabits = habits.filter(h => !h.archived).length;
        const longestStreak = habits.reduce((max, h) => Math.max(max, h.streak || 0), 0);
        
        const totalGoals = goals.length;
        const goalsProgress = goals.length > 0 
          ? goals.reduce((sum, g) => sum + (g.progress || 0), 0) / goals.length 
          : 0;
        
        return `
          <div class="module-header">
            <div>
              <h2 style="margin:0">Dashboard</h2>
              <p class="muted" style="margin-top:4px">Your life at a glance</p>
            </div>
            <button class="btn-primary" onclick="ModuleSystem.refreshModule()">üîÑ Refresh</button>
          </div>
          
          <div class="dashboard">
            <div class="stat-card">
              <div class="stat-value">${totalGoals}</div>
              <div class="stat-label">Active Goals</div>
              <div class="progress" style="margin-top:12px; width:100%">
                <i style="width:${goalsProgress * 100}%"></i>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-value">${activeHabits}</div>
              <div class="stat-label">Daily Habits</div>
              <div class="muted" style="margin-top:8px; font-size:12px">
                ${longestStreak} day streak
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-value">${Utils.formatCurrency(finances.balance || 0)}</div>
              <div class="stat-label">Current Balance</div>
              <div class="muted" style="margin-top:8px; font-size:12px">
                ${finances.list?.filter(t => t.type === 'expense').length || 0} expenses this month
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-value">${productivity}%</div>
              <div class="stat-label">Productivity</div>
              <div class="muted" style="margin-top:8px; font-size:12px">
                ${completedTasks}/${tasks.length} tasks done
              </div>
            </div>
          </div>
          
          <div style="margin-top:32px">
            <div class="module-header">
              <h3 style="margin:0">Quick Actions</h3>
            </div>
            <div class="grid grid-3">
              <div class="card" style="cursor:pointer;text-align:center" onclick="showQuickAdd()">
                <h4 style="margin:0 0 8px 0">‚ö° Quick Add</h4>
                <p class="muted" style="font-size:14px">Add items quickly to any module</p>
              </div>
              <div class="card" style="cursor:pointer;text-align:center" onclick="ModuleSystem.openModule('goals')">
                <h4 style="margin:0 0 8px 0">üéØ Set Goal</h4>
                <p class="muted" style="font-size:14px">Define a new objective</p>
              </div>
              <div class="card" style="cursor:pointer;text-align:center" onclick="ModuleSystem.openModule('tasks')">
                <h4 style="margin:0 0 8px 0">‚úÖ Add Task</h4>
                <p class="muted" style="font-size:14px">Create a new to-do item</p>
              </div>
            </div>
          </div>
          
          <div style="margin-top:32px">
            <div class="module-header">
              <h3 style="margin:0">Recent Activity</h3>
            </div>
            <div id="recentActivity" class="list">
              ${getRecentActivity()}
            </div>
          </div>
        `;
      }
    };
    
    // Goals Module - Full CRUD
    modules.goals = {
      name: 'Goals',
      icon: 'üéØ',
      desc: 'Set and track goals',
      render: () => {
        const goals = Storage.getModuleData('goals').list;
        
        return `
          <div class="module-header">
            <div>
              <h2 style="margin:0">Goals</h2>
              <p class="muted" style="margin-top:4px">Set and track your objectives</p>
            </div>
            <button class="btn-primary" onclick="showGoalForm()">+ Add Goal</button>
          </div>
          
          <div style="margin-top:20px;">
            ${goals.length === 0 ? `
              <div class="empty-state">
                <div class="empty-state-icon">üéØ</div>
                <p>No goals yet</p>
                <button class="btn-primary" onclick="showGoalForm()" style="margin-top:12px;">Add Your First Goal</button>
              </div>
            ` : `
              <div class="list">
                ${goals.map(goal => `
                  <div class="list-item">
                    <div style="flex:1">
                      <div style="display:flex;align-items:center;gap:8px">
                        <input type="checkbox" ${goal.completed ? 'checked' : ''} 
                               onchange="toggleGoalCompletion('${goal.id}', this.checked)"
                               style="cursor:pointer">
                        <div>
                          <div style="font-weight:600;font-size:16px">${goal.title || 'Untitled Goal'}</div>
                          <div class="muted" style="font-size:13px;margin-top:4px">
                            ${goal.description || 'No description'}
                          </div>
                          <div style="display:flex;gap:8px;margin-top:8px">
                            <span class="tag">${goal.category || 'General'}</span>
                            ${goal.dueDate ? `<span class="tag">Due: ${Utils.formatDate(goal.dueDate, 'short')}</span>` : ''}
                          </div>
                        </div>
                      </div>
                    </div>
                    <div style="text-align:right">
                      <div style="font-weight:600;margin-bottom:4px">${Math.round((goal.progress || 0) * 100)}%</div>
                      <div class="progress" style="width:150px">
                        <i style="width:${(goal.progress || 0) * 100}%"></i>
                      </div>
                      <div style="margin-top:8px;display:flex;gap:4px">
                        <button class="small" onclick="editGoal('${goal.id}')">Edit</button>
                        <button class="small btn-danger" onclick="deleteGoal('${goal.id}')">Delete</button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        `;
      }
    };
    
    // Habits Module - Full CRUD with streaks
    modules.habits = {
      name: 'Habits',
      icon: 'üîÑ',
      desc: 'Daily habits and streaks',
      render: () => {
        const habits = Storage.getModuleData('habits').list;
        const today = new Date().toDateString();
        
        return `
          <div class="module-header">
            <div>
              <h2 style="margin:0">Habits</h2>
              <p class="muted" style="margin-top:4px">Track daily routines</p>
            </div>
            <button class="btn-primary" onclick="showHabitForm()">+ Add Habit</button>
          </div>
          
          <div style="margin-top:20px;">
            ${habits.length === 0 ? `
              <div class="empty-state">
                <div class="empty-state-icon">üîÑ</div>
                <p>No habits yet</p>
                <button class="btn-primary" onclick="showHabitForm()" style="margin-top:12px;">Add Your First Habit</button>
              </div>
            ` : `
              <div class="list">
                ${habits.map(habit => {
                  const todayLog = habit.logs?.find(l => new Date(l.date).toDateString() === today);
                  const streak = habit.streak || 0;
                  
                  return `
                    <div class="list-item">
                      <div style="flex:1">
                        <div style="display:flex;align-items:center;gap:12px">
                          <div style="width:40px;height:40px;border-radius:50%;background:${habit.color || 'var(--accent)'};display:grid;place-items:center;color:white;font-weight:bold">
                            ${habit.icon || 'üîÑ'}
                          </div>
                          <div>
                            <div style="font-weight:600;font-size:16px">${habit.name}</div>
                            <div class="muted" style="font-size:13px;margin-top:4px">
                              ${habit.description || 'Daily habit'} ‚Ä¢ Streak: ${streak} days
                            </div>
                            <div style="margin-top:8px">
                              <span class="tag">${habit.frequency || 'Daily'}</span>
                              <span class="tag">${habit.category || 'Health'}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div style="text-align:right">
                        <div style="display:flex;gap:8px;margin-bottom:12px">
                          <button class="small ${todayLog?.status === 'completed' ? 'btn-success' : ''}" 
                                  onclick="logHabit('${habit.id}', 'completed')">
                            ${todayLog?.status === 'completed' ? '‚úì Done' : 'Mark Done'}
                          </button>
                          <button class="small ${todayLog?.status === 'skipped' ? 'btn-warning' : ''}" 
                                  onclick="logHabit('${habit.id}', 'skipped')">
                            ${todayLog?.status === 'skipped' ? '‚úì Skipped' : 'Skip'}
                          </button>
                        </div>
                        <div style="display:flex;gap:4px">
                          <button class="small" onclick="editHabit('${habit.id}')">Edit</button>
                          <button class="small btn-danger" onclick="deleteHabit('${habit.id}')">Delete</button>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        `;
      }
    };
    
    // Tasks Module - Full CRUD with priorities
    modules.tasks = {
      name: 'Tasks',
      icon: '‚úÖ',
      desc: 'Todo list with priorities',
      render: () => {
        const tasks = Storage.getModuleData('tasks').list;
        const pendingTasks = tasks.filter(t => !t.completed);
        const completedTasks = tasks.filter(t => t.completed);
        
        return `
          <div class="module-header">
            <div>
              <h2 style="margin:0">Tasks</h2>
              <p class="muted" style="margin-top:4px">Manage your to-do list</p>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn-primary" onclick="showTaskForm()">+ Add Task</button>
              <button class="small" onclick="clearCompletedTasks()">Clear Completed</button>
            </div>
          </div>
          
          <div style="margin-top:20px;">
            ${tasks.length === 0 ? `
              <div class="empty-state">
                <div class="empty-state-icon">‚úÖ</div>
                <p>No tasks yet</p>
                <button class="btn-primary" onclick="showTaskForm()" style="margin-top:12px;">Add Your First Task</button>
              </div>
            ` : `
              ${pendingTasks.length > 0 ? `
                <h3 style="margin-bottom:12px">Pending (${pendingTasks.length})</h3>
                <div class="list">
                  ${pendingTasks.map(task => `
                    <div class="list-item">
                      <div style="display:flex;align-items:center;gap:12px;flex:1">
                        <input type="checkbox" onchange="toggleTaskCompletion('${task.id}', this.checked)"
                               style="cursor:pointer">
                        <div>
                          <div style="font-weight:600;font-size:16px">${task.title}</div>
                          <div class="muted" style="font-size:13px;margin-top:4px">
                            ${task.description || 'No description'}
                          </div>
                          <div style="display:flex;gap:8px;margin-top:8px">
                            <span class="tag ${task.priority === 'high' ? 'chip-danger' : task.priority === 'medium' ? 'chip-warning' : 'chip-info'}">
                              ${task.priority || 'low'} priority
                            </span>
                            ${task.dueDate ? `
                              <span class="tag ${isOverdue(task.dueDate) ? 'chip-danger' : ''}">
                                Due: ${Utils.formatDate(task.dueDate, 'short')}
                              </span>
                            ` : ''}
                          </div>
                        </div>
                      </div>
                      <div style="display:flex;gap:4px">
                        <button class="small" onclick="editTask('${task.id}')">Edit</button>
                        <button class="small btn-danger" onclick="deleteTask('${task.id}')">Delete</button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              
              ${completedTasks.length > 0 ? `
                <h3 style="margin:24px 0 12px 0">Completed (${completedTasks.length})</h3>
                <div class="list">
                  ${completedTasks.map(task => `
                    <div class="list-item" style="opacity:0.7">
                      <div style="display:flex;align-items:center;gap:12px;flex:1">
                        <input type="checkbox" checked onchange="toggleTaskCompletion('${task.id}', false)"
                               style="cursor:pointer">
                        <div>
                          <div style="text-decoration:line-through;font-weight:600;font-size:16px">${task.title}</div>
                          <div class="muted" style="font-size:13px;margin-top:4px">
                            Completed: ${Utils.formatDate(task.completedAt)}
                          </div>
                        </div>
                      </div>
                      <div style="display:flex;gap:4px">
                        <button class="small" onclick="editTask('${task.id}')">Edit</button>
                        <button class="small btn-danger" onclick="deleteTask('${task.id}')">Delete</button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            `}
          </div>
        `;
      }
    };
    
    // Finances Module - Full CRUD with categories
    modules.finances = {
      name: 'Finances',
      icon: 'üí∞',
      desc: 'Income, expenses, and budget',
      render: () => {
        const finances = Storage.getModuleData('finances');
        const transactions = finances.list || [];
        const categories = finances.categories || [];
        const balance = finances.balance || 0;
        
        const recentTransactions = transactions.slice(0, 10);
        const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + (t.amount || 0), 0);
        const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + (t.amount || 0), 0);
        
        return `
          <div class="module-header">
            <div>
              <h2 style="margin:0">Finances</h2>
              <p class="muted" style="margin-top:4px">Track your money</p>
            </div>
            <button class="btn-primary" onclick="showTransactionForm()">+ Add Transaction</button>
          </div>
          
          <div class="dashboard" style="margin-top:20px">
            <div class="stat-card">
              <div class="stat-value">${Utils.formatCurrency(balance)}</div>
              <div class="stat-label">Current Balance</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${Utils.formatCurrency(income)}</div>
              <div class="stat-label">Total Income</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${Utils.formatCurrency(expenses)}</div>
              <div class="stat-label">Total Expenses</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${transactions.length}</div>
              <div class="stat-label">Transactions</div>
            </div>
          </div>
          
          <div style="margin-top:32px">
            <div class="module-header">
              <h3 style="margin:0">Recent Transactions</h3>
            </div>
            
            ${transactions.length === 0 ? `
              <div class="empty-state">
                <div class="empty-state-icon">üí∞</div>
                <p>No transactions yet</p>
                <button class="btn-primary" onclick="showTransactionForm()" style="margin-top:12px;">Add Your First Transaction</button>
              </div>
            ` : `
              <div class="list">
                ${recentTransactions.map(transaction => `
                  <div class="list-item">
                    <div style="display:flex;align-items:center;gap:12px;flex:1">
                      <div style="width:40px;height:40px;border-radius:50%;background:${transaction.type === 'income' ? 'var(--success)' : 'var(--danger)'};display:grid;place-items:center;color:white;font-weight:bold">
                        ${transaction.type === 'income' ? '‚Üë' : '‚Üì'}
                      </div>
                      <div>
                        <div style="font-weight:600;font-size:16px">${transaction.description || 'No description'}</div>
                        <div class="muted" style="font-size:13px;margin-top:4px">
                          ${Utils.formatDate(transaction.date)} ‚Ä¢ ${transaction.category || 'Uncategorized'}
                        </div>
                      </div>
                    </div>
                    <div style="text-align:right">
                      <div style="font-weight:600;font-size:18px;color:${transaction.type === 'income' ? 'var(--success)' : 'var(--danger)'}">
                        ${transaction.type === 'income' ? '+' : '-'}${Utils.formatCurrency(transaction.amount)}
                      </div>
                      <div style="margin-top:8px;display:flex;gap:4px">
                        <button class="small" onclick="editTransaction('${transaction.id}')">Edit</button>
                        <button class="small btn-danger" onclick="deleteTransaction('${transaction.id}')">Delete</button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
          
          ${transactions.length > 0 ? `
            <div style="margin-top:32px">
              <div class="module-header">
                <h3 style="margin:0">Category Breakdown</h3>
              </div>
              <div class="grid grid-3" style="margin-top:16px">
                ${categories.map(category => {
                  const catTransactions = transactions.filter(t => t.category === category && t.type === 'expense');
                  const total = catTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                  return total > 0 ? `
                    <div class="card">
                      <div style="font-weight:600">${category}</div>
                      <div class="stat-value" style="font-size:24px">${Utils.formatCurrency(total)}</div>
                      <div class="progress" style="margin-top:8px;width:100%">
                        <i style="width:${(total / expenses) * 100 || 0}%"></i>
                      </div>
                      <div class="muted" style="font-size:12px;margin-top:4px">
                        ${catTransactions.length} transactions
                      </div>
                    </div>
                  ` : '';
                }).join('')}
              </div>
            </div>
          ` : ''}
        `;
      }
    };
    
    // Journal Module - Full CRUD with rich text - FIXED VERSION
    modules.journal = {
      name: 'Journal',
      icon: 'üìì',
      desc: 'Daily reflections and notes',
      render: () => {
        const journal = Storage.getModuleData('journal');
        const entries = journal.entries || [];  // FIXED: Using entries, not list
        
        return `
          <div class="module-header">
            <div>
              <h2 style="margin:0">Journal</h2>
              <p class="muted" style="margin-top:4px">Record your thoughts</p>
            </div>
            <button class="btn-primary" onclick="showJournalForm()">+ Add Entry</button>
          </div>
          
          <div style="margin-top:20px;">
            ${entries.length === 0 ? `
              <div class="empty-state">
                <div class="empty-state-icon">üìì</div>
                <p>No journal entries yet</p>
                <button class="btn-primary" onclick="showJournalForm()" style="margin-top:12px;">Write Your First Entry</button>
              </div>
            ` : `
              <div class="list">
                ${entries.map(entry => `
                  <div class="list-item">
                    <div style="flex:1">
                      <div style="display:flex;justify-content:space-between;align-items:flex-start">
                        <div>
                          <div style="font-weight:600;font-size:16px">${entry.title || 'Untitled Entry'}</div>
                          <div class="muted" style="font-size:13px;margin-top:4px">
                            ${Utils.formatDate(entry.date, 'medium')}
                          </div>
                        </div>
                        <div style="display:flex;gap:4px">
                          <span class="tag ${entry.mood || ''}">${entry.mood || 'Neutral'}</span>
                        </div>
                      </div>
                      <div style="margin-top:12px;line-height:1.6">
                        ${(entry.content || '').substring(0, 200)}${entry.content?.length > 200 ? '...' : ''}
                      </div>
                      ${entry.tags?.length > 0 ? `
                        <div style="display:flex;gap:4px;margin-top:12px">
                          ${entry.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                      ` : ''}
                    </div>
                    <div style="display:flex;gap:4px;flex-direction:column">
                      <button class="small" onclick="editJournalEntry('${entry.id}')">Edit</button>
                      <button class="small btn-danger" onclick="deleteJournalEntry('${entry.id}')">Delete</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        `;
      }
    };
    
    // Notes Module - Full CRUD
    modules.notes = {
      name: 'Notes',
      icon: 'üìù',
      desc: 'Quick notes and ideas',
      render: () => {
        const notes = Storage.getModuleData('notes').list;
        
        return `
          <div class="module-header">
            <div>
              <h2 style="margin:0">Notes</h2>
              <p class="muted" style="margin-top:4px">Capture your ideas</p>
            </div>
            <button class="btn-primary" onclick="showNoteForm()">+ Add Note</button>
          </div>
          
          <div style="margin-top:20px;">
            ${notes.length === 0 ? `
              <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <p>No notes yet</p>
                <button class="btn-primary" onclick="showNoteForm()" style="margin-top:12px;">Create Your First Note</button>
              </div>
            ` : `
              <div class="grid grid-2">
                ${notes.map(note => `
                  <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start">
                      <div style="font-weight:600;font-size:16px">${note.title || 'Untitled Note'}</div>
                      <div style="display:flex;gap:4px">
                        <button class="small" onclick="editNote('${note.id}')">Edit</button>
                        <button class="small btn-danger" onclick="deleteNote('${note.id}')">Delete</button>
                      </div>
                    </div>
                    <div class="muted" style="font-size:13px;margin-top:4px">
                      ${Utils.formatDate(note.updatedAt || note.createdAt, 'short')}
                    </div>
                    <div style="margin-top:12px;line-height:1.6">
                      ${note.content || 'No content'}
                    </div>
                    ${note.tags?.length > 0 ? `
                      <div style="display:flex;gap:4px;margin-top:12px">
                        ${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                      </div>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        `;
      }
    };
  };
  
  // Helper functions
  const getRecentActivity = () => {
    const state = Storage.state;
    const activities = [];
    
    // Get recent items from built-in modules
    Object.keys(state.modules).forEach(moduleId => {
      const module = state.modules[moduleId];
      if (moduleId === 'journal') {
        if (module.entries && module.entries.length > 0) {
          const recent = module.entries[0];
          activities.push({
            module: moduleId,
            item: recent,
            date: recent.createdAt || recent.date || new Date().toISOString()
          });
        }
      } else if (module.list && module.list.length > 0) {
        const recent = module.list[0];
        activities.push({
          module: moduleId,
          item: recent,
          date: recent.createdAt || recent.date || new Date().toISOString()
        });
      }
    });
    
    // Get recent items from custom modules
    if (state.customModules) {
      Object.keys(state.customModules).forEach(moduleId => {
        const module = state.customModules[moduleId];
        if (module.list && module.list.length > 0) {
          const recent = module.list[0];
          activities.push({
            module: moduleId,
            item: recent,
            date: recent.createdAt || new Date().toISOString()
          });
        }
      });
    }
    
    // Sort by date
    activities.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (activities.length === 0) {
      return `
        <div class="empty-state">
          <div class="empty-state-icon">üìä</div>
          <p>No activity yet</p>
          <p class="muted" style="margin-top:8px">Start using modules to see activity here</p>
        </div>
      `;
    }
    
    return activities.slice(0, 5).map(activity => {
      const moduleName = modules[activity.module]?.name || activity.module;
      const title = activity.item.title || activity.item.name || activity.item.description || 'New item';
      
      return `
        <div class="list-item">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:40px;height:40px;border-radius:50%;background:var(--glass);display:grid;place-items:center">
              ${modules[activity.module]?.icon || 'üìù'}
            </div>
            <div>
              <div style="font-weight:600">${title}</div>
              <div class="muted" style="font-size:13px">
                Added to ${moduleName} ‚Ä¢ ${Utils.formatDate(activity.date, 'medium')}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  };
  
  const isOverdue = (dueDate) => {
    if (!dueDate) return false;
    return new Date(dueDate) < new Date();
  };
  
  // Render module list in sidebar
  const renderModuleList = () => {
    const modulesListEl = document.getElementById('modulesList');
    if (!modulesListEl) return;
    
    modulesListEl.innerHTML = '';
    
    // Always show dashboard first
    const dashboardItem = document.createElement('div');
    dashboardItem.className = `module-item ${currentModuleId === 'dashboard' ? 'active' : ''}`;
    dashboardItem.innerHTML = `
      <div class="module-title">
        <div class="icon">üìä</div>
        <div>
          <div style="font-weight:600">Dashboard</div>
          <div class="module-meta">Overview & analytics</div>
        </div>
      </div>
    `;
    dashboardItem.onclick = () => openModule('dashboard');
    modulesListEl.appendChild(dashboardItem);
    
    // Show other modules in enabled order
    const enabledOrder = Storage.state.enabledOrder || CONFIG.MODULES.filter(m => m !== 'dashboard');
    enabledOrder.forEach(id => {
      let m = modules[id];
      if (!m) {
        // Check if it's a custom module
        if (Storage.state.customModules && Storage.state.customModules[id]) {
          const customModule = Storage.state.customModules[id];
          m = {
            name: customModule.name,
            icon: customModule.icon,
            desc: customModule.description
          };
        } else {
          return;
        }
      }
      if (id === 'dashboard') return;
      
      const item = document.createElement('div');
      item.className = `module-item ${currentModuleId === id ? 'active' : ''}`;
      
      // Get item count
      let itemCount = 0;
      if (id === 'journal') {
        itemCount = Storage.state.modules.journal?.entries?.length || 0;
      } else if (Storage.state.customModules && Storage.state.customModules[id]) {
        itemCount = Storage.state.customModules[id].list?.length || 0;
      } else {
        itemCount = Storage.state.modules[id]?.list?.length || 0;
      }
      
      item.innerHTML = `
        <div class="module-title">
          <div class="icon">${m.icon}</div>
          <div>
            <div style="font-weight:600">${m.name}</div>
            <div class="module-meta">${m.desc}</div>
          </div>
        </div>
        ${itemCount > 0 ? 
          `<div class="module-badge">${itemCount}</div>` : ''}
      `;
      item.onclick = () => openModule(id);
      modulesListEl.appendChild(item);
    });
  };
  
  // Open a module
  const openModule = (id) => {
    console.log('Opening module:', id);
console.log('Setting active module:', id);
console.log('Current module items:', document.querySelectorAll('.module-item').length);
    
    const moduleAreaEl = document.getElementById('module-area');
    const welcomeView = document.getElementById('welcome-view');
    
    if (!moduleAreaEl) {
      console.error('Module area element not found');
      return;
    }
    
    // Hide welcome view
    if (welcomeView) {
      welcomeView.style.display = 'none';
    }
    
    // Update active state in sidebar
    document.querySelectorAll('.module-item').forEach(item => {
      item.classList.remove('active');
    });
    
    currentModuleId = id;
    
    // Get module content
    let module = modules[id];
    if (!module) {
      // Check if it's a custom module
      if (Storage.state.customModules && Storage.state.customModules[id]) {
        module = {
          name: Storage.state.customModules[id].name,
          icon: Storage.state.customModules[id].icon,
          desc: Storage.state.customModules[id].description,
          render: () => renderCustomModule(id)
        };
      } else {
        moduleAreaEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùì</div>
            <h3>Module Not Found</h3>
            <p class="muted">The module "${id}" doesn't exist.</p>
            <button onclick="ModuleSystem.openModule('dashboard')" class="btn-primary" style="margin-top:16px">
              Return to Dashboard
            </button>
          </div>
        `;
        return;
      }
    }
    
    // Render module content
    moduleAreaEl.innerHTML = `
      <div class="fade-in">
        ${module.render()}
      </div>
    `;
    
    // Update URL
    window.location.hash = `module=${id}`;
  };
  
  // Refresh current module
  const refreshModule = () => {
    if (currentModuleId) {
      openModule(currentModuleId);
    }
  };
  
  // Initialize
  const init = () => {
    Storage.loadState();
    registerBuiltinModules();
    
    // Load custom modules into the module system
    if (Storage.state.customModules) {
      Object.keys(Storage.state.customModules).forEach(moduleId => {
        const customModule = Storage.state.customModules[moduleId];
        modules[moduleId] = {
          name: customModule.name,
          icon: customModule.icon,
          desc: customModule.description,
          render: () => renderCustomModule(moduleId)
        };
      });
    }
    
    renderModuleList();
    
    // Set today's date
    const today = new Date();
    const todayDateEl = document.getElementById('todayDate');
    const todayWeekdayEl = document.getElementById('todayWeekday');
    
    if (todayDateEl) {
      todayDateEl.textContent = Utils.formatDate(today, 'medium');
    }
    if (todayWeekdayEl) {
      todayWeekdayEl.textContent = today.toLocaleDateString('en-US', { weekday: 'long' });
    }
    
    // Check URL hash
    const hash = window.location.hash.replace('#', '');
    if (hash.startsWith('module=')) {
      const moduleId = hash.split('=')[1];
      setTimeout(() => openModule(moduleId), 100);
    }
    
    // Hide loading
    setTimeout(() => {
      const loadingEl = document.getElementById('loading');
      if (loadingEl) {
        loadingEl.style.display = 'none';
      }
    }, 500);
    
    // Auto-save indicator
    setInterval(() => {
      const lastSavedEl = document.getElementById('lastSaved');
      if (lastSavedEl && lastSavedEl.textContent !== 'Saving...') {
        const lastSaveTime = Storage.state.stats?.lastActive;
        if (lastSaveTime) {
          const diff = Math.floor((new Date() - new Date(lastSaveTime)) / 1000 / 60);
          if (diff < 1) lastSavedEl.textContent = 'Saved just now';
          else if (diff < 60) lastSavedEl.textContent = `Saved ${diff} min ago`;
          else lastSavedEl.textContent = `Saved ${Math.floor(diff / 60)} hours ago`;
        }
      }
    }, 30000);
  };
  
  return {
    init,
    openModule,
    refreshModule,
renderModuleList,
    getState: () => ({ ...Storage.state }),
    saveState: () => Storage.saveState(),
    modules: modules  // Expose modules for external use
  };
})();

// ==================== FORM FUNCTIONS ====================

// Goals
function showGoalForm(goalId = null) {
  const goal = goalId ? Storage.getModuleData('goals').list.find(g => g.id === goalId) : null;
  
  const formHTML = `
    <div style="display:flex;flex-direction:column;gap:16px">
      <div>
        <label>Goal Title</label>
        <input type="text" id="goalTitle" placeholder="What do you want to achieve?" 
               value="${goal?.title || ''}" style="width:100%">
      </div>
      <div>
        <label>Description</label>
        <textarea id="goalDescription" placeholder="Describe your goal..." 
                  style="width:100%;min-height:80px">${goal?.description || ''}</textarea>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Category</label>
          <input type="text" id="goalCategory" placeholder="e.g., Health, Career, Personal" 
                 value="${goal?.category || ''}" style="width:100%">
        </div>
        <div style="flex:1">
          <label>Progress (0-100%)</label>
          <input type="number" id="goalProgress" min="0" max="100" 
                 value="${goal ? Math.round((goal.progress || 0) * 100) : '0'}" style="width:100%">
        </div>
      </div>
      <div>
        <label>Due Date (Optional)</label>
        <input type="date" id="goalDueDate" value="${goal?.dueDate?.split('T')[0] || ''}" style="width:100%">
      </div>
    </div>
  `;
  
  Utils.showModal(
    goalId ? 'Edit Goal' : 'Add New Goal',
    formHTML,
    [
      {
        text: 'Cancel',
        onclick: 'Utils.closeModal()'
      },
      {
        text: goalId ? 'Update' : 'Create',
        primary: true,
        onclick: goalId ? 
          `saveGoalEdit('${goalId}')` : 
          `createGoal()`
      }
    ]
  );
}

function createGoal() {
  const title = document.getElementById('goalTitle').value;
  if (!title) {
    Utils.showToast('Please enter a goal title', 'warning');
    return;
  }
  
  const goal = {
    title,
    description: document.getElementById('goalDescription').value,
    category: document.getElementById('goalCategory').value || 'General',
    progress: parseInt(document.getElementById('goalProgress').value) / 100,
    dueDate: document.getElementById('goalDueDate').value || null,
    completed: false
  };
  
  Storage.addItem('goals', goal);
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function saveGoalEdit(goalId) {
  const title = document.getElementById('goalTitle').value;
  if (!title) {
    Utils.showToast('Please enter a goal title', 'warning');
    return;
  }
  
  const updates = {
    title,
    description: document.getElementById('goalDescription').value,
    category: document.getElementById('goalCategory').value || 'General',
    progress: parseInt(document.getElementById('goalProgress').value) / 100,
    dueDate: document.getElementById('goalDueDate').value || null,
    updatedAt: new Date().toISOString()
  };
  
  Storage.updateItem('goals', goalId, updates);
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function toggleGoalCompletion(goalId, completed) {
  const updates = {
    completed,
    progress: completed ? 1 : 0,
    completedAt: completed ? new Date().toISOString() : null
  };
  
  Storage.updateItem('goals', goalId, updates);
  setTimeout(() => ModuleSystem.refreshModule(), 100);
}

function editGoal(goalId) {
  showGoalForm(goalId);
}

function deleteGoal(goalId) {
  if (confirm('Are you sure you want to delete this goal?')) {
    Storage.deleteItem('goals', goalId);
    ModuleSystem.refreshModule();
  }
}

// Habits
function showHabitForm(habitId = null) {
  const habit = habitId ? Storage.getModuleData('habits').list.find(h => h.id === habitId) : null;
  
  const formHTML = `
    <div style="display:flex;flex-direction:column;gap:16px">
      <div>
        <label>Habit Name</label>
        <input type="text" id="habitName" placeholder="e.g., Morning Exercise" 
               value="${habit?.name || ''}" style="width:100%">
      </div>
      <div>
        <label>Description</label>
        <textarea id="habitDescription" placeholder="Describe your habit..." 
                  style="width:100%;min-height:80px">${habit?.description || ''}</textarea>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Category</label>
          <select id="habitCategory" style="width:100%">
            <option value="Health" ${habit?.category === 'Health' ? 'selected' : ''}>Health</option>
            <option value="Productivity" ${habit?.category === 'Productivity' ? 'selected' : ''}>Productivity</option>
            <option value="Learning" ${habit?.category === 'Learning' ? 'selected' : ''}>Learning</option>
            <option value="Social" ${habit?.category === 'Social' ? 'selected' : ''}>Social</option>
            <option value="Other" ${habit?.category === 'Other' ? 'selected' : ''}>Other</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Frequency</label>
          <select id="habitFrequency" style="width:100%">
            <option value="Daily" ${habit?.frequency === 'Daily' ? 'selected' : ''}>Daily</option>
            <option value="Weekly" ${habit?.frequency === 'Weekly' ? 'selected' : ''}>Weekly</option>
            <option value="Weekdays" ${habit?.frequency === 'Weekdays' ? 'selected' : ''}>Weekdays</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Icon</label>
          <input type="text" id="habitIcon" placeholder="Emoji, e.g., üèÉ‚Äç‚ôÇÔ∏è" 
                 value="${habit?.icon || 'üîÑ'}" style="width:100%">
        </div>
        <div style="flex:1">
          <label>Color</label>
          <input type="color" id="habitColor" value="${habit?.color || '#2563eb'}" style="width:100%">
        </div>
      </div>
    </div>
  `;
  
  Utils.showModal(
    habitId ? 'Edit Habit' : 'Add New Habit',
    formHTML,
    [
      {
        text: 'Cancel',
        onclick: 'Utils.closeModal()'
      },
      {
        text: habitId ? 'Update' : 'Create',
        primary: true,
        onclick: habitId ? 
          `saveHabitEdit('${habitId}')` : 
          `createHabit()`
      }
    ]
  );
}

function createHabit() {
  const name = document.getElementById('habitName').value;
  if (!name) {
    Utils.showToast('Please enter a habit name', 'warning');
    return;
  }
  
  const habit = {
    name,
    description: document.getElementById('habitDescription').value,
    category: document.getElementById('habitCategory').value,
    frequency: document.getElementById('habitFrequency').value,
    icon: document.getElementById('habitIcon').value || 'üîÑ',
    color: document.getElementById('habitColor').value,
    streak: 0,
    logs: [],
    archived: false
  };
  
  Storage.addItem('habits', habit);
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function saveHabitEdit(habitId) {
  const name = document.getElementById('habitName').value;
  if (!name) {
    Utils.showToast('Please enter a habit name', 'warning');
    return;
  }
  
  const updates = {
    name,
    description: document.getElementById('habitDescription').value,
    category: document.getElementById('habitCategory').value,
    frequency: document.getElementById('habitFrequency').value,
    icon: document.getElementById('habitIcon').value || 'üîÑ',
    color: document.getElementById('habitColor').value,
    updatedAt: new Date().toISOString()
  };
  
  Storage.updateItem('habits', habitId, updates);
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function logHabit(habitId, status) {
  const habit = Storage.getModuleData('habits').list.find(h => h.id === habitId);
  if (!habit) return;
  
  const today = new Date().toDateString();
  const logs = habit.logs || [];
  const todayLogIndex = logs.findIndex(l => new Date(l.date).toDateString() === today);
  
  if (todayLogIndex !== -1) {
    logs[todayLogIndex].status = status;
  } else {
    logs.push({
      date: new Date().toISOString(),
      status
    });
  }
  
  // Update streak
  let streak = habit.streak || 0;
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayLog = logs.find(l => new Date(l.date).toDateString() === yesterday.toDateString());
  
  if (status === 'completed') {
    if (yesterdayLog?.status === 'completed') {
      streak++;
    } else {
      streak = 1;
    }
  }
  
  const updates = {
    logs,
    streak,
    updatedAt: new Date().toISOString()
  };
  
  Storage.updateItem('habits', habitId, updates);
  ModuleSystem.refreshModule();
}

function editHabit(habitId) {
  showHabitForm(habitId);
}

function deleteHabit(habitId) {
  if (confirm('Are you sure you want to delete this habit?')) {
    Storage.deleteItem('habits', habitId);
    ModuleSystem.refreshModule();
  }
}

// Tasks
function showTaskForm(taskId = null) {
  const task = taskId ? Storage.getModuleData('tasks').list.find(t => t.id === taskId) : null;
  
  const formHTML = `
    <div style="display:flex;flex-direction:column;gap:16px">
      <div>
        <label>Task Title</label>
        <input type="text" id="taskTitle" placeholder="What needs to be done?" 
               value="${task?.title || ''}" style="width:100%">
      </div>
      <div>
        <label>Description (Optional)</label>
        <textarea id="taskDescription" placeholder="Add details..." 
                  style="width:100%;min-height:80px">${task?.description || ''}</textarea>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Priority</label>
          <select id="taskPriority" style="width:100%">
            <option value="low" ${task?.priority === 'low' ? 'selected' : ''}>Low</option>
            <option value="medium" ${task?.priority === 'medium' ? 'selected' : ''}>Medium</option>
            <option value="high" ${task?.priority === 'high' ? 'selected' : ''}>High</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Due Date</label>
          <input type="date" id="taskDueDate" value="${task?.dueDate?.split('T')[0] || ''}" style="width:100%">
        </div>
      </div>
      <div>
        <label>Category</label>
        <input type="text" id="taskCategory" placeholder="e.g., Work, Personal, Errands" 
               value="${task?.category || ''}" style="width:100%">
      </div>
    </div>
  `;
  
  Utils.showModal(
    taskId ? 'Edit Task' : 'Add New Task',
    formHTML,
    [
      {
        text: 'Cancel',
        onclick: 'Utils.closeModal()'
      },
      {
        text: taskId ? 'Update' : 'Create',
        primary: true,
        onclick: taskId ? 
          `saveTaskEdit('${taskId}')` : 
          `createTask()`
      }
    ]
  );
}

function createTask() {
  const title = document.getElementById('taskTitle').value;
  if (!title) {
    Utils.showToast('Please enter a task title', 'warning');
    return;
  }
  
  const task = {
    title,
    description: document.getElementById('taskDescription').value,
    priority: document.getElementById('taskPriority').value,
    dueDate: document.getElementById('taskDueDate').value || null,
    category: document.getElementById('taskCategory').value || 'General',
    completed: false,
    createdAt: new Date().toISOString()
  };
  
  Storage.addItem('tasks', task);
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function saveTaskEdit(taskId) {
  const title = document.getElementById('taskTitle').value;
  if (!title) {
    Utils.showToast('Please enter a task title', 'warning');
    return;
  }
  
  const updates = {
    title,
    description: document.getElementById('taskDescription').value,
    priority: document.getElementById('taskPriority').value,
    dueDate: document.getElementById('taskDueDate').value || null,
    category: document.getElementById('taskCategory').value || 'General',
    updatedAt: new Date().toISOString()
  };
  
  Storage.updateItem('tasks', taskId, updates);
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function toggleTaskCompletion(taskId, completed) {
  const updates = {
    completed,
    completedAt: completed ? new Date().toISOString() : null
  };
  
  Storage.updateItem('tasks', taskId, updates);
  setTimeout(() => ModuleSystem.refreshModule(), 100);
}

function editTask(taskId) {
  showTaskForm(taskId);
}

function deleteTask(taskId) {
  if (confirm('Are you sure you want to delete this task?')) {
    Storage.deleteItem('tasks', taskId);
    ModuleSystem.refreshModule();
  }
}

function clearCompletedTasks() {
  if (confirm('Clear all completed tasks?')) {
    const tasks = Storage.getModuleData('tasks');
    tasks.list = tasks.list.filter(t => !t.completed);
    Storage.updateModuleData('tasks', tasks);
    ModuleSystem.refreshModule();
  }
}

// Finances
function showTransactionForm(transactionId = null) {
  const transaction = transactionId ? 
    Storage.getModuleData('finances').list.find(t => t.id === transactionId) : null;
  const categories = Storage.getModuleData('finances').categories || [];
  
  const formHTML = `
    <div style="display:flex;flex-direction:column;gap:16px">
      <div>
        <label>Description</label>
        <input type="text" id="transactionDescription" placeholder="What was this for?" 
               value="${transaction?.description || ''}" style="width:100%">
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Type</label>
          <select id="transactionType" style="width:100%">
            <option value="income" ${transaction?.type === 'income' ? 'selected' : ''}>Income</option>
            <option value="expense" ${transaction?.type === 'expense' ? 'selected' : ''}>Expense</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Amount</label>
          <input type="number" id="transactionAmount" min="0" step="0.01" 
                 value="${transaction?.amount || ''}" placeholder="0.00" style="width:100%">
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Category</label>
          <select id="transactionCategory" style="width:100%">
            <option value="">Select category</option>
            ${categories.map(cat => `
              <option value="${cat}" ${transaction?.category === cat ? 'selected' : ''}>${cat}</option>
            `).join('')}
            <option value="Other">Other</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Date</label>
          <input type="date" id="transactionDate" 
                 value="${transaction?.date?.split('T')[0] || new Date().toISOString().split('T')[0]}" 
                 style="width:100%">
        </div>
      </div>
      <div>
        <label>Notes (Optional)</label>
        <textarea id="transactionNotes" placeholder="Additional details..." 
                  style="width:100%;min-height:60px">${transaction?.notes || ''}</textarea>
      </div>
    </div>
  `;
  
  Utils.showModal(
    transactionId ? 'Edit Transaction' : 'Add New Transaction',
    formHTML,
    [
      {
        text: 'Cancel',
        onclick: 'Utils.closeModal()'
      },
      {
        text: transactionId ? 'Update' : 'Add',
        primary: true,
        onclick: transactionId ? 
          `saveTransactionEdit('${transactionId}')` : 
          `createTransaction()`
      }
    ]
  );
}

function createTransaction() {
  const description = document.getElementById('transactionDescription').value;
  const amount = parseFloat(document.getElementById('transactionAmount').value);
  
  if (!description) {
    Utils.showToast('Please enter a description', 'warning');
    return;
  }
  
  if (!amount || amount <= 0) {
    Utils.showToast('Please enter a valid amount', 'warning');
    return;
  }
  
  const transaction = {
    description,
    type: document.getElementById('transactionType').value,
    amount,
    category: document.getElementById('transactionCategory').value || 'Other',
    date: document.getElementById('transactionDate').value || new Date().toISOString(),
    notes: document.getElementById('transactionNotes').value
  };
  
  Storage.addItem('finances', transaction);
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function saveTransactionEdit(transactionId) {
  const description = document.getElementById('transactionDescription').value;
  const amount = parseFloat(document.getElementById('transactionAmount').value);
  
  if (!description) {
    Utils.showToast('Please enter a description', 'warning');
    return;
  }
  
  if (!amount || amount <= 0) {
    Utils.showToast('Please enter a valid amount', 'warning');
    return;
  }
  
  const updates = {
    description,
    type: document.getElementById('transactionType').value,
    amount,
    category: document.getElementById('transactionCategory').value || 'Other',
    date: document.getElementById('transactionDate').value || new Date().toISOString(),
    notes: document.getElementById('transactionNotes').value,
    updatedAt: new Date().toISOString()
  };
  
  Storage.updateItem('finances', transactionId, updates);
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function editTransaction(transactionId) {
  showTransactionForm(transactionId);
}

function deleteTransaction(transactionId) {
  if (confirm('Are you sure you want to delete this transaction?')) {
    Storage.deleteItem('finances', transactionId);
    ModuleSystem.refreshModule();
  }
}

// Journal - FIXED VERSION
function showJournalForm(entryId = null) {
  const journal = Storage.getModuleData('journal');
  const entry = entryId ? journal.entries.find(e => e.id === entryId) : null;  // FIXED: Using entries
  
  const formHTML = `
    <div style="display:flex;flex-direction:column;gap:16px">
      <div>
        <label>Title</label>
        <input type="text" id="journalTitle" placeholder="How was your day?" 
               value="${entry?.title || ''}" style="width:100%">
      </div>
      <div>
        <label>Content</label>
        <textarea id="journalContent" placeholder="Write your thoughts..." 
                  style="width:100%;min-height:150px">${entry?.content || ''}</textarea>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Date</label>
          <input type="date" id="journalDate" 
                 value="${entry?.date?.split('T')[0] || new Date().toISOString().split('T')[0]}" 
                 style="width:100%">
        </div>
        <div style="flex:1">
          <label>Mood</label>
          <select id="journalMood" style="width:100%">
            <option value="">Select mood</option>
            <option value="Great" ${entry?.mood === 'Great' ? 'selected' : ''}>üòä Great</option>
            <option value="Good" ${entry?.mood === 'Good' ? 'selected' : ''}>üôÇ Good</option>
            <option value="Neutral" ${entry?.mood === 'Neutral' ? 'selected' : ''}>üòê Neutral</option>
            <option value="Bad" ${entry?.mood === 'Bad' ? 'selected' : ''}>üòî Bad</option>
            <option value="Awful" ${entry?.mood === 'Awful' ? 'selected' : ''}>üòû Awful</option>
          </select>
        </div>
      </div>
      <div>
        <label>Tags (comma separated)</label>
        <input type="text" id="journalTags" placeholder="work, personal, reflection" 
               value="${entry?.tags?.join(', ') || ''}" style="width:100%">
      </div>
    </div>
  `;
  
  Utils.showModal(
    entryId ? 'Edit Journal Entry' : 'Add Journal Entry',
    formHTML,
    [
      {
        text: 'Cancel',
        onclick: 'Utils.closeModal()'
      },
      {
        text: entryId ? 'Update' : 'Save',
        primary: true,
        onclick: entryId ? 
          `saveJournalEdit('${entryId}')` : 
          `createJournalEntry()`
      }
    ]
  );
}

function createJournalEntry() {
  const title = document.getElementById('journalTitle').value;
  const content = document.getElementById('journalContent').value;
  
  if (!content) {
    Utils.showToast('Please write something', 'warning');
    return;
  }
  
  const entry = {
    title: title || 'Untitled Entry',
    content,
    date: document.getElementById('journalDate').value || new Date().toISOString(),
    mood: document.getElementById('journalMood').value || 'Neutral',
    tags: document.getElementById('journalTags').value?.split(',').map(t => t.trim()).filter(t => t) || []
  };
  
  Storage.addItem('journal', entry);
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function saveJournalEdit(entryId) {
  const title = document.getElementById('journalTitle').value;
  const content = document.getElementById('journalContent').value;
  
  if (!content) {
    Utils.showToast('Please write something', 'warning');
    return;
  }
  
  const updates = {
    title: title || 'Untitled Entry',
    content,
    date: document.getElementById('journalDate').value || new Date().toISOString(),
    mood: document.getElementById('journalMood').value || 'Neutral',
    tags: document.getElementById('journalTags').value?.split(',').map(t => t.trim()).filter(t => t) || [],
    updatedAt: new Date().toISOString()
  };
  
  Storage.updateItem('journal', entryId, updates);
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function editJournalEntry(entryId) {
  showJournalForm(entryId);
}

function deleteJournalEntry(entryId) {
  if (confirm('Are you sure you want to delete this journal entry?')) {
    Storage.deleteItem('journal', entryId);
    ModuleSystem.refreshModule();
  }
}

// Notes
function showNoteForm(noteId = null) {
  const note = noteId ? Storage.getModuleData('notes').list.find(n => n.id === noteId) : null;
  
  const formHTML = `
    <div style="display:flex;flex-direction:column;gap:16px">
      <div>
        <label>Title</label>
        <input type="text" id="noteTitle" placeholder="Note title" 
               value="${note?.title || ''}" style="width:100%">
      </div>
      <div>
        <label>Content</label>
        <textarea id="noteContent" placeholder="Write your note..." 
                  style="width:100%;min-height:150px">${note?.content || ''}</textarea>
      </div>
      <div>
        <label>Tags (comma separated)</label>
        <input type="text" id="noteTags" placeholder="ideas, todo, reference" 
               value="${note?.tags?.join(', ') || ''}" style="width:100%">
      </div>
    </div>
  `;
  
  Utils.showModal(
    noteId ? 'Edit Note' : 'Add Note',
    formHTML,
    [
      {
        text: 'Cancel',
        onclick: 'Utils.closeModal()'
      },
      {
        text: noteId ? 'Update' : 'Save',
        primary: true,
        onclick: noteId ? 
          `saveNoteEdit('${noteId}')` : 
          `createNote()`
      }
    ]
  );
}

function createNote() {
  const title = document.getElementById('noteTitle').value;
  const content = document.getElementById('noteContent').value;
  
  if (!content && !title) {
    Utils.showToast('Please add some content or a title', 'warning');
    return;
  }
  
  const note = {
    title: title || 'Untitled Note',
    content,
    tags: document.getElementById('noteTags').value?.split(',').map(t => t.trim()).filter(t => t) || []
  };
  
  Storage.addItem('notes', note);
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function saveNoteEdit(noteId) {
  const title = document.getElementById('noteTitle').value;
  const content = document.getElementById('noteContent').value;
  
  if (!content && !title) {
    Utils.showToast('Please add some content or a title', 'warning');
    return;
  }
  
  const updates = {
    title: title || 'Untitled Note',
    content,
    tags: document.getElementById('noteTags').value?.split(',').map(t => t.trim()).filter(t => t) || [],
    updatedAt: new Date().toISOString()
  };
  
  Storage.updateItem('notes', noteId, updates);
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function editNote(noteId) {
  showNoteForm(noteId);
}

function deleteNote(noteId) {
  if (confirm('Are you sure you want to delete this note?')) {
    Storage.deleteItem('notes', noteId);
    ModuleSystem.refreshModule();
  }
}

// ==================== TODAY'S SUMMARY ====================
function showTodaysSummary() {
  const today = new Date().toISOString().split('T')[0];
  const state = Storage.state;
  
  // Get today's journal entries
  const journalEntries = (state.modules.journal?.entries || [])
    .filter(entry => entry.date?.startsWith(today));
  
  // Get today's completed habits
  const habits = state.modules.habits?.list || [];
  const todaysHabits = habits.filter(habit => {
    const logs = habit.logs || [];
    return logs.some(log => log.date?.startsWith(today) && log.status === 'completed');
  });
  
  // Get today's completed tasks
  const tasks = state.modules.tasks?.list || [];
  const todaysTasks = tasks.filter(task => 
    task.completed && task.completedAt?.startsWith(today)
  );
  
  // Get today's transactions
  const transactions = state.modules.finances?.list || [];
  const todaysTransactions = transactions.filter(trx => 
    trx.date?.startsWith(today)
  );
  
  const incomeToday = todaysTransactions
    .filter(t => t.type === 'income')
    .reduce((sum, t) => sum + (t.amount || 0), 0);
  
  const expensesToday = todaysTransactions
    .filter(t => t.type === 'expense')
    .reduce((sum, t) => sum + (t.amount || 0), 0);
  
  const content = `
    <div style="display:flex;flex-direction:column;gap:20px;max-height:70vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Today's Summary</h3>
        <span class="chip">${Utils.formatDate(new Date(), 'medium')}</span>
      </div>
      
      <div class="dashboard">
        <div class="stat-card">
          <div class="stat-value">${todaysTasks.length}</div>
          <div class="stat-label">Tasks Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${todaysHabits.length}</div>
          <div class="stat-label">Habits Done</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${Utils.formatCurrency(incomeToday)}</div>
          <div class="stat-label">Income Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${Utils.formatCurrency(expensesToday)}</div>
          <div class="stat-label">Expenses Today</div>
        </div>
      </div>
      
      ${journalEntries.length > 0 ? `
        <div class="settings-group">
          <h4 style="margin:0 0 12px 0">üìì Journal Entries (${journalEntries.length})</h4>
          <div class="list">
            ${journalEntries.slice(0, 3).map(entry => `
              <div class="list-item">
                <div style="flex:1">
                  <div style="font-weight:600">${entry.title || 'Untitled'}</div>
                  <div class="muted" style="font-size:13px;margin-top:4px">
                    ${(entry.content || '').substring(0, 100)}${entry.content?.length > 100 ? '...' : ''}
                  </div>
                  ${entry.mood ? `<span class="tag" style="margin-top:8px">${entry.mood}</span>` : ''}
                </div>
                <button class="small" onclick="editJournalEntry('${entry.id}'); Utils.closeModal()">
                  View
                </button>
              </div>
            `).join('')}
          </div>
          ${journalEntries.length > 3 ? 
            `<p class="muted" style="text-align:center;margin-top:8px">+ ${journalEntries.length - 3} more entries</p>` : ''}
        </div>
      ` : ''}
      
      ${todaysHabits.length > 0 ? `
        <div class="settings-group">
          <h4 style="margin:0 0 12px 0">üîÑ Habits Completed (${todaysHabits.length})</h4>
          <div style="display:flex;flex-wrap:wrap;gap:8px">
            ${todaysHabits.map(habit => `
              <span class="chip" style="display:flex;align-items:center;gap:4px">
                ${habit.icon || 'üîÑ'} ${habit.name}
              </span>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      ${todaysTasks.length > 0 ? `
        <div class="settings-group">
          <h4 style="margin:0 0 12px 0">‚úÖ Tasks Completed (${todaysTasks.length})</h4>
          <div class="list">
            ${todaysTasks.slice(0, 5).map(task => `
              <div class="list-item">
                <div style="flex:1">
                  <div style="font-weight:600">${task.title}</div>
                  ${task.category ? `<span class="tag" style="margin-top:4px">${task.category}</span>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      ${todaysTransactions.length > 0 ? `
        <div class="settings-group">
          <h4 style="margin:0 0 12px 0">üí∞ Transactions (${todaysTransactions.length})</h4>
          <div class="list">
            ${todaysTransactions.slice(0, 5).map(trx => `
              <div class="list-item">
                <div style="display:flex;align-items:center;gap:12px;flex:1">
                  <div style="color:${trx.type === 'income' ? 'var(--success)' : 'var(--danger)'};font-weight:bold">
                    ${trx.type === 'income' ? '‚Üë' : '‚Üì'}
                  </div>
                  <div>
                    <div style="font-weight:600">${trx.description || 'Transaction'}</div>
                    <div class="muted" style="font-size:13px">${trx.category || 'Uncategorized'}</div>
                  </div>
                </div>
                <div style="color:${trx.type === 'income' ? 'var(--success)' : 'var(--danger)'};font-weight:600">
                  ${trx.type === 'income' ? '+' : '-'}${Utils.formatCurrency(trx.amount)}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      ${todaysTasks.length === 0 && todaysHabits.length === 0 && todaysTransactions.length === 0 && journalEntries.length === 0 ? `
        <div class="empty-state">
          <div class="empty-state-icon">üìÖ</div>
          <p>Nothing recorded yet today</p>
          <p class="muted" style="margin-top:8px">Start adding items to see your daily summary!</p>
        </div>
      ` : ''}
    </div>
  `;
  
  Utils.showModal(
    'Today\'s Summary',
    content,
    [
      {
        text: 'Close',
        onclick: 'Utils.closeModal()'
      },
      {
        text: 'Add Journal Entry',
        primary: true,
        onclick: 'showJournalForm(); Utils.closeModal()'
      }
    ]
  );
}

// ==================== CUSTOM MODULES ====================
function showAddModuleForm() {
  const formHTML = `
    <div style="display:flex;flex-direction:column;gap:16px">
      <div>
        <label>Module Name</label>
        <input type="text" id="moduleName" placeholder="e.g., Projects, Books, Movies" style="width:100%">
      </div>
      <div>
        <label>Description</label>
        <input type="text" id="moduleDescription" placeholder="What does this module track?" style="width:100%">
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Icon</label>
          <input type="text" id="moduleIcon" placeholder="Emoji, e.g., üìö" value="üì¶" style="width:100%">
        </div>
        <div style="flex:1">
          <label>Color</label>
          <input type="color" id="moduleColor" value="#3b82f6" style="width:100%">
        </div>
      </div>
      <div>
        <label>Fields (comma separated, "title" and "description" will be added automatically)</label>
        <input type="text" id="moduleFields" placeholder="category,dueDate,priority" style="width:100%">
        <p class="muted" style="font-size:12px;margin-top:4px">Example: category,dueDate,priority</p>
      </div>
    </div>
  `;
  
  Utils.showModal(
    'Add Custom Module',
    formHTML,
    [
      {
        text: 'Cancel',
        onclick: 'Utils.closeModal()'
      },
      {
        text: 'Create Module',
        primary: true,
        onclick: 'createCustomModule()'
      }
    ]
  );
}

function createCustomModule() {
  const name = document.getElementById('moduleName').value;
  const description = document.getElementById('moduleDescription').value;
  const icon = document.getElementById('moduleIcon').value || 'üì¶';
  const color = document.getElementById('moduleColor').value;
  const fields = document.getElementById('moduleFields').value
    .split(',')
    .map(f => f.trim())
    .filter(f => f && f !== 'title' && f !== 'description' && f !== 'createdAt');
  
  if (!name) {
    Utils.showToast('Please enter a module name', 'warning');
    return;
  }
  
  // Create module ID from name
  const moduleId = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
  
  // Check if module already exists
  if (Storage.state.modules[moduleId] || (Storage.state.customModules && Storage.state.customModules[moduleId])) {
    Utils.showToast('Module with this name already exists', 'warning');
    return;
  }
  
  // Add to custom modules in state
  if (!Storage.state.customModules) {
    Storage.state.customModules = {};
  }
  
  Storage.state.customModules[moduleId] = {
    name,
    description,
    icon,
    color,
    fields: ['title', 'description', ...fields, 'createdAt'],
    list: []
  };
  
  // Add to enabled order
  if (!Storage.state.enabledOrder) {
    Storage.state.enabledOrder = CONFIG.MODULES.filter(m => m !== 'dashboard');
  }
  
  if (!Storage.state.enabledOrder.includes(moduleId)) {
    Storage.state.enabledOrder.push(moduleId);
  }
  
  // Register the module dynamically
  ModuleSystem.modules[moduleId] = {
    name,
    icon,
    desc: description,
    render: () => renderCustomModule(moduleId)
  };
  
  Storage.saveState();
  
  // FIX: Open the module FIRST, then refresh sidebar
  ModuleSystem.openModule(moduleId);
  
  // Now refresh sidebar (which will highlight the active module)
  if (ModuleSystem.renderModuleList) {
    ModuleSystem.renderModuleList();
  }
  
  Utils.showToast(`Module "${name}" created!`, 'success');
  Utils.closeModal();
}

function renderCustomModule(moduleId) {
  const module = Storage.state.customModules[moduleId];
  const items = module.list || [];
  
  return `
    <div class="module-header">
      <div>
        <h2 style="margin:0">${module.name}</h2>
        <p class="muted" style="margin-top:4px">${module.description}</p>
      </div>
      <button class="btn-primary" onclick="showAddCustomItem('${moduleId}')">+ Add Item</button>
    </div>
    
    <div style="margin-top:20px;">
      ${items.length === 0 ? `
        <div class="empty-state">
          <div class="empty-state-icon">${module.icon}</div>
          <p>No items yet in ${module.name}</p>
          <button class="btn-primary" onclick="showAddCustomItem('${moduleId}')" style="margin-top:12px">
            Add Your First Item
          </button>
        </div>
      ` : `
        <div class="grid grid-2">
          ${items.map(item => `
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:flex-start">
                <div style="font-weight:600;font-size:16px">${item.title || 'Untitled'}</div>
                <div style="display:flex;gap:4px">
                  <button class="small" onclick="editCustomItem('${moduleId}', '${item.id}')">Edit</button>
                  <button class="small btn-danger" onclick="deleteCustomItem('${moduleId}', '${item.id}')">Delete</button>
                </div>
              </div>
              ${item.description ? `
                <div style="margin-top:8px;line-height:1.5">${item.description}</div>
              ` : ''}
              <div style="display:flex;gap:4px;margin-top:12px;flex-wrap:wrap">
                ${module.fields.filter(f => f !== 'title' && f !== 'description' && f !== 'createdAt').map(field => {
                  if (item[field]) {
                    return `<span class="tag">${field}: ${item[field]}</span>`;
                  }
                  return '';
                }).join('')}
              </div>
              <div class="muted" style="font-size:12px;margin-top:8px">
                ${Utils.formatDate(item.createdAt, 'short')}
              </div>
            </div>
          `).join('')}
        </div>
      `}
    </div>
  `;
}

function showAddCustomItem(moduleId, itemId = null) {
  const module = Storage.state.customModules[moduleId];
  const item = itemId ? module.list.find(i => i.id === itemId) : null;
  
  // Build form fields based on module definition
  const fieldInputs = module.fields.map(field => {
    if (field === 'createdAt') return '';
    
    const value = item ? (item[field] || '') : '';
    const placeholder = field === 'title' ? 'Enter title' : `Enter ${field}`;
    
    if (field === 'description') {
      return `
        <div>
          <label>${field.charAt(0).toUpperCase() + field.slice(1)}</label>
          <textarea id="${field}" placeholder="${placeholder}" 
                    style="width:100%;min-height:80px">${value}</textarea>
        </div>
      `;
    }
    
    return `
      <div>
        <label>${field.charAt(0).toUpperCase() + field.slice(1)}</label>
        <input type="text" id="${field}" placeholder="${placeholder}" 
               value="${value}" style="width:100%">
      </div>
    `;
  }).join('');
  
  const formHTML = `
    <div style="display:flex;flex-direction:column;gap:16px">
      ${fieldInputs}
    </div>
  `;
  
  Utils.showModal(
    itemId ? `Edit ${module.name} Item` : `Add to ${module.name}`,
    formHTML,
    [
      {
        text: 'Cancel',
        onclick: 'Utils.closeModal()'
      },
      {
        text: itemId ? 'Update' : 'Add',
        primary: true,
        onclick: itemId ? 
          `saveCustomItemEdit('${moduleId}', '${itemId}')` : 
          `createCustomItem('${moduleId}')`
      }
    ]
  );
}

function createCustomItem(moduleId) {
  const module = Storage.state.customModules[moduleId];
  const item = {};
  
  module.fields.forEach(field => {
    if (field === 'createdAt') return;
    const input = document.getElementById(field);
    if (input) {
      item[field] = input.value;
    }
  });
  
  if (!item.title && !item.description) {
    Utils.showToast('Please add a title or description', 'warning');
    return;
  }
  
  if (!module.list) module.list = [];
  
  module.list.unshift({
    id: Utils.generateId(),
    createdAt: new Date().toISOString(),
    ...item
  });
  
  Storage.saveState();
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function saveCustomItemEdit(moduleId, itemId) {
  const module = Storage.state.customModules[moduleId];
  const itemIndex = module.list.findIndex(i => i.id === itemId);
  
  if (itemIndex === -1) return;
  
  module.fields.forEach(field => {
    if (field === 'createdAt') return;
    const input = document.getElementById(field);
    if (input) {
      module.list[itemIndex][field] = input.value;
    }
  });
  
  Storage.saveState();
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

function editCustomItem(moduleId, itemId) {
  showAddCustomItem(moduleId, itemId);
}

function deleteCustomItem(moduleId, itemId) {
  if (confirm('Are you sure you want to delete this item?')) {
    const module = Storage.state.customModules[moduleId];
    module.list = module.list.filter(i => i.id !== itemId);
    Storage.saveState();
    ModuleSystem.refreshModule();
  }
}

// ==================== QUICK ADD FUNCTIONALITY ====================
function showQuickAdd() {
  const formHTML = `
    <div style="display:flex;flex-direction:column;gap:16px">
      <div>
        <label>What do you want to add?</label>
        <select id="quickAddModule" style="width:100%">
          <option value="">Select module</option>
          <option value="tasks">‚úÖ Task</option>
          <option value="habits">üîÑ Habit</option>
          <option value="goals">üéØ Goal</option>
          <option value="finances">üí∞ Transaction</option>
          <option value="journal">üìì Journal Entry</option>
          <option value="notes">üìù Note</option>
        </select>
      </div>
      <div id="quickAddFields">
        <p class="muted" style="text-align:center">Select a module to continue</p>
      </div>
    </div>
  `;
  
  Utils.showModal(
    'Quick Add',
    formHTML,
    [
      {
        text: 'Cancel',
        onclick: 'Utils.closeModal()'
      },
      {
        text: 'Add',
        primary: true,
        onclick: 'processQuickAdd()'
      }
    ]
  );
  
  // Add change listener for module selection
  document.getElementById('quickAddModule').addEventListener('change', function() {
    const module = this.value;
    const fieldsDiv = document.getElementById('quickAddFields');
    
    if (!module) {
      fieldsDiv.innerHTML = '<p class="muted" style="text-align:center">Select a module to continue</p>';
      return;
    }
    
    let fields = '';
    
    switch(module) {
      case 'tasks':
        fields = `
          <div>
            <input type="text" id="quickTaskTitle" placeholder="Task title" style="width:100%">
          </div>
          <div class="row">
            <div style="flex:1">
              <select id="quickTaskPriority" style="width:100%">
                <option value="low">Low Priority</option>
                <option value="medium" selected>Medium Priority</option>
                <option value="high">High Priority</option>
              </select>
            </div>
          </div>
        `;
        break;
        
      case 'habits':
        fields = `
          <div>
            <input type="text" id="quickHabitName" placeholder="Habit name" style="width:100%">
          </div>
          <div>
            <select id="quickHabitCategory" style="width:100%">
              <option value="Health">Health</option>
              <option value="Productivity">Productivity</option>
              <option value="Learning">Learning</option>
              <option value="Other">Other</option>
            </select>
          </div>
        `;
        break;
        
      case 'goals':
        fields = `
          <div>
            <input type="text" id="quickGoalTitle" placeholder="Goal title" style="width:100%">
          </div>
          <div>
            <select id="quickGoalCategory" style="width:100%">
              <option value="Health">Health</option>
              <option value="Career">Career</option>
              <option value="Personal">Personal</option>
              <option value="Financial">Financial</option>
            </select>
          </div>
        `;
        break;
        
      case 'finances':
        fields = `
          <div class="row">
            <div style="flex:1">
              <select id="quickFinanceType" style="width:100%">
                <option value="income">Income</option>
                <option value="expense">Expense</option>
              </select>
            </div>
            <div style="flex:1">
              <input type="number" id="quickFinanceAmount" placeholder="Amount" min="0" step="0.01" style="width:100%">
            </div>
          </div>
          <div>
            <input type="text" id="quickFinanceDescription" placeholder="Description" style="width:100%">
          </div>
        `;
        break;
        
      case 'journal':
        fields = `
          <div>
            <textarea id="quickJournalContent" placeholder="How was your day?" 
                     style="width:100%;min-height:100px"></textarea>
          </div>
          <div>
            <select id="quickJournalMood" style="width:100%">
              <option value="">Select mood</option>
              <option value="Great">üòä Great</option>
              <option value="Good">üôÇ Good</option>
              <option value="Neutral">üòê Neutral</option>
              <option value="Bad">üòî Bad</option>
              <option value="Awful">üòû Awful</option>
            </select>
          </div>
        `;
        break;
        
      case 'notes':
        fields = `
          <div>
            <textarea id="quickNoteContent" placeholder="Your note..." 
                     style="width:100%;min-height:100px"></textarea>
          </div>
        `;
        break;
    }
    
    fieldsDiv.innerHTML = fields;
  });
}

function processQuickAdd() {
  const module = document.getElementById('quickAddModule').value;
  
  if (!module) {
    Utils.showToast('Please select a module', 'warning');
    return;
  }
  
  switch(module) {
    case 'tasks':
      const taskTitle = document.getElementById('quickTaskTitle').value;
      if (!taskTitle) {
        Utils.showToast('Please enter a task title', 'warning');
        return;
      }
      Storage.addItem('tasks', {
        title: taskTitle,
        priority: document.getElementById('quickTaskPriority').value,
        category: 'Quick Add'
      });
      break;
      
    case 'habits':
      const habitName = document.getElementById('quickHabitName').value;
      if (!habitName) {
        Utils.showToast('Please enter a habit name', 'warning');
        return;
      }
      Storage.addItem('habits', {
        name: habitName,
        category: document.getElementById('quickHabitCategory').value,
        frequency: 'Daily',
        icon: 'üîÑ'
      });
      break;
      
    case 'goals':
      const goalTitle = document.getElementById('quickGoalTitle').value;
      if (!goalTitle) {
        Utils.showToast('Please enter a goal title', 'warning');
        return;
      }
      Storage.addItem('goals', {
        title: goalTitle,
        category: document.getElementById('quickGoalCategory').value,
        progress: 0
      });
      break;
      
    case 'finances':
      const amount = parseFloat(document.getElementById('quickFinanceAmount').value);
      const description = document.getElementById('quickFinanceDescription').value;
      if (!amount || amount <= 0) {
        Utils.showToast('Please enter a valid amount', 'warning');
        return;
      }
      if (!description) {
        Utils.showToast('Please enter a description', 'warning');
        return;
      }
      Storage.addItem('finances', {
        type: document.getElementById('quickFinanceType').value,
        amount,
        description,
        category: 'Quick Add'
      });
      break;
      
    case 'journal':
      const content = document.getElementById('quickJournalContent').value;
      if (!content) {
        Utils.showToast('Please write something', 'warning');
        return;
      }
      Storage.addItem('journal', {
        content,
        mood: document.getElementById('quickJournalMood').value || 'Neutral',
        title: 'Quick Entry'
      });
      break;
      
    case 'notes':
      const noteContent = document.getElementById('quickNoteContent').value;
      if (!noteContent) {
        Utils.showToast('Please write something', 'warning');
        return;
      }
      Storage.addItem('notes', {
        content: noteContent,
        title: 'Quick Note'
      });
      break;
  }
  
  Utils.closeModal();
  ModuleSystem.refreshModule();
}

// ==================== SETTINGS FUNCTIONALITY ====================
function showSettings() {
  const settings = Storage.state.settings;
  
  const formHTML = `
    <div style="display:flex;flex-direction:column;gap:20px">
      <div class="settings-group">
        <h4 style="margin:0 0 16px 0">Appearance</h4>
        <div class="settings-item">
          <span>Theme</span>
          <select id="settingTheme" style="width:120px">
            <option value="light" ${settings.theme === 'light' ? 'selected' : ''}>Light</option>
            <option value="dark" ${settings.theme === 'dark' ? 'selected' : ''}>Dark</option>
            <option value="auto">Auto (System)</option>
          </select>
        </div>
        <div class="settings-item">
          <span>Week starts on Monday</span>
          <label class="toggle-switch">
            <input type="checkbox" id="settingWeekStartMonday" ${settings.weekStartsMonday ? 'checked' : ''}>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      
      <div class="settings-group">
        <h4 style="margin:0 0 16px 0">Behavior</h4>
        <div class="settings-item">
          <span>Auto-save</span>
          <label class="toggle-switch">
            <input type="checkbox" id="settingAutoSave" ${settings.autoSave !== false ? 'checked' : ''}>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-item">
          <span>Notifications</span>
          <label class="toggle-switch">
            <input type="checkbox" id="settingNotifications" ${settings.notifications !== false ? 'checked' : ''}>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      
      <div class="settings-group">
        <h4 style="margin:0 0 16px 0">Data Management</h4>
        <div class="settings-item">
          <span>Export all data</span>
          <button class="small" onclick="exportData()">Export JSON</button>
        </div>
        <div class="settings-item">
          <span>Import data</span>
          <input type="file" id="importDataFile" accept=".json" style="width:150px" onchange="importData(this)">
        </div>
        <div class="settings-item">
          <span>Clear all data</span>
          <button class="small btn-danger" onclick="clearAllData()">Clear All</button>
        </div>
      </div>
      
      <div class="settings-group">
        <h4 style="margin:0 0 16px 0">About</h4>
        <div class="settings-item">
          <span>Version</span>
          <span class="muted">${CONFIG.VERSION}</span>
        </div>
        <div class="settings-item">
          <span>Storage used</span>
          <span id="storageUsed" class="muted">Calculating...</span>
        </div>
      </div>
    </div>
  `;
  
  Utils.showModal(
    'Settings',
    formHTML,
    [
      {
        text: 'Cancel',
        onclick: 'Utils.closeModal()'
      },
      {
        text: 'Save',
        primary: true,
        onclick: 'saveSettings()'
      }
    ]
  );
  
  // Calculate storage usage
  const storageUsedEl = document.getElementById('storageUsed');
  if (storageUsedEl) {
    try {
      const data = localStorage.getItem(CONFIG.STORAGE_KEY);
      const bytes = data ? new Blob([data]).size : 0;
      const kb = (bytes / 1024).toFixed(2);
      storageUsedEl.textContent = `${kb} KB`;
    } catch (e) {
      storageUsedEl.textContent = 'Unknown';
    }
  }
}

function saveSettings() {
  const settings = {
    theme: document.getElementById('settingTheme').value,
    autoSave: document.getElementById('settingAutoSave').checked,
    notifications: document.getElementById('settingNotifications').checked,
    weekStartsMonday: document.getElementById('settingWeekStartMonday').checked
  };
  
  // Apply theme
  if (settings.theme === 'auto') {
    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  } else {
    document.documentElement.setAttribute('data-theme', settings.theme);
    localStorage.setItem('lifeledger_theme', settings.theme);
  }
  
  // Update theme icon
  const themeIcon = document.getElementById('themeIcon');
  if (themeIcon) {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    themeIcon.textContent = currentTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  }
  
  Storage.state.settings = settings;
  Storage.saveState();
  Utils.showToast('Settings saved', 'success');
  Utils.closeModal();
}

function exportData() {
  const dataStr = JSON.stringify(Storage.state, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = `lifeledger-backup-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  Utils.showToast('Data exported successfully', 'success');
}

function importData(input) {
  const file = input.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.version && data.modules) {
        if (confirm('Importing data will overwrite your current data. Continue?')) {
          Storage.state = data;
          Storage.saveState();
          ModuleSystem.refreshModule();
          Utils.showToast('Data imported successfully', 'success');
          location.reload();
        }
      } else {
        Utils.showToast('Invalid data format', 'danger');
      }
    } catch (err) {
      Utils.showToast('Failed to parse file', 'danger');
    }
  };
  reader.readAsText(file);
  
  // Reset input
  input.value = '';
}

function clearAllData() {
  if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
    localStorage.removeItem(CONFIG.STORAGE_KEY);
    Utils.showToast('All data cleared', 'warning');
    setTimeout(() => location.reload(), 1000);
  }
}

// ==================== KEYBOARD SHORTCUTS ====================
function setupKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    // Ctrl+Q for quick add
    if ((e.ctrlKey || e.metaKey) && e.key === 'q') {
      e.preventDefault();
      showQuickAdd();
    }
    
    // / to focus search
    if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
      const searchInput = document.getElementById('globalSearch');
      if (searchInput && document.activeElement !== searchInput) {
        e.preventDefault();
        searchInput.focus();
      }
    }
    
    // Escape to close modal
    if (e.key === 'Escape') {
      Utils.closeModal();
    }
    
    // 1-9 for modules
    if (e.key >= '1' && e.key <= '9' && !e.ctrlKey && !e.metaKey) {
      const moduleIndex = parseInt(e.key) - 1;
      const modules = Storage.state.enabledOrder || [];
      if (modules[moduleIndex]) {
        ModuleSystem.openModule(modules[moduleIndex]);
      }
    }
  });
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
  console.log('LifeLedger starting...');
  
  // Initialize storage and module system
  Storage.loadState();
  ModuleSystem.init();
  
  // Set up event listeners
  document.getElementById('dashboardBtn').onclick = () => ModuleSystem.openModule('dashboard');
  document.getElementById('quickAdd').onclick = showQuickAdd;
  document.getElementById('quickAddFAB').onclick = showQuickAdd;
  document.getElementById('settingsBtn').onclick = showSettings;
  
  // TODAY'S SUMMARY FEATURE
  document.getElementById('todayChip').onclick = showTodaysSummary;
  
  // ADD MODULE FEATURE
  document.getElementById('addModuleBtn').onclick = showAddModuleForm;
  
  // Theme toggle
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.onclick = () => {
      const current = document.documentElement.getAttribute('data-theme');
      const newTheme = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('lifeledger_theme', newTheme);
      
      const themeIcon = document.getElementById('themeIcon');
      if (themeIcon) {
        themeIcon.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
      }
      
      // Update settings if they exist
      if (Storage.state.settings) {
        Storage.state.settings.theme = newTheme;
        Storage.saveState();
      }
    };
  }
  
  // Quick start buttons
  document.getElementById('quickStartGoals')?.addEventListener('click', () => ModuleSystem.openModule('goals'));
  document.getElementById('quickStartHabits')?.addEventListener('click', () => ModuleSystem.openModule('habits'));
  document.getElementById('quickStartTasks')?.addEventListener('click', () => ModuleSystem.openModule('tasks'));
  
  // Other buttons
  document.getElementById('getStartedBtn')?.addEventListener('click', () => {
    Utils.showModal('Get Started', `
      <div style="display:flex;flex-direction:column;gap:16px">
        <h3 style="margin:0">Welcome to LifeLedger!</h3>
        <p>Here's how to get started:</p>
        <ol style="padding-left:20px;margin:0">
          <li><strong>Explore modules</strong> - Click on different modules in the sidebar</li>
          <li><strong>Add your first item</strong> - Use the "+ Add" buttons in each module</li>
          <li><strong>Use Quick Add</strong> - Click the ‚ö° button or press Ctrl+Q</li>
          <li><strong>Check your dashboard</strong> - See your progress and stats</li>
          <li><strong>Customize settings</strong> - Click the ‚öôÔ∏è button in the sidebar</li>
        </ol>
        <p style="margin-top:16px">All data is stored locally in your browser.</p>
      </div>
    `, [{ text: 'Got it!', primary: true, onclick: 'Utils.closeModal()' }]);
  });
  
  document.getElementById('shortcutsBtn')?.addEventListener('click', () => {
    Utils.showModal('Keyboard Shortcuts', `
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="settings-item">
          <span><strong>Ctrl+Q</strong></span>
          <span>Quick Add</span>
        </div>
        <div class="settings-item">
          <span><strong>/</strong></span>
          <span>Focus search</span>
        </div>
        <div class="settings-item">
          <span><strong>1-9</strong></span>
          <span>Switch to module (1=first module)</span>
        </div>
        <div class="settings-item">
          <span><strong>Esc</strong></span>
          <span>Close modal</span>
        </div>
        <div class="settings-item">
          <span><strong>Enter</strong></span>
          <span>Save form</span>
        </div>
      </div>
    `, [{ text: 'Close', primary: true, onclick: 'Utils.closeModal()' }]);
  });
  
  document.getElementById('viewAllActivity')?.addEventListener('click', () => {
    ModuleSystem.openModule('dashboard');
  });
  
  // Search functionality
  const searchInput = document.getElementById('globalSearch');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      if (query.length >= 2) {
        // Search across all modules
        const results = [];
        Object.keys(Storage.state.modules).forEach(moduleId => {
          const module = Storage.state.modules[moduleId];
          if (moduleId === 'journal') {
            if (module.entries) {
              module.entries.forEach(item => {
                const text = JSON.stringify(item).toLowerCase();
                if (text.includes(query)) {
                  results.push({ module: moduleId, item });
                }
              });
            }
          } else if (module.list) {
            module.list.forEach(item => {
              const text = JSON.stringify(item).toLowerCase();
              if (text.includes(query)) {
                results.push({ module: moduleId, item });
              }
            });
          }
        });
        
        // Search custom modules
        if (Storage.state.customModules) {
          Object.keys(Storage.state.customModules).forEach(moduleId => {
            const module = Storage.state.customModules[moduleId];
            if (module.list) {
              module.list.forEach(item => {
                const text = JSON.stringify(item).toLowerCase();
                if (text.includes(query)) {
                  results.push({ module: moduleId, item });
                }
              });
            }
          });
        }
        
        if (results.length > 0) {
          Utils.showModal(`Search Results (${results.length})`, `
            <div style="max-height:400px;overflow-y:auto">
              <div class="list">
                ${results.slice(0, 20).map(result => {
                  const moduleName = ModuleSystem.modules[result.module]?.name || result.module;
                  const title = result.item.title || result.item.name || result.item.description || 'Item';
                  return `
                    <div class="list-item" style="cursor:pointer" 
                         onclick="ModuleSystem.openModule('${result.module}'); Utils.closeModal()">
                      <div style="display:flex;align-items:center;gap:12px">
                        <div style="width:40px;height:40px;border-radius:50%;background:var(--glass);display:grid;place-items:center">
                          ${ModuleSystem.modules[result.module]?.icon || 'üìù'}
                        </div>
                        <div>
                          <div style="font-weight:600">${title}</div>
                          <div class="muted" style="font-size:13px">
                            Found in ${moduleName}
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `, [{ text: 'Close', onclick: 'Utils.closeModal()' }]);
        }
      }
    });
  }
  
  // Initialize theme
  const savedTheme = localStorage.getItem('lifeledger_theme') || Storage.state.settings?.theme || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  const themeIcon = document.getElementById('themeIcon');
  if (themeIcon) {
    themeIcon.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  }
  
  // Set up keyboard shortcuts
  setupKeyboardShortcuts();
  
  // Hide loading
  setTimeout(() => {
    const loadingEl = document.getElementById('loading');
    if (loadingEl) {
      loadingEl.style.display = 'none';
    }
  }, 500);
  
  console.log('LifeLedger ready!');
});

// Expose to global scope
window.ModuleSystem = ModuleSystem;
window.Utils = Utils;
window.Storage = Storage;
</script>
</body>
</html>
